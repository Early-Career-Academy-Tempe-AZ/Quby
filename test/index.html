<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

    	<title>Quby Test Rig</title>

    	<style type="text/css">
            h1, h2, h3, h4, h5, a, div,
            input, html, body {
                font-family: Segoe UI, Segoe WP, Helvetica Neue, Roboto, sans-serif; 
                font-weight: 100;
            }
    	    html, body {
                padding: 0;
                margin : 0;
    	    }
            body {
                background: #23232a;
                color: #fff;

                font-size: 21px;

                padding: 0 18px;
            }
            .line-numbers,
            textarea {
                font-family: consolas;
                font-size: 14px;

                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
            }
            textarea {
                width: 100%;

                padding: 3px;

                background: #1a1a1a;
                color: #dee;
                border: 1px solid #111;

                -webkit-border-radius: 2px;
                -moz-border-radius: 2px;
                border-radius: 2px;
            }
            h1 {
                margin:     9px 0 6px 0;
                padding:    0 0 0 3px;
    	    	font-size:  50px;
                font-weight: 100;
            }
    	    h2 {
                margin:      9px 0 3px 0;
                padding:     0 0 0 3px;
    	    	font-size:   36px;
                font-weight: 100;
    	    }
            .left .line-numbers,
            .left .codeBox {
                float: left;
                clear: none;
            }
            .right .line-numbers,
            .right .codeBox {
                float: right;
                clear: none;
            }
            .line-numbers,
            .codeBox {
                height:     520px;
            }

            #controls {
                width: 100%;
                float: left;
                clear: both;

                background: #ffffff; /* Old browsers */
                background: -moz-linear-gradient(top,  #ffffff 0, #ededed 100%); /* FF3.6+ */
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0,#ffffff), color-stop(100%,#ededed)); /* Chrome,Safari4+ */
                background: -webkit-linear-gradient(top,  #ffffff 0,#ededed 100%); /* Chrome10+,Safari5.1+ */
                background: -o-linear-gradient(top,  #ffffff 0,#ededed 100%); /* Opera 11.10+ */
                background: -ms-linear-gradient(top,  #ffffff 0,#ededed 100%); /* IE10+ */
                background: linear-gradient(to bottom,  #ffffff 0,#ededed 100%); /* W3C */

                border-bottom: 1px solid #aaa;

                color: black;

                -webkit-box-shadow: 0 8px 12px rgba( 0, 0, 0, 0.3 );
                -moz-box-shadow: 0 8px 12px rgba( 0, 0, 0, 0.3 );
                box-shadow: 0 8px 12px rgba( 0, 0, 0, 0.3 );

                padding: 18px 18px;
                margin-left: -18px;

                position: relative;
            }
                .controls-button,
                .controls-options {
                    float: left;
                }
                .controls-button {
                    border: none;
                    background: #1BA1E2;
                    color: #fff;

                    text-align: center;
                    font-size  : 32px;
                    font-weight: 100;
                    text-transform: lowercase;

                    padding: 0 0 9px 0;
                    margin-right: 12px;
                    width : 120px;
                    height: 90px;

                    -moz-opacity: 0.75;
                    opacity: 0.75;

                    cursor: pointer;
                }
                .controls-button:hover {
                    -moz-opacity: 1;
                    opacity: 1;
                }
                .button-parse {
                }
                .controls-options {
                    padding: 0 0 0 9px;
                }
                    .controls-options > label {
                        font-size: 21px;
                    }
                .controls-time-info {
                    float: right; 
                    clear: right;
                    text-align: right;
                    font-size : 18px;
                    margin-top: -9px;
                }
    		
    	    .line-numbers {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                min-width: 40px;

                padding: 4px 9px;

    	    	text-align: right;
                border: 1px solid transparent;

    	    	overflow: hidden;

                color: #555;
    	    }
            .code-wrap {
                width: 100%;
                position: relative;
            }
            .codeBox {
                padding-left: 48px;

                -webkit-border-top-left-radius: 0;
                -moz-border-top-left-radius: 0;
                border-top-left-radius: 0;

                -webkit-border-bottom-left-radius: 0;
                -moz-border-bottom-left-radius: 0;
                border-bottom-left-radius: 0;

                border-left: none;
                width: 100%;
            }
    		.left,
                .right,
    		.left_70,
                .right_30 {
                    position: relative;

                    -webkit-box-sizing: border-box;
                    -moz-box-sizing: border-box;
                    box-sizing: border-box;
    		}
    		.left,
                .right {
                    width:   50%;
                }
                .left_70,
    		.left {
                    float:      left;
                    clear:      left;
                    padding-right: 5px;
    		}
                .right_30,
    		.right {
                    float:      right;
                    clear:      right;
                    padding-left: 5px;
    		}
                .left_70 {
                    width: 70%;
                }
                .right_30 {
                    width: 30%;
                }
    		
    		#sourceCode {
    		}
    		
    		#outputCode {
    		}
    		
    		#outputError,
    		#outputSymbols {
                    height: 320px;

                    font-size: 18px;
                    font-weight: 100;

                    padding: 6px 12px;
                }
    		#outputError {
                color: #c63;

                z-index: 1;

                -webkit-transition: width 200ms linear, color 200ms linear;
                -moz-transition: width 200ms linear, color 200ms linear;
                -o-transition: width 200ms linear, color 200ms linear;
                transition: width 200ms linear, color 200ms linear;

                position: absolute;
                width: 100%;
    		}
            /*
             * This makes it also cover the symbols section.
             */
    		#outputError.error {
                width: 143%;
                color: #f42;
            }

            .footer {
                width: 100%;
                text-align: center;
                color: #888;
                float: left;
                clear: both;
                font-size: 18px;
                margin: 32px 0 24px 0;
            }
        </style>
    </head>
    
    <body>
        <script>
            var scriptsLoading = 0,
                scriptsLoadFun = null;

            var scriptLoad = function( inc ) {
                if ( typeof inc === 'number' ) {
                    scriptsLoading += inc;

                    if ( scriptsLoading === 0 && scriptsLoadFun ) {
                        scriptsLoadFun();
                    }
                } else if ( inc instanceof Function ) {
                    scriptsLoadFun = inc;
                } else {
                    console.log( inc );
                    throw new Error( "unknown parameter given " + inc );
                }
            }

            /**
             * Performs a document.write to inject the script given.
             * 
             * This is used because it adds on a timestamp,
             * to prevent caching.
             */
            var addScripts = function( prefix, libs, type ) {
                var time = Date.now();
                
                if ( typeof libs === 'string' || (libs instanceof String ) ) {
                    libs = [ libs ];
                }

                // ensure it ends with a slash
                if ( prefix !== '' && prefix.charAt(prefix.length-1) !== '/' ) {
                    prefix += '/';
                }

                // generate the script tags to insert, then insert them
                for ( var i = 0; i < libs.length; i++ ) {
                    (function(prefix, lib, type) {
                        scriptLoad( 1 );

                        var ajaxObj = new XMLHttpRequest();

                        ajaxObj.onreadystatechange = function() {
                            if ( ajaxObj.readyState === 4 ) {
                                var err    = undefined,
                                    status = ajaxObj.status;

                                // ERROR!
                                if ( ! (status >= 200 && status < 300 || status === 304) ) {
                                    console.error([
                                            '-----------------------',
                                            '  error ' + lib,
                                            '-----------------------',
                                            '',
                                            ajaxObj.responseText,
                                            ''
                                    ].join("\n"))

                                    scriptLoad( -1 );

                                // SUCCESS!
                                } else {
                                    var scriptTag = document.createElement( 'script' );
                                    scriptTag.innerHTML = ajaxObj.responseText;

                                    if ( type ) {
                                        scriptTag.setAttribute( 'type', type );
                                    }

                                    setTimeout( function() {
                                        scriptLoad( -1 );
                                    }, 0 );

                                    document.head.appendChild( scriptTag );
                                }
                            }
                        }

                        ajaxObj.open( 'GET', prefix + lib + '?' + time, true );

                        ajaxObj.send( '' );
                    })( prefix, libs[i], type );
                }
            }
            
            // pulls a compiled version from somewhere
            if (true) {
                addScripts('.', 'compile' );
            // builds within the browser using typescript
            } else {
                // this never worked, TS seemed to just crash. I think it's an old version.
                // this also will not work with the new ajaxy loading of scripts.

                /*
                addScripts('./..', ['quby.ts'], 'text/typescript');
                addScripts('.', [
                        'typescript.js',
                        'typescript.compile.js'
                ]);
                */
            }
        </script>
        <script>//<![CDATA[
            var includeCore = false;
            var isAdmin = true;
            var debugMode = true;
            
            function switchDebugMode() {
                debugMode = !debugMode;
            }

            function switchIncludeCore() {
                includeCore = !includeCore;
            }
            
            function switchIsAdmin() {
                isAdmin = !isAdmin;
            }
                
            function setCheckbox( id, checked ) {
                document.getElementById( id ).checked = checked;
            }
            
            function getSourceFile(url) {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.overrideMimeType( 'text/plain' );
                xmlhttp.open("GET", url, false);
                xmlhttp.send();

                return xmlhttp.responseText;
            }
                
            var _result = null;

            function handleError( err ) {
                var outputError = document.getElementById("outputError")

                if ( err instanceof Error ) {
                    var strErr = [
                            err.message,
                            err.stack
                    ].join("\n");

                    outputError.classList.add( 'error' );
                    outputError.value = strErr;
                    console.error( strErr );
                    console.log( err.stack );
                } else {
                    outputError.classList.remove( 'error' );
                    outputError.value = err;
                }
            }
        
            function parseCode( callback ) {
                setTimeout(function() {
                    try {
                        var sourceCode = document.getElementById("sourceCode"),
                            outputCode = document.getElementById("outputCode"),
                            outputError = document.getElementById("outputError"),
                            outputSymbols = document.getElementById("outputSymbols");

                        outputSymbols.value = '';

                        var parser = new quby.main.Parser();
                        parser.errorHandler( handleError );

                        var compileTime = 0,
                            symbolsTime = 0,
                            rulesTime = 0,
                            totalTime = 0;

                        var updateControlsTime = function() {
                            document.getElementsByClassName('controls-time-info')[0].innerHTML =
                                    "compile " + compileTime + "ms<br/>" +
                                    "symbols " + symbolsTime + "ms<br/>" +
                                    "rules " + rulesTime + "ms<br/>" +
                                    "total " + totalTime + "ms";
                        };

                        if (includeCore) {
                            var core = getSourceFile("./core.qb");

                            parser.
                                    parse(core).
                                    adminMode(true).
                                    onDebug(function(symbols, times) {
                                        compileTime += times.compile;
                                        symbolsTime += times.symbols;
                                        rulesTime += times.rules;
                                        totalTime += times.total;

                                        updateControlsTime();
                                    });
                        }

                        if (debugMode) {
                            parser.
                                    parse(sourceCode.value).
                                    adminMode(isAdmin).
                                    onDebug(function(symbols, times) {
                                        var displaySymbols = new Array(symbols.length);

                                        for (var i = 0; i < symbols.length; i++) {
                                            displaySymbols[i] = symbols[i].name();
                                        }

                                        outputSymbols.value = displaySymbols.join("\n");

                                        compileTime += times.compile;
                                        symbolsTime += times.symbols;
                                        rulesTime += times.rules;
                                        totalTime += times.total;

                                        updateControlsTime();
                                    });
                        } else {
                            parser.
                                    parse(sourceCode.value).
                                    adminMode(isAdmin);
                        }

                        parser.
                                finalize(function(result) {
                                    outputCode.value = result.getCode();
                                    handleError(
                                            ( outputError.value = result.hasErrors() ?
                                                    result.errors.map(function(e) { return e.message }).join("\r\n") + "\r\n" :
                                                    '' )
                                    );

                                    _result = result;

                                    if (callback) {
                                        callback();
                                    }
                                });
                    } catch ( err ) {
                        handleError( err );
                    }
                });
            }

            function runCode() {
                if ( _result == null ) {
                    parseCode()
                } else {
                    _result.run();
                }
            }
        //]]></script>

        <div id="controls">
            <input class="controls-button button-parse" type="button" value="Parse" onclick="parseCode();" />
            <input class="controls-button button-run" type="button" value="Run" onclick="runCode();" />

            <form method="post" action="." onsubmit="return false;">
                <div class="controls-options">
                    <label>include core.qb</label>
                    <input id="checkbox_include" type="checkbox" value="include" onclick="switchIncludeCore();" />

                    <br />
                    <label>debug mode</label>
                    <input id="checkbox_debug" type="checkbox" value="include" onclick="switchDebugMode();" />
                    
                    <br />
                    <label>parse as admin</label>
                    <input id="checkbox_is_admin" type="checkbox" value="is_admin" onclick="switchIsAdmin();" />
                </div>
            </form>

            <div class="controls-time-info"></div>
            
            <script>
                setCheckbox( 'checkbox_include' , includeCore );
                setCheckbox( 'checkbox_debug'   , debugMode   );
                setCheckbox( 'checkbox_is_admin', isAdmin     );
            </script>
        </div>

        <div class="left">
            <h2>in Quby</h2>

            <div class="code-wrap">
                <div class="line-numbers"></div>
                <textarea spellcheck="false" class="codeBox" id="sourceCode" name="sourceCode"></textarea>
            </div>
        </div>
        
        <div class="right">
    	    <h2>out JavaScript</h2>

            <div class="code-wrap">
                <textarea spellcheck="false" class="codeBox" id="outputCode" name="outputCode"></textarea>
                <div class="line-numbers"></div>
            </div>
        </div>

        <div class="left_70">
            <h2>compilation errors</h2>
            <textarea id="outputError" name="outputError"></textarea>
        </div>
        <div class="right_30">
            <h2>symbols</h2>
            <textarea spellcheck="false" id="outputSymbols" name="outputSymbols"></textarea>
        </div>

        <div class="footer">
            Quby copyright PlayMyCode 2012
        </div>
        
        <!-- Clear error and code gen text areas -->
        <script type="text/javascript">
            document.getElementById('outputCode').value = '';
            document.getElementById('outputError').value = '';
        </script>
        
        <script id="example_code" type="quby">//<![CDATA[
            a = #typeof 2 + 3
        //]]></script>

        <!-- Out example script code -->
        <script id="example_code_" type="quby">//<![CDATA[
/*     Space Snake Galaxies
 *
 * 
 */
 
// size constants
$WIDTH  = getScreenWidth()
$HEIGHT = getScreenHeight()
$MULT_WIDTH  = $WIDTH / 800.0
$MULT_HEIGHT = $HEIGHT / 600.0
$HYPOT  = ( $WIDTH*$WIDTH + $HEIGHT*$HEIGHT ).sqrt()
$HALF_WIDTH  = $WIDTH/2
$HALF_HEIGHT = $HEIGHT/2

// maths constants
    $TAO = 6.28318530717958647692528676655900577
     $PI = 3.14159265358979323846264338327950288
$HALF_PI = 90.toRadians()

$PI2         = $TAO
$PID2        = $HALF_PI
$PI_SQR      = 9.86960440108935861883449099987615114
$PI_4        =  4.0 / $PI
$PI_4_3      =  3.0 * $PI_4
$PI_SQR_4    = -4.0 / $PI_SQR

$SECOND = 1000

$BACK_COL = 100

// these relate to altering the random-ness when drawing
$RANDOM_DRAW_MAX = 300.0
$RANDOM_DRAW_MIN = 3.0
$RANDOM_DRAW_INC = 8.0
$RANDOM_DRAW_DIFF = $RANDOM_DRAW_MAX - $RANDOM_DRAW_MIN

$LOGO = new VectorImage( [
5, 72, 15, 72, 15, 72, 22, 70, 23, 68, 26, 61, 26, 61, 26, 50, 26, 50, 20, 42, 20, 42, 14, 40, 14, 40, 13, 18, 13, 18, 5, 18, 5, 18, 6, 70, 13, 64, 13, 51, 13, 51, 17, 51, 17, 51, 19, 56, 19, 56, 17, 63, 17, 63, 14, 64, 33, 71, 38, 71, 38, 71, 39, 25, 39, 25, 49, 24, 49, 24, 49, 18, 49, 18, 32, 18, 32, 18, 33, 71, 52, 18, 60, 72, 60, 72, 68, 72, 68, 72, 77, 18, 77, 18, 71, 18, 71, 18, 67, 28, 67, 28, 61, 28, 61, 28, 58, 17, 58, 17, 53, 18, 62, 36, 68, 37, 68, 37, 64, 55, 64, 55, 61, 37, 79, 71, 85, 71, 85, 71, 90, 55, 90, 55, 95, 71, 95, 71, 102, 72, 102, 72, 94, 43, 94, 43, 94, 18, 94, 18, 88, 18, 88, 18, 87, 40, 87, 40, 80, 70, 119, 71, 127, 71, 127, 71, 133, 46, 133, 46, 139, 72, 139, 72, 147, 72, 147, 72, 147, 19, 147, 19, 141, 18, 141, 18, 141, 54, 141, 54, 134, 18, 134, 18, 132, 19, 132, 19, 126, 53, 126, 53, 124, 19, 124, 19, 119, 19, 119, 19, 118, 71, 152, 71, 158, 72, 158, 72, 165, 54, 165, 54, 170, 72, 170, 72, 175, 72, 175, 72, 167, 42, 167, 42, 167, 19, 167, 19, 161, 19, 161, 19, 161, 41, 161, 41, 153, 71, 211, 55, 206, 55, 206, 55, 204, 64, 204, 64, 202, 66, 202, 66, 199, 63, 199, 63, 199, 28, 199, 28, 202, 24, 202, 24, 205, 27, 205, 27, 205, 35, 205, 35, 212, 35, 212, 35, 212, 26, 212, 26, 208, 19, 208, 19, 202, 17, 202, 17, 194, 20, 194, 20, 191, 28, 191, 28, 191, 63, 191, 63, 194, 69, 194, 69, 204, 72, 204, 72, 209, 69, 209, 69, 212, 63, 212, 63, 212, 55, 230, 72, 225, 72, 225, 72, 219, 67, 219, 67, 217, 57, 217, 57, 218, 27, 218, 27, 221, 20, 221, 20, 229, 18, 229, 18, 238, 23, 238, 23, 237, 63, 237, 63, 233, 71, 245, 72, 252, 72, 252, 72, 260, 71, 260, 71, 264, 64, 264, 64, 266, 30, 266, 30, 262, 22, 262, 22, 257, 17, 257, 17, 245, 18, 245, 18, 245, 71, 252, 64, 253, 26, 253, 26, 257, 28, 257, 28, 259, 44, 259, 44, 257, 61, 257, 61, 253, 64, 273, 71, 290, 72, 290, 72, 290, 66, 290, 66, 280, 65, 280, 65, 279, 51, 278, 49, 286, 49, 286, 49, 287, 41, 287, 41, 281, 41, 281, 41, 280, 26, 281, 25, 289, 25, 289, 25, 289, 19, 273, 18, 273, 71, 273, 19, 289, 18, 1, 75, 18, 76, 18, 76, 23, 74, 23, 74, 28, 70, 28, 70, 28, 76, 28, 76, 41, 76, 41, 76, 43, 29, 43, 29, 49, 29, 49, 29, 57, 75, 57, 75, 71, 75, 71, 75, 81, 22, 81, 22, 80, 14, 80, 14, 66, 14, 66, 14, 65, 23, 65, 23, 63, 23, 63, 23, 61, 14, 61, 14, 28, 14, 28, 15, 28, 43, 28, 43, 23, 38, 23, 38, 18, 36, 18, 36, 17, 12, 17, 12, 2, 13, 2, 13, 0, 74, 91, 70, 88, 76, 88, 76, 76, 76, 76, 76, 76, 69, 76, 69, 83, 39, 83, 39, 84, 15, 84, 15, 98, 14, 98, 14, 98, 40, 98, 40, 107, 68, 107, 68, 106, 75, 106, 75, 93, 76, 93, 76, 90, 71, 115, 75, 114, 14, 114, 14, 150, 15, 150, 15, 151, 61, 151, 61, 157, 40, 157, 40, 157, 15, 157, 15, 172, 14, 172, 14, 172, 41, 172, 41, 180, 68, 180, 68, 180, 75, 180, 75, 166, 76, 166, 76, 164, 70, 164, 70, 161, 75, 161, 75, 136, 76, 136, 76, 133, 66, 133, 66, 129, 75, 129, 75, 115, 75, 214, 70, 210, 74, 210, 74, 202, 76, 202, 76, 192, 74, 192, 74, 188, 69, 188, 69, 188, 25, 188, 24, 190, 18, 190, 18, 196, 14, 196, 14, 206, 13, 206, 13, 210, 16, 210, 16, 215, 21, 215, 21, 219, 16, 219, 16, 226, 13, 226, 13, 235, 15, 235, 15, 238, 17, 238, 17, 240, 20, 240, 20, 242, 14, 242, 14, 257, 14, 257, 14, 263, 16, 263, 16, 267, 21, 267, 21, 268, 25, 268, 25, 269, 14, 269, 14, 293, 14, 293, 14, 294, 28, 294, 28, 284, 30, 284, 30, 284, 37, 284, 37, 290, 38, 290, 38, 290, 52, 290, 52, 283, 53, 283, 53, 284, 61, 284, 61, 294, 62, 294, 62, 294, 76, 294, 76, 269, 75, 269, 75, 268, 65, 268, 65, 265, 72, 265, 72, 257, 75, 257, 75, 241, 75, 241, 75, 241, 69, 241, 69, 236, 74, 236, 74, 228, 76, 228, 76, 219, 75, 219, 75, 216, 69, 227, 65, 225, 63, 225, 63, 225, 28, 225, 28, 227, 25, 227, 25, 230, 27, 230, 27, 230, 60, 230, 60, 228, 65, 214, 50, 202, 50, 202, 49, 203, 40, 213, 40, 212, 50, 214, 40, 202, 40, 129, 15, 129, 15, 139, 16, 139, 16, 3, 13, 16, 1, 16, 1, 29, 1, 29, 1, 30, 12, 28, 13, 42, 0, 42, 0, 76, 0, 76, 0, 75, 5, 75, 5, 81, 0, 81, 0, 94, 1, 94, 1, 94, 4, 94, 4, 99, 0, 99, 0, 111, 0, 111, 0, 111, 27, 111, 27, 114, 34, 107, 74, 114, 66, 43, 75, 54, 63, 180, 74, 188, 67, 116, 14, 131, 1, 131, 1, 164, 1, 164, 1, 164, 7, 164, 7, 173, 1, 173, 1, 184, 0, 184, 0, 185, 25, 185, 25, 189, 34, 196, 13, 205, 3, 205, 3, 211, 0, 211, 0, 221, 0, 221, 0, 225, 3, 225, 3, 228, 6, 228, 6, 231, 4, 231, 4, 237, 0, 237, 0, 245, 1, 245, 1, 252, 3, 252, 3, 257, 0, 257, 0, 271, 0, 271, 0, 275, 2, 275, 2, 278, 4, 278, 4, 283, 1, 284, 1, 306, 1, 306, 1, 306, 14, 306, 14, 299, 23, 299, 23, 303, 24, 303, 24, 303, 37, 303, 37, 297, 44, 297, 44, 297, 47, 297, 47, 306, 47, 306, 47, 306, 63, 306, 63, 294, 72
] ).flip()

// ### Game States ###
class PreGame
    def new(user)
        @user = user
        @logo = $LOGO.resize( 1.5 )
        @state = :start
        @time = null
    end
    
    def update( game,delta )
        if @time == null && game.fade() == null
            @time = getTime() + $SECOND*3
        end
        
        c = getControls()
        if (
                ( @time != null && @time < getTime() ) ||
                ( c.isLeftClick() || c.isRightClick() )
        )
            game.fade( :out ) do
                game.game( new TitleScreen(@user) )
                game.mouse().show()
            end
        end
    end

    def draw(g)
        @logo.draw( g,getScreenWidth()/2,getScreenHeight()/2 - 60,true )
    end
end

class Renderer
    def new()
        @actors = []
    end

    def add( index,actor )
        as = @actors[ index ]
        
        if as == null
            @actors[ index ] = [ actor ]
        else
            as.push( actor )
        end
    end
    
    def remove( other )
        @actors.each() do |as|
            if as != null
                as.eachIndex() do |i|
                    if as[i] == other
                        as.remove( i )
                    end
                end
            end
        end
    end

    def each()
        @actors.each() do |as|
            if as != null
                as.each() do |actor|
                    yield actor
                end
            end
        end
    end
    
    def update( game,delta )
        each() { |actor| actor.update(game,delta) }
    end
    
    def draw( g )
        each() { |actor| actor.draw(g) }
    end
end

// ### Title ###
class TitleScreen
    def new(user)
        @renderer = new Renderer()
        @renderer.add( 0,new TitleBackground() )
        @renderer.add( 1,new TitleText(user.isLoggedIn()) )
        
        @controlsTitle = $TEXT.newImage( "Controls",32 )
        @controlsText = $TEXT.newImage(
            "Turn Left\n    A key or Left Arrow Key\n    or the Left Mouse Button" +
            "\n\n" +
            "Turn Right\n    D key or Right Arrow Key\n    or the Right Mouse Button",
            14 )
        @instructions = new Pane($WIDTH/2,$HEIGHT/2,480,270) do |g,pane|
            x = pane.getX()
            y = pane.getY()
            @controlsTitle.draw( g,x,y-100,true )
            @controlsText.draw( g,x,y+155,true )
        end
        
        @buttons = [
                new Button( new VectorImage([19,42,16,12,17,43,36,34,36,34,20,28,44,43,44,13,44,13,60,14,65,12,76,43,76,43,90,12,84,26,69,22,91,43,102,26,102,26,113,42,101,27,102,13,21,56,0,44,0,44,1,11,1,12,18,0,18,0,108,2,108,2,127,10,127,11,125,42,125,42,108,55,108,55,20,55]).flip(),$WIDTH/2,$HEIGHT/2+45) do
                    $GAME.galaxy()
                end,
                new Button( new VectorImage([40,32,24,37,24,37,15,18,15,18,27,9,27,9,41,17,63,38,48,30,48,30,53,10,53,10,71,16,63,37,72,17,81,10,84,38,84,38,100,10,100,10,104,38,110,38,132,36,122,37,120,9,137,10,141,37,141,37,160,34,160,32,140,24,147,25,161,10,185,38,168,30,168,30,175,10,175,10,193,15,193,15,185,36,201,38,203,9,203,9,220,11,245,40,227,32,226,33,247,19,247,19,227,10,22,45,2,35,1,34,0,16,0,15,19,1,239,3,22,0,259,14,240,2,258,18,259,37,257,39,240,50,236,50,24,45]).flip(),$WIDTH/2,$HEIGHT/2+108 ) do
                    @instructions.setPaint( true )
                end
        ]
    end
    
    def update( game,delta )
        @renderer.update( this,delta )
        
        handled = false
        if @instructions.update( this,delta,handled )
            handled = true
        end
        @buttons.each() do |button|
            if button.update( this, delta, handled )
                handled = true
            end
        end
        
        if !handled
            c = getControls()
            if c.isLeftClick() && @instructions.isPaint()
                @instructions.setPaint( false )
            end
        end
    end

    def draw( g )
        @renderer.draw( g )
        @buttons.each() do |button|
            button.draw( g )
        end
        @instructions.draw( g )
    end
end

class Pane
    def new( x,y,width,height,&draw )
        @x = x
        @y = y
        @width = width
        @height = height
        
        @onDraw = draw
            
        @fadeTime = null
        @paint = false
        @nextPaint = false
    end
    
    def getX()
        return @x
    end
    def getY()
        return @y
    end
    def getWidth()
        return @width
    end
    def getHeight()
        return @height
    end

    def isPaint()
        return @paint
    end
    
    def setPaint( nextPaint )
        if nextPaint != @nextPaint
            if nextPaint
                @paint = true
            end
            
            @nextPaint = nextPaint
            if @fadeTime != null && !@fadeTime.isPastDuration()
                @fadeTime = @fadeTime.getInverse()
            else
                @fadeTime = new Timer2()
            end
        end
    end
    
    def update( parent,delta,handled )
        if @fadeTime != null && @fadeTime.isPastDuration()
            if !@nextPaint
                @paint = false
            end
            @fadeTime = null
        end
        
        if @paint && @nextPaint && !handled
            c = getControls()
            return (
                    c.isLeftClick() &&
                    isRectOverlap( c.getMouseX(),c.getMouseY(),1,1,
                            @x,@y,@width,@height,true )
            )
        else
            return false
        end
    end
    
    def draw( g )
        if @paint
            originalRandomness = g.getRandomDraw()
            x = @x
            y = @y
    
            width = @width
            height = @height
    
            if ( @fadeTime != null )
                duration = @fadeTime.getPercentDuration()
    
                if ( @nextPaint )
                    alpha = duration*0.8
                    drawRandomness = 1.0 - duration
                else
                    alpha = (1.0-duration) * 0.8
                    drawRandomness = duration
                end
            else
                alpha = 0.8
                drawRandomness = 0.0
            end
            drawRandomness = drawRandomness.max( originalRandomness )
    
            // BACKGROUND
            origAlpha = getAlpha()
            g.setRandomDraw( drawRandomness )
            setColor( 0.0,0.0,0.0,origAlpha*alpha )
            g.fillRandomRect( x-width/2,y-height/2,width,height )
            
            // OUTLINE
            setColor( 255,255,255,getAlpha() )
            g.drawRandomRect( x,y,width,height,true )
    
            // CONTENTS
            if @onDraw != null
                @onDraw.call( [g,this] )
            end
    
            // RESET for the next actor
            setAlpha( origAlpha )
            g.setRandomDraw( originalRandomness )
        end
    end
end    

$MIN_X = 1
$MAX_X = $WIDTH - $MIN_X

$MIN_Y = 50
$MAX_Y = $HEIGHT - $MIN_Y

$DRAW_COLOR = 0.3*255
$NUM_SNAKES = 4
$SNAKE_ADD_POINTS = 50

class TitleBackground
    def new()
        @snakes = []
        $NUM_SNAKES.times() do
            snake = new Snake( this,rand($TAO),false )
            snake.start( rand($MIN_X,$MAX_X),rand($MIN_Y,$MAX_Y) )
            snake.addPoints( $SNAKE_ADD_POINTS )
            
            @snakes.push( new SnakeUpdate(snake) )
        end
    end
    
    def update( parent,delta )
        @snakes.each() do |sUpdate|
            sUpdate.update( this,delta )
        end
    end

    def eachIntersectingFood( snake )
        // do nothing
    end

    def eachGravityPoint()
        // do nothing
    end

    def draw( g )
        setColor( $DRAW_COLOR,$DRAW_COLOR,$DRAW_COLOR,
                getAlpha() )
        @snakes.each() do |s|
            s.draw( g )
        end
        setColor( 255,255,255,getAlpha() )
    end
end

$MIN_TURNING_TIME = 50
$MAX_TURNING_TIME = 300
$MIN_WAITING_TIME = 100
$MAX_WAITING_TIME = 1500

class SnakeUpdate
    def new(snake)
        @snake = snake
        
        setTurning( randBoolean() )
    end

    def setTurning(isTurning)
        @isTurning = isTurning
        now = getTime()
        
        if isTurning
            @timeout = now + rand( $MIN_TURNING_TIME,$MAX_TURNING_TIME )
            @isTurnLeft = randBoolean()
        else
            @timeout = now + rand( $MIN_WAITING_TIME,$MAX_WAITING_TIME )
        end
    end

    def update( parent,delta )
        if ( @timeout < getTime() )
            setTurning( !@isTurning )
        else if ( @isTurning )
            if ( @isTurnLeft )
                @snake.turnLeft( delta )
            else
                @snake.turnRight( delta )
            end
        end
        
        @snake.update( parent,delta )
    end
    
    def draw( g )
        @snake.draw( g )
    end
end

class TitleText
    def new( isLoggedIn )
        @title = new VectorImage( [
                51,107,0,75,0,75,48,38,48,38,1,15,77,78,63,0,80,78,109,53,109,53,75,30,143,84,166,25,142,82,118,19,127,38,157,49,209,60,185,68,185,68,171,45,171,45,183,22,183,22,208,30,259,27,222,21,222,21,224,69,224,69,258,76,260,53,224,43,323,100,275,74,275,74,325,36,325,36,272,21,338,21,341,69,342,66,375,29,375,29,372,70,389,26,414,74,414,74,429,21,421,48,399,43,443,80,447,21,446,43,476,75,450,47,480,21,529,79,492,67,492,67,494,24,494,24,537,32,492,44,534,49
        ] ).flip()
        @galaxies = new VectorImage( [
                57,53,19,68,19,68,0,24,0,24,32,0,32,0,58,12,58,12,52,38,37,32,60,36,72,3,97,55,96,54,116,3,104,28,82,22,126,71,132,3,149,1,168,54,168,54,187,2,176,29,160,25,202,51,238,3,200,4,237,52,252,49,256,4,250,2,263,6,259,53,246,46,274,4,308,8,275,5,271,46,271,46,308,51,311,30,275,22,356,52,323,38,323,38,361,17,359,18,325,2
        ] ).flip()
        
        if !isLoggedIn
            @login = $TEXT.newImage( 'Login to PlayMyCode to save',18 )
        else
            @login = null
        end
    end
    
    // todo
    def update( parent,delta )
        // do nothing
    end
    
    def draw( g )
        x = getScreenWidth()/2
        y = getScreenHeight()*0.25
        @title.draw( g,x,y,true )
        @galaxies.draw( g,x,y+65,true )
        if @login != null
            a = getAlpha()
            setMultAlpha( 0.7 )
// todo
//            @login.draw(g,5,getScreenHeight()-@login.getHeight()-5,false)
            setAlpha( a )
        end
    end
end

class Button
    def new( img,x ,y, isVisible, &onPress )
        init( img, x, y, isVisible, onPress )
    end
    
    def new( img,x ,y,&onPress )
        init( img, x, y, true, onPress )
    end
    
    def new( img,&onPress )
        init( img, 0, 0, true, onPress )
    end
    
    def init( img, x, y, isVisible, onPress )
        @img = img
        @x = x
        @y = y
        
        @onPress = onPress
        @paint = isVisible
        @nextPaint = isVisible

        @fadeTime = null

        @click = false
        @highlight = false
    end
    
    def getX()
        return @x
    end

    def getY()
        return @y
    end
    
    def setLocation( x,y )
        @x = x
        @y = y
    end
    
    def update( parent,delta,handled )
        return update( parent,delta,handled,0,0 )
    end
    
    def update( parent,delta,handled,offsetX,offsetY )
        if @fadeTime != null && @fadeTime.isPastDuration()
            if !@nextPaint
                @paint = false
            end
            @fadeTime = null
        end
        
        if @paint
            c = getControls()
            
            @click = false
            @highlight = isRectOverlap(
                    c.getMouseX()-offsetX,c.getMouseY()-offsetY,
                    1,1,
                    @x,@y,
                    @img.getWidth(),@img.getHeight(),
                    true
            )
            
            if (
                    !handled &&
                    @nextPaint &&
                    @onPress != null &&
                    c.isLeftClick() &&
                    @highlight
            )
                @onPress.call( [this,parent,delta] )
                @click = true
                return true
            else
                return false
            end
        else
            return false
        end
    end
    
    def setPaint( nextPaint )
        if nextPaint != @nextPaint
            if nextPaint
                @paint = true
            end
            
            @nextPaint = nextPaint
            if @fadeTime != null && !@fadeTime.isPastDuration()
                @fadeTime = @fadeTime.getInverse()
            else
                @fadeTime = new Timer2()
            end
        end
    end
    
    def draw( gfx )
        this.draw( gfx,0,0 )
    end
    
    def draw( gfx,offsetX,offsetY )
        if @paint
            getColors() do |r,g,b,a|
                if @fadeTime != null
                    origA = a
                    originalRandomness = gfx.getRandomDraw()
                    duration = @fadeTime.getPercentDuration()
    
                    if ( @nextPaint )
                        a = duration*0.8
                        drawRandomness = 1.0 - duration
                    else
                        a = (1.0-duration) * 0.8
                        drawRandomness = duration
                    end
                    
                    drawRandomness = drawRandomness.max( originalRandomness )
                    gfx.setRandomDraw( drawRandomness )
                end
                
                if @click
                    setColor( r*0.55,g*0.55,b*0.55,a )
                else if @highlight
                    setColor( r*0.78,g*0.78,b*0.78,a )
                end
                
                @img.draw( gfx, @x+offsetX, @y+offsetY, true )
                
                if @fadeTime != null
                    setColor( r,g,b,origA )
                    gfx.setRandomDraw( originalRandomness )
                else if @click || @highlight
                    setColor( r,g,b,a )
                end
            end
        end
    end
end

// ### Game ###
$SIZE_MULTIPLYER = 1000000
$MAX_WIDTH  = $WIDTH*$SIZE_MULTIPLYER
$MAX_HEIGHT = $HEIGHT*$SIZE_MULTIPLYER

$START_ANGLE = 123.toRadians()

$SNAKE_SPEED = 1.1
$SNAKE_DRIFT = 0.1
$SNAKE_TURN_SPEED = 4.0.toRadians()

$NUMBER_HEAD_COLLISION_CHECK_POINTS = 9
$COLLISION_START_CHECKS_POINT = 12

$SNAKE_COLL_CHECK_POINT = 3

$MINIMUM_POINTS = 20
$MINIMUM_DRAW_POINTS = 15

def mod(val,mod)
    val = val.round()
    
    if val < 0
        return (mod - ((-val) % mod)) % mod
    else
        return val % mod
    end
end

def fastSin(theta)
    if theta > 360
        return fastSin( theta - $TAO )
    else if theta < 0
        return fastSin( -theta + $PI )
    else if theta > $PI
        return - fastSin( theta-$PI )
    else
        return $PI_4 * theta + $PI_SQR_4 * theta * theta
    end
end

def setArrXY( arr,index,x1,y1,x2,y2 )
    row = arr[index]
    
    row[0] = x1
    row[1] = y1
    row[2] = x2
    row[3] = y2
end

class Point
    def new()
        @x = 0
        @y = 0
    end
    
    def new( x,y )
        @x = x
        @y = y
    end
    
    def getX()
        return @x
    end
    
    def getY()
        return @y
    end
    
    def set( x,y )
        @x = x
        @y = y
    end
    
    def reset()
        @x = 0
        @y = 0
    end
    
    def move( moveX,moveY )
        @x = @x+moveX
        @y = @y+moveY
    end
end

$COLL_IMG_WIDTH = $WIDTH
$COLL_IMG_HEIGHT = $HEIGHT
$lastCollImgNumRange = -1 // invalid
$currentCollImg = null

def getCollImg( num )
    range = (num / 5.0).floor()
console( 'n: ' + num + ', r: ' + range + ', m: ' + (num % 5) )
    if range == $lastCollImgNumRange
        return $currentCollImg
    else
        $lastCollImgNumRange = range
        $currentCollImg = null
console( 'num: ' + num + ', ' + (num < 15) )
        if num < 5
console( 'range: 0 ' )
            $currentCollImg = new Image( 'collision_map_5.png' )
        elseif num < 10
console( 'range: 1 ' )
            $currentCollImg = new Image( 'collision_map_10.png' )
        elseif num < 15
console( 'range: 2 ' )
            $currentCollImg = new Image( 'collision_map_15.png' )
        elseif num < 20
console( 'range: 3 ' )
            $currentCollImg = new Image( 'collision_map_20.png' )
        else
            error( 'unknown collision number: ' + num )
        end
        
        return $currentCollImg
    end
end

class LevelCollMap
    def new( num )
        @img = null
        @num = num
    end
    
    def getValue( x,y )
        if @img == null
            @img = getCollImg( @num )
        end
        
        return @img.getPixelRed(
                (x + $COLL_IMG_WIDTH*(@num % 5)).round(), y.round()
        )
    end

    def clear()
        @img = null
    end
    
    def draw()
        drawImage( @img,
                $COLL_IMG_WIDTH*@num, 0,
                $COLL_IMG_WIDTH, $COLL_IMG_HEIGHT,
                0,0,
                $WIDTH,$HEIGHT )
    end
end

$NUM_LEVELS = 20
$MAX_LEVEL_LOCK = $NUM_LEVELS*2.0
$LEVEL_LOCK_THRESHOLD = 2.0
$LEVEL_UNLOCKING = 1.0

// the number of levels already unlocked
$UNLOCKED_OFFSET = 2

$NUM_HIGHSCORES = 10
$COLLISION_COLOR = 200

class LevelFactory
    def new()
        @levels = [
            new Level( 400,300,"Empty Space",0,
                    new VectorImage( [] ),
                    new VectorImage( [66,84,60,76,58,74,62,70,62,70,72,76,70,76,64,82,92,42,92,36,92,36,88,32,88,32,82,30,82,30,92,28,92,28,94,20,94,20,94,28,94,28,102,32,102,32,92,36,28,20,22,12,22,12,14,16,14,16,16,6,16,6,20,4,20,4,22,0,22,0,26,6,26,6,30,16,26,102,22,100,22,100,24,92,26,102,26,92,14,64,10,62,8,62,14,60,52,52,56,46,56,46,50,48,50,52,48,48,6,42,0,36] ),
                    1000,1500,10000,
                    new GameColors(
                            1,1,1,
                            0,0,0,
                            0.6,1,0.6
                    ),
                    []
            ),
            new Level( 460,350,"Sol",1,
                    new VectorImage( [394,585,344,581,344,581,294,573,294,573,242,559,242,559,178,533,178,533,126,501,126,501,80,459,80,459,46,413,46,413,24,361,24,361,14,295,14,295,26,233,26,231,44,193,44,193,70,157,70,157,104,121,104,121,150,87,150,87,208,55,208,55,252,41,252,41,306,27,306,27,398,19,398,19,508,31,508,31,568,47,568,47,602,61,602,61,660,95,660,95,720,149,720,149,756,197,756,197,782,275,782,275,782,327,782,327,770,377,770,377,736,439,736,439,686,489,686,489,618,535,618,535,546,563,546,563,464,581,464,581,394,585,408,347,390,345,390,345,374,339,374,339,362,331,362,331,354,315,354,315,354,303,354,303,360,291,360,291,376,281,376,281,398,275,398,275,420,277,420,277,438,287,438,287,450,301,450,301,452,315,452,315,440,333,440,333,426,343,426,343,406,347] ),
                    new VectorImage( [30,48,21,43,21,43,17,34,17,34,19,24,19,24,29,18,29,18,42,22,42,22,48,32,48,32,44,42,43,43,39,46,39,46,29,49,39,63,24,59,24,59,9,51,9,51,0,37,0,37,1,25,1,25,10,16,10,16,23,8,23,8,38,6,38,6,51,5,51,5,58,6,58,6,59,11,59,11,65,17,65,17,74,17,74,17,76,12,76,12,74,4,74,4,67,0,67,0,60,4,76,11,86,17,87,18,95,29,95,29,94,41,94,41,87,51,87,51,76,57,76,57,61,62,61,62,41,63] ),
                    1000,1500,10000,
                    new GameColors(
                            0,0.666,1,
                            0,0,0.3,
                            0.4,1,0.4
                    ),
                    [ new GravityPoint(400,300,1.25,200) ]
            ),
            new Level( 600,400,"Inside Out",2,
                    new VectorImage( [399,600,393,562,393,562,379,520,379,520,357,482,357,482,333,450,333,450,307,424,307,424,275,400,275,400,241,378,241,378,199,358,199,358,163,344,163,344,121,332,121,332,71,324,71,324,35,320,35,320,1,320,1,282,29,282,29,282,67,278,67,278,101,274,101,274,135,266,135,266,173,256,173,256,209,242,209,242,241,228,243,228,277,208,277,208,309,186,309,186,337,160,337,160,359,134,361,132,377,104,379,104,393,68,393,68,401,34,401,34,401,6,433,600,435,568,435,568,445,530,445,530,459,498,459,498,479,468,479,468,501,442,501,442,523,420,523,420,555,396,555,396,595,372,595,372,629,358,629,358,665,344,665,344,703,334,703,334,737,326,739,326,771,322,771,322,797,320,799,280,771,278,771,280,739,274,739,274,699,268,699,268,661,256,661,256,625,244,625,244,591,230,591,230,561,212,561,212,529,190,529,190,505,168,505,168,485,146,485,146,465,122,465,122,449,92,449,92,439,60,439,60,433,24,433,24,433,4] ),
                    new VectorImage( [34,52,20,48,20,48,0,48,0,48,24,46,24,46,36,44,36,44,22,28,22,28,38,38,38,38,40,20,40,20,42,0,42,0,44,20,44,20,50,38,50,38,62,28,62,28,50,44,50,44,58,46,58,46,82,48,82,48,60,50,60,50,50,52,50,52,64,68,64,68,48,56,48,56,44,66,44,66,42,84,40,64,42,80,40,62,36,56,36,56,22,66,22,66,32,52,40,48,32,48,42,52,42,58,42,48,52,48,42,42,42,32] ),
                    1000,5000,10000,
                    new GameColors(
                            0.0,0.0,0.0,
                            1.0,1.0,1.0,
                            0.65,0.3,0.65
                    ),
                    []
            ),
            new Level( 110,160,"Wormholes",3,
                    new VectorImage( [205,524,203,598,203,524,165,504,165,504,123,474,123,474,1,476,3,396,61,396,61,396,45,368,45,368,35,328,35,328,35,280,35,280,45,236,45,236,63,196,63,196,89,160,89,160,117,134,119,132,151,108,151,108,203,78,203,78,205,8,293,6,295,46,295,46,339,38,339,38,423,38,425,38,475,40,475,40,519,50,523,52,569,66,569,66,619,88,619,88,677,126,677,126,717,164,717,164,751,220,751,220,767,270,767,270,767,328,767,328,745,394,743,398,797,398,797,476,679,476,679,476,655,492,655,492,603,524,603,524,551,544,551,544,483,560,483,560,417,566,417,566,351,564,351,564,293,554,293,554,293,598,213,308,212,289,212,289,219,266,219,266,233,243,233,243,260,219,260,219,296,199,296,199,352,184,352,184,399,178,399,178,457,184,457,184,506,199,506,199,538,216,538,216,567,242,567,242,585,271,585,271,589,302,589,302,585,328,585,328,570,353,570,353,543,379,543,379,507,399,507,399,461,414,461,414,409,421,409,421,338,414,338,414,280,394,280,394,246,370,246,370,224,343,224,343,212,308] ),
                    new VectorImage( [90,66,74,64,74,64,56,48,56,48,52,30,52,30,34,32,52,36,40,34,40,34,34,32,52,40,36,40,36,40,18,38,18,38,0,32,0,32,16,26,16,26,48,24,48,24,110,24,110,24,150,26,150,26,170,32,170,32,150,38,150,38,122,40,140,34,124,36,140,34,112,28,112,28,52,30,124,32,122,42,122,44,116,58,116,58,90,66,122,22,114,10,114,10,98,0,98,0,78,0,78,0,62,8,62,8,52,22] ),
                    1000,5000,10000,
                    new GameColors(
                            0.9,0.9,0.0,
                            0.3,0.0,0.0,
                            1.0,0.3,0.0
                    ),
                    []
            ),
            new Level( 10,165,"Curved",4,
                    new VectorImage( [378,477,334,469,334,469,286,449,286,449,250,423,250,423,220,391,220,391,204,365,204,365,194,335,194,335,154,345,154,345,164,379,164,379,186,417,186,417,222,455,222,455,270,489,270,489,318,507,318,507,378,521,378,521,378,477,448,475,446,517,446,517,492,509,492,509,542,489,542,489,584,463,584,463,624,425,622,425,650,377,650,377,658,351,658,349,614,349,614,349,598,385,598,385,562,425,562,425,516,453,516,453,484,465,484,465,448,475,382,165,344,187,344,187,326,169,326,169,296,157,296,157,268,151,268,151,234,151,234,151,200,157,200,157,172,171,172,171,152,191,152,191,148,211,148,211,160,231,160,231,180,245,180,245,202,253,202,253,218,257,218,257,168,285,168,285,144,273,144,273,124,253,124,253,108,227,108,227,104,195,104,195,120,161,120,161,152,131,152,131,188,117,188,117,228,109,228,109,270,109,270,109,314,119,314,119,344,131,342,131,364,145,364,145,380,165,444,141,478,147,478,147,520,163,520,163,550,183,550,183,576,205,574,203,602,237,602,237,618,277,618,277,660,279,660,279,654,249,654,249,642,217,642,217,620,185,620,185,588,153,588,153,550,129,550,129,512,113,512,113,476,103,476,103,442,141,500,377,494,381,494,381,490,395,490,395,502,409,502,409,512,405,512,405,520,397,520,397,516,381,516,381,508,375,510,375,500,377,377,389,418,386,418,386,413,366,413,366,417,338,417,338,432,315,432,315,453,300,453,300,473,295,473,295,499,296,499,296,514,303,514,303,525,311,525,311,545,274,545,274,527,262,527,262,490,253,490,253,464,254,464,254,441,260,441,260,418,271,418,271,395,293,395,293,379,319,379,319,371,348,371,348,373,369,372,371,376,388,127,441,133,484,133,484,118,495,118,495,101,512,101,512,88,533,88,533,82,555,82,555,41,560,41,560,43,537,43,537,54,511,54,511,67,486,67,486,92,462,92,462,114,447,114,447,128,440,754,235,727,230,727,230,729,207,729,207,728,168,728,168,716,130,716,130,701,109,701,109,687,103,687,103,676,107,676,107,667,116,667,116,657,133,657,133,642,82,642,82,651,66,651,66,665,53,665,53,682,45,682,45,699,45,699,45,712,54,712,54,726,70,726,70,740,98,740,98,750,134,750,134,755,164,755,164,757,194,757,194,757,220,757,220,755,236] ),
                    new VectorImage( [32,32,24,34,24,34,16,40,16,40,18,48,18,48,28,52,28,52,42,48,42,48,44,42,42,34,46,40,42,32,32,32,44,38,36,38,36,38,24,42,24,42,18,48,24,12,16,16,16,16,10,22,10,22,6,32,6,32,10,34,10,34,16,34,16,34,26,30,26,34,20,16,22,12,30,30,28,26,32,24,32,24,40,16,40,16,40,8,40,8,32,8,32,8,24,12,14,42,8,40,8,40,0,32,0,32,2,22,2,22,10,12,10,12,24,2,24,2,40,0,40,0,46,8,46,8,46,14,46,14,40,26,40,26,34,30,22,2,20,0,20,0,14,2,14,2,14,8] ),
                    1000,5000,10000,
                    new GameColors(
                            1.0,1.0,1.0,
                            0.0,0.0,0.0,
                            0.6,1.0,0.6
                    ),
                    [ new GravityPoint(505,390,-0.9,100) ]
            ),
            new Level( 450,160,"Caves",5,
                    new VectorImage( [502,407,380,411,380,411,364,379,364,379,338,351,338,351,306,333,306,333,272,319,272,319,246,313,246,313,218,309,218,309,252,239,252,239,394,195,394,195,484,277,484,277,502,277,502,277,504,407,564,279,592,275,592,275,636,273,636,273,664,271,664,271,698,267,698,267,726,257,728,257,746,227,746,227,750,203,750,203,750,117,750,117,740,77,738,75,730,63,730,63,678,51,678,51,562,51,560,51,534,55,536,57,512,67,512,67,496,79,496,79,490,107,486,113,484,125,484,125,484,163,484,163,350,117,348,115,334,93,334,93,308,71,308,71,284,61,284,61,252,61,252,61,214,67,206,69,132,93,126,97,98,113,98,115,86,133,86,133,82,159,84,157,90,187,90,187,128,273,128,273,110,335,108,335,94,343,94,343,78,353,78,353,62,371,60,375,44,399,42,399,34,427,34,427,34,457,34,457,40,483,40,483,54,507,54,507,78,533,78,533,100,549,100,549,124,561,124,561,156,573,156,573,194,577,194,577,232,577,232,577,260,571,262,571,284,565,284,565,316,549,318,549,340,533,340,533,358,515,358,515,372,493,372,493,506,491,506,491,618,537,618,537,662,551,662,551,682,555,682,555,704,555,704,555,722,549,722,549,740,537,740,535,758,515,758,515,784,479,784,479,784,471,784,471,774,465,774,465,724,457,724,457,690,449,690,449,666,441,666,441,644,427,644,427,614,397,614,397,592,367,592,367,578,331,578,331,562,279,238,445,230,441,230,441,218,431,218,431,218,421,218,421,226,413,226,413,240,407,240,407,262,411,262,411,274,421,274,421,272,437,270,435,262,443,260,445,238,447,214,67,202,71,132,93,126,97] ),
                    new VectorImage( [43,0,34,0,34,0,28,7,28,7,18,8,18,8,4,17,4,17,0,18,0,18,3,27,3,27,7,42,7,42,8,50,8,50,18,58,18,58,18,63,18,63,27,71,27,71,40,73,40,73,55,68,55,68,71,67,71,67,80,59,81,59,85,58,85,58,86,31,86,31,88,25,88,25,88,2,88,2,82,1,82,1,68,6,68,6,65,10,65,10,47,17,79,2,79,16,79,16,75,28,75,28,78,40,78,40,73,47,73,47,72,53,72,53,65,58,65,58,59,58,59,58,52,50,52,50,47,37,47,37,44,21,44,21,41,8,41,8,42,0,33,2,32,12,32,12,34,15,34,15,33,40,33,40,41,46,41,46,40,52,40,52,45,61,45,61,54,66,67,37,62,47,69,19,54,42,59,19,51,28] ),
                    1000,5000,10000,
                    new GameColors(
                            0.8,0.8,0.8,
                            0.2,0.09,0.0333,
                            0.02,0.7,0.616
                    ),
                    [ new GravityPoint(247,425,1.0,120) ]
            ),
            new Level( 420,200,"The Space Road",6,
                    new VectorImage( [387,344,371,342,371,342,349,336,349,336,331,324,331,324,323,306,323,306,325,290,325,290,339,276,339,276,365,264,365,264,391,262,391,262,417,264,415,264,437,270,437,270,453,280,451,280,463,296,463,296,461,314,461,314,451,326,451,326,433,338,433,338,413,344,413,344,387,346,223,300,153,328,153,328,1,328,223,300,169,270,171,270,1,272,1,122,797,120,797,272,645,272,645,272,585,300,583,298,645,328,645,328,797,328,797,498,1,496] ),
                    new VectorImage( [42,79,25,98,27,79,20,85,13,94,7,98,22,67,0,86,27,66,22,58,22,58,26,47,26,47,33,41,32,37,21,5,31,2,35,11,37,21,39,27,43,0,52,35,52,36,60,39,60,39,70,48,70,48,98,47,73,60,82,59,91,58,99,58,98,71,67,71,67,71,59,77,59,77,51,79,51,79,41,78,46,65,40,59,40,59,44,53,44,53,52,54,52,54,54,61,54,61,44,66] ),
                    1000,5000,10000,
                    new GameColors(
                            1.0,1.0,0,
                            0.2,0.2,0.2,
                            1.0,1.0,1.0
                    ),
                    [ new GravityPoint( 400,300,-1.5,250 ) ]
            ),
            new Level( 280,260,"Eight",7,
                    new VectorImage( [239,576,203,572,203,572,169,564,169,564,129,548,129,548,97,528,95,528,71,506,71,506,51,480,51,480,35,444,35,444,29,410,29,410,33,366,33,366,51,328,51,328,85,290,85,290,115,268,115,268,157,248,157,248,211,236,211,236,263,232,263,232,325,242,325,242,317,214,317,214,317,176,317,176,331,134,331,134,357,100,357,100,395,68,395,68,431,48,431,48,465,38,461,38,497,30,497,30,551,26,551,26,615,30,615,30,659,44,659,44,697,62,697,62,733,88,733,88,763,124,763,124,781,162,781,162,785,204,785,204,773,250,773,250,743,292,743,292,699,326,699,326,651,348,651,348,619,358,619,358,551,364,551,364,523,364,523,364,461,352,461,352,471,402,471,402,465,438,465,438,451,474,451,474,427,508,427,508,389,536,389,536,357,554,357,554,311,570,311,570,239,576,235,442,217,436,217,436,205,420,205,420,207,406,207,406,221,394,221,394,245,388,245,388,269,394,269,394,283,402,283,402,287,416,287,418,281,430,281,430,265,440,265,440,235,444,549,232,523,226,523,226,503,218,503,218,491,206,491,206,489,192,489,192,499,176,499,176,523,166,523,166,547,160,547,160,577,162,577,162,599,172,599,172,615,186,615,186,617,202,617,202,601,220,601,220,577,228,577,228,549,232] ),
                    new VectorImage( [46,0,26,2,26,2,10,14,10,14,0,34,0,34,2,56,2,56,16,76,16,76,36,86,36,86,54,84,54,84,72,76,74,74,86,52,86,52,86,26,86,26,70,8,48,0,68,6,44,12,28,18,28,18,22,34,22,34,28,50,28,50,44,58,44,58,62,52,62,52,70,32,70,32,62,18,62,18,44,12,42,22,50,22,50,22,54,28,54,28,54,32,54,32,50,34,50,34,54,36,54,36,54,44,54,44,50,46,50,46,42,46,42,46,38,42,38,42,38,36,38,36,40,34,40,34,38,32,38,32,38,26,38,26,42,22,48,26,42,26,42,26,40,30,40,30,42,32,40,32,48,32,48,32,50,30,50,30,48,26,50,42,44,42,44,42,42,40,42,40,42,38,42,38,44,36,44,36,48,36,48,36,50,40] ),
                    3500,7000,10000,
                    new GameColors(
                            0.2,1.0,0,
                            0.1,0.05,0.1,
                            0.9,0.45,0.9
                    ),
                    [
                            new GravityPoint( 245,415,1.0,220 ),
                            new GravityPoint( 555,193,1.0,220 )
                    ]
            ),
            new Level( 200,100,"Darkmatter",8,
                    new VectorImage( [283,444,261,440,261,440,245,432,245,432,231,416,231,416,233,396,233,396,251,380,251,380,277,372,277,372,307,376,307,376,329,396,329,396,327,422,327,422,309,438,309,438,283,446,331,222,309,218,309,218,295,204,295,204,285,186,285,186,291,168,291,168,311,154,311,154,347,148,347,148,375,156,375,156,393,178,393,178,393,196,393,196,379,214,379,214,357,224,357,224,331,224,505,296,489,316,489,316,491,340,491,340,505,356,505,356,527,364,527,364,553,364,553,364,577,352,577,352,589,332,589,332,587,312,587,312,571,298,571,298,551,288,551,288,519,290,519,290,505,296,588,482,581,477,581,477,576,467,576,467,580,459,580,459,589,455,590,454,599,457,599,457,605,464,605,464,605,474,605,474,600,480,600,480,589,483,503,520,491,519,491,519,475,527,475,527,470,536,470,536,477,545,477,545,494,552,494,552,511,550,511,550,524,541,524,541,523,528,522,528,516,523,516,523,503,520,332,511,321,506,321,506,318,498,318,498,319,489,319,489,330,485,330,485,341,487,341,487,348,493,348,493,348,503,348,503,340,509,340,509,332,511,220,526,210,530,210,530,208,539,208,539,216,548,215,549,226,549,226,549,233,543,233,543,232,532,232,532,228,527,228,527,221,526,117,505,128,510,128,510,128,520,128,520,121,525,121,525,110,527,110,527,102,519,102,519,101,511,101,511,107,505,107,505,116,505,149,424,142,417,142,417,140,409,140,409,148,402,148,402,157,402,157,402,164,406,164,406,165,414,165,414,161,421,161,421,154,425,154,425,147,424,148,301,138,296,138,296,137,287,137,287,140,279,140,279,151,277,151,277,160,282,160,282,161,292,161,292,157,299,157,299,149,302,147,129,151,120,151,119,142,111,142,111,134,111,133,111,128,118,128,118,127,129,127,129,138,134,138,134,147,130,272,106,263,109,263,109,252,103,252,103,249,94,249,94,255,85,255,85,267,84,267,84,277,90,277,90,277,100,277,100,273,106,386,316,378,310,378,310,372,301,372,301,377,288,377,288,390,284,390,284,402,290,402,290,407,301,407,301,402,311,402,311,394,316,394,315,386,317,454,381,445,385,445,385,442,394,442,394,451,404,451,404,463,403,463,403,468,396,468,396,467,386,467,386,460,381,460,381,453,381,501,220,491,221,491,221,482,213,482,213,483,202,483,202,492,198,492,198,502,200,502,200,508,208,508,208,507,217,507,217,501,221,724,387,716,382,716,382,712,371,712,371,721,363,721,363,732,364,732,364,738,372,738,372,739,381,739,381,733,386,733,386,725,386,685,235,674,235,674,235,665,225,665,225,668,216,668,216,680,212,680,212,690,215,690,215,695,224,695,224,692,232,692,232,684,234,589,238,583,237,583,237,575,230,575,230,578,220,578,220,587,217,587,217,596,220,596,220,599,229,599,229,595,235,595,235,587,238,547,125,536,115,536,115,536,106,536,106,544,98,544,98,554,98,565,106,556,97,564,106,565,115,565,115,559,123,559,123,547,125,711,99,719,91,719,91,719,81,719,81,709,77,709,77,700,78,700,78,694,86,694,86,698,97,698,97,711,100] ),
                    new VectorImage( [32,17,26,13,26,13,25,5,25,5,29,0,29,0,38,1,38,1,43,6,43,6,43,13,43,13,36,18,36,18,31,17,40,39,38,28,38,28,29,27,29,27,28,51,28,51,39,51,39,51,48,55,48,55,52,64,52,64,47,72,47,72,36,75,36,75,25,74,25,74,17,70,16,70,13,66,13,66,0,73,0,73,9,81,9,81,23,88,23,88,41,87,41,87,56,82,56,82,65,73,65,73,67,59,67,59,60,48,60,48,51,41,51,41,39,40] ),
                    1000,4000,9000,
                    new GameColors(
                            1.0,0.7,1.0,
                            0.15,0.0,0.5,
                            1.0,0.333,0
                    ),
                    [
                            new GravityPoint( 283,407,0.8,200 ),
                            new GravityPoint( 540,325,0.8,200 ),
                            new GravityPoint( 340,185,0.8,200 ),

                            new GravityPoint( 390,300,-0.6,200 ),
                            new GravityPoint( 456,392,-0.6,150 ),
                            new GravityPoint( 590,467,-0.6,200 ),
                            new GravityPoint( 497,535, 0.6,200 ),
                            new GravityPoint( 333,497,0.6,250 ),
                            new GravityPoint( 221,537,-0.6,175 ),
                            new GravityPoint( 115,515,0.6,200 ),
                            new GravityPoint( 153,412,0.55,200 ),
                            new GravityPoint( 150,290,-0.4,225 ),

                            new GravityPoint( 140,120,0.75,125 ),
                            new GravityPoint( 265,95,-0.6,225 ),
                            new GravityPoint( 495,210,-0.7,225 ),
                            new GravityPoint( 550,110,0.6,225 ),
                            new GravityPoint( 587,227,0.6,200 ),
                            new GravityPoint( 680,225,0.6,225 ),
                            new GravityPoint( 707,87,-0.6,225 ),
                            new GravityPoint( 725,375,0.7,175 )
                    ]
            ),
            new Level( 40,120,"Pyramids",9,
                    new VectorImage( [204,269,238,361,238,361,274,259,204,269,274,257,290,209,196,245,196,245,156,117,156,117,144,97,144,97,126,87,126,87,88,91,88,91,46,99,46,99,0,109,288,213,312,145,312,145,322,129,322,129,328,123,328,123,342,123,342,123,370,131,368,131,406,141,406,141,448,151,448,151,458,153,458,153,472,163,472,163,484,189,484,189,530,345,530,345,614,345,614,345,668,173,668,173,676,157,676,157,684,153,684,153,712,149,712,149,758,137,758,137,798,129,602,375,540,375,540,375,572,469,572,469,608,373,324,556,317,556,317,556,306,555,306,555,295,549,295,549,288,541,288,541,280,532,280,532,283,524,283,524,299,513,299,513,321,504,321,504,337,500,337,500,352,500,352,500,354,514,354,514,354,526,354,526,350,537,350,537,342,546,342,546,334,552,334,552,325,556,287,542,272,545,272,545,254,547,254,547,237,546,237,546,227,539,227,539,233,526,233,526,245,514,245,514,260,504,260,504,285,491,285,491,324,477,324,477,353,469,353,469,378,466,378,466,393,471,393,471,396,476,396,476,397,482,396,481,385,495,385,495,374,504,374,504,357,513] ),
                    new VectorImage( [0,7,14,2,14,2,26,0,26,0,37,3,37,3,53,9,53,9,68,15,68,15,83,18,83,18,95,18,95,18,101,16,76,18,42,61,42,61,37,2,15,3,41,62,34,29,39,27,29,14,23,16,46,14,65,21,58,27,39,21,44,32,59,37,47,41,56,44] ),
                    1000,4500,11000,
                    new GameColors(
                            0.405,0.131,0.035,
                            1.0,0.831,0.333,
                            0.0,0.333,1.0
                    ),
                    []
            ),
            new Level( 285,190,"Chambers",10,
                    new VectorImage( [682,566,682,598,720,600,720,566,720,566,734,562,734,562,746,552,746,552,758,538,758,538,768,520,768,520,798,520,798,480,768,480,768,480,762,464,762,464,750,450,750,450,732,436,732,436,720,432,720,432,720,366,720,366,732,362,732,362,744,354,744,354,760,338,760,338,768,320,768,320,798,320,798,280,768,280,768,280,760,264,760,262,746,246,746,246,730,236,730,236,720,232,720,232,720,168,718,166,732,162,732,162,748,148,748,148,762,132,762,132,766,120,766,120,798,120,768,80,798,82,768,82,762,68,762,68,754,52,754,54,736,40,736,40,720,32,720,32,718,4,682,6,680,34,680,34,666,40,666,40,646,56,646,56,634,80,634,80,566,80,566,80,554,56,554,56,540,40,540,40,518,34,518,4,520,32,482,4,482,32,482,32,464,40,464,40,446,56,446,56,434,80,434,80,366,80,366,80,358,62,358,62,340,42,340,42,318,32,320,32,320,6,282,6,282,32,282,32,264,40,264,40,248,54,246,56,232,80,232,80,168,82,168,82,160,62,160,62,138,42,138,42,118,32,118,32,120,6,80,6,82,32,82,32,62,40,62,40,42,60,42,60,34,80,34,80,0,80,0,120,32,120,32,120,42,136,42,136,62,156,62,156,82,166,82,166,82,232,118,232,118,166,118,166,136,160,136,160,154,144,154,144,166,120,166,120,234,120,234,120,244,140,244,140,264,158,264,158,282,168,282,168,282,234,320,234,318,166,318,166,336,160,336,160,354,144,354,144,366,120,366,120,434,120,434,120,444,140,444,140,462,158,462,158,482,166,482,166,482,232,482,232,464,240,464,240,446,256,446,256,434,280,434,280,368,280,368,280,358,260,358,260,340,242,340,242,318,232,280,232,262,242,262,242,242,264,242,264,232,282,232,282,168,280,168,280,156,258,156,258,138,240,138,240,118,234,80,232,60,244,60,244,44,260,44,260,34,280,34,280,2,282,520,166,520,232,520,232,538,242,538,242,560,262,560,262,568,280,568,280,634,280,634,280,644,260,644,260,662,240,662,240,680,232,680,232,682,168,682,168,660,156,660,156,644,140,644,140,634,120,634,120,566,120,566,120,558,138,560,138,538,158,538,158,520,166,680,566,662,558,662,558,646,544,646,544,634,520,634,520,566,520,566,520,556,540,556,540,538,558,538,558,518,566,518,566,518,600,520,432,540,442,540,442,558,460,558,460,568,480,568,480,634,478,634,478,644,458,644,458,662,440,662,440,680,432,680,432,682,368,682,368,662,358,662,358,642,338,642,338,634,320,634,320,568,320,568,320,558,338,558,338,538,358,538,360,518,366,520,434,518,364,480,366,460,354,460,354,442,338,442,338,434,322,434,322,368,318,368,318,358,338,358,338,336,360,336,360,318,366,318,366,318,432,318,432,338,442,338,442,360,466,360,466,368,480,368,480,434,482,434,482,444,460,444,460,462,442,462,442,480,432,480,432,480,366,482,600,480,566,480,566,462,558,462,558,444,540,444,540,436,520,436,520,366,520,366,520,358,540,358,540,340,556,340,556,320,568,320,568,320,600,280,600,282,568,282,568,264,560,264,560,244,540,244,540,234,520,234,520,168,520,168,520,160,534,160,534,144,554,144,554,120,566,120,566,120,598,82,598,82,566,82,566,68,562,68,562,48,544,48,544,34,522,34,522,2,520,0,482,34,482,34,482,44,460,44,460,62,442,62,442,82,432,82,432,82,368,82,368,64,358,64,358,42,338,42,338,36,320,36,320,0,320,170,320,234,322,234,322,244,342,244,342,260,358,282,368,260,358,282,368,282,434,280,434,262,442,262,442,244,458,244,460,234,480,234,480,168,482,168,482,160,462,160,462,142,442,142,442,120,434,120,434,120,366,120,366,142,356,142,356,160,336,160,336,166,320] ),
                    new VectorImage( [56,98,42,98,42,98,36,96,36,96,30,92,30,92,14,80,14,80,12,74,12,74,6,74,6,74,6,64,6,64,2,60,2,60,0,40,0,40,8,32,8,32,18,16,18,16,36,2,36,2,52,4,52,4,64,0,64,0,76,10,76,10,88,20,88,20,92,48,92,48,84,72,84,72,70,78,70,78,56,96,30,38,28,42,28,42,34,46,34,46,22,66,22,66,18,58,18,58,14,38,14,38,20,34,20,34,22,40,22,40,20,44,20,44,20,56,20,54,24,42,56,32,48,30,48,30,36,32,44,16,54,28,44,22,44,26,44,26,36,32,84,64,80,52,78,48,72,38,68,34,66,32,50,52,54,58,58,72,50,72,46,78,40,72,32,76,26,76,48,88,50,80,42,60,44,70,68,66,64,62,58,46,60,52,42,42,48,40] ),
                    1000,6000,10000,
                    new GameColors(
                            1,0,0,
                            0,0,0,
                            1,1,1
                    ),
                    []
            ),
            new Level( 545,75,"Goldfish",11,
                    new VectorImage( [566,507,608,487,608,487,650,457,650,457,684,423,684,423,714,373,714,373,732,319,732,319,732,257,732,257,718,211,718,211,692,167,692,167,656,129,656,129,614,97,614,97,552,67,552,67,492,49,492,49,438,43,438,43,390,41,390,41,330,47,330,47,274,59,274,59,218,81,218,81,166,113,166,113,112,165,112,165,78,225,78,225,68,285,68,285,74,343,74,343,100,401,100,401,142,449,142,449,184,483,184,483,234,509,234,509,234,547,234,547,242,553,242,553,558,553,558,553,566,547,566,547,566,507,582,273,568,291,568,291,548,305,546,305,522,317,522,317,498,329,498,329,468,335,466,335,406,335,406,335,370,331,370,331,350,325,350,325,340,321,340,321,314,321,314,321,290,329,290,329,254,341,254,341,230,345,230,345,208,343,208,343,208,337,208,337,236,311,236,311,244,297,244,297,234,269,234,269,228,251,228,251,228,241,228,241,244,233,244,233,276,247,276,247,308,269,308,269,332,273,332,273,350,269,350,269,376,249,376,249,416,237,416,237,452,229,452,229,506,231,506,231,536,243,536,243,552,245,552,245,570,255,570,255,578,267,576,267,582,271,558,271,554,275,554,275,554,283,554,283,560,285,560,285,562,281,562,281,562,275,562,275,556,271] ),
                    new VectorImage( [88,61,79,62,79,62,65,59,65,59,53,55,53,55,46,60,46,60,37,59,37,59,37,50,37,50,30,42,30,42,28,35,28,35,21,29,21,29,10,26,10,26,0,20,0,20,12,17,12,17,13,7,13,7,15,0,15,0,22,1,22,1,26,10,26,10,32,21,32,21,41,27,41,27,35,22,35,22,41,12,41,12,46,23,46,23,58,27,58,27,68,32,68,32,80,40,79,39,87,50,87,51,89,54,89,54,90,60,85,59,83,56,69,32,65,21,65,21,58,17,58,17,58,26,56,31,53,26,53,54,44,50,44,50,39,44,39,44,29,37,42,34,28,29,28,29,23,25,53,36,65,39,82,51,71,49,81,46,75,45] ),
                    1000,5000,10000,
                    new GameColors(
                            1,0.333,0,
                            0,0,0.2,
                            0.6,1,0.6
                    ),
                    [
                            new GravityPoint( 557,280,1.1,130 ),
                            new GravityPoint( 210,340,1.1,130 ),
                            new GravityPoint( 240,245,1.1,130 )
                    ]
            ),
            new Level( 645,155,"Mummy",12,
                    new VectorImage( [140,548,152,521,152,521,174,489,174,489,196,474,196,474,227,468,227,468,254,469,254,469,300,480,300,480,413,515,413,515,474,529,474,529,521,535,521,535,554,531,553,531,578,526,578,526,605,515,605,515,625,506,625,506,648,489,648,489,665,471,665,471,680,448,680,448,684,424,684,423,682,410,682,410,675,389,675,389,659,364,659,364,635,340,635,340,607,317,607,317,573,298,573,298,541,284,541,284,506,278,506,278,465,277,465,277,427,282,427,282,390,290,390,290,349,297,349,296,317,298,317,298,289,293,289,293,255,281,255,281,224,266,224,266,202,249,202,249,186,227,186,227,184,212,184,212,193,199,193,199,215,190,215,190,264,177,264,177,329,167,329,167,409,159,409,159,476,156,476,156,531,160,531,160,557,167,557,167,568,175,568,175,576,185,576,185,583,205,583,205,593,224,593,224,605,237,605,237,623,245,623,245,645,253,645,253,652,252,652,252,653,246,653,246,647,230,647,230,634,204,634,204,625,179,625,179,623,158,623,158,628,144,628,144,639,129,639,129,660,103,660,103,668,89,668,89,669,77,669,77,663,65,663,65,640,55,640,55,626,56,626,56,615,61,615,61,585,92,585,92,567,100,567,100,539,104,538,105,506,106,505,106,455,103,455,103,412,103,412,103,343,111,343,111,258,125,258,124,190,144,190,144,147,162,147,162,125,185,125,185,123,209,123,209,128,233,128,233,144,262,145,263,162,284,162,284,187,307,187,307,218,327,218,327,246,340,246,340,284,348,284,348,323,350,323,350,361,349,361,349,458,336,459,337,504,337,504,337,543,348,543,348,575,365,575,365,607,393,607,393,621,415,621,415,621,432,621,432,600,455,600,455,571,470,571,470,540,478,540,477,509,481,509,481,467,475,467,475,415,463,415,463,297,433,297,433,247,423,247,423,227,422,227,422,204,426,204,426,182,434,182,434,163,449,163,449,147,469,147,469,139,489,139,489,134,506,134,506,133,522,133,521,135,532,135,532,140,546,626,67,633,64,633,64,633,71,633,71,630,87,630,87,626,67,654,79,660,78,660,78,660,88,660,88,658,99,656,100,655,86,655,86,652,80,643,245,637,241,637,241,639,233,639,233,638,225,638,225,644,235,644,235,644,243,627,238,620,235,620,235,623,225,623,225,623,218,623,218,627,226,627,226,626,235,619,233,610,231,610,231,603,223,603,223,592,202,592,202,585,181,585,181,577,164,577,164,576,143,576,143,583,120,583,120,597,94,597,94,613,77,613,77,627,67,634,65,648,69,648,69,661,78,637,239,626,234,636,225,621,193,620,192,615,172,615,172,614,148,626,131,641,113,641,113,652,100,652,99,654,92] ),
                    new VectorImage( [85,1,67,0,67,0,57,2,57,2,37,10,37,10,19,11,17,10,8,14,8,14,0,26,0,26,4,39,4,39,17,60,17,60,23,61,23,61,29,72,29,72,32,84,32,84,40,91,40,91,56,92,56,92,65,91,65,91,69,85,69,85,74,76,75,74,79,68,79,68,78,60,78,60,73,54,73,54,74,60,74,60,74,66,74,66,71,72,73,75,66,69,66,69,63,60,63,60,60,52,60,52,64,40,64,40,73,30,73,30,83,18,83,18,88,20,88,20,91,12,91,12,91,6,91,6,85,2,69,77,63,73,63,73,59,73,49,71,56,57,56,57,51,52,51,52,43,53,66,89,57,86,57,86,51,80,51,80,45,67,45,67,42,57,42,57,35,44,35,44,26,29,26,29,18,21,16,17,25,14,25,14,33,14,33,14,46,9,46,9,58,3,37,19,32,23,32,23,31,27,21,19,25,21,25,21,33,30,33,30,41,39,41,39,49,43,49,43,53,45,53,52,55,45,55,45,53,35,53,35,57,42,57,42,57,48,57,48,56,55,28,60,31,63,31,63,28,66,38,85,41,83,41,83,36,80,36,80,36,84,23,62,26,60,41,36,46,31,46,31,53,28,20,33,17,27,15,36,19,39,18,44,21,45,20,51,22,52,30,46,32,49,31,53,33,54] ),
                    1000,5000,10000,
                    new GameColors(
                            0.85,0.45,1,
                            0,0.2,0,
                            0.1,0.8,0.1
                    ),
                    []
            ),
            new Level( 690,25,"Boxes",13,
                    new VectorImage( [799,576,1,576,1,22,797,22,707,126,361,124,361,124,361,154,361,154,707,154,707,154,707,126,389,168,361,168,361,168,363,456,363,456,389,456,389,456,389,168,559,306,511,306,511,306,511,242,511,242,559,242,559,242,559,306,513,328,799,328,799,384,513,384,513,384,511,328,513,406,559,406,559,406,559,436,559,436,513,436,513,436,513,408,511,456,513,476,513,476,559,478,559,476,559,458,511,456,559,456,559,492,513,494,513,494,513,512,513,512,559,514,559,514,559,494,559,532,559,560,559,560,513,560,513,560,511,532,511,534,557,532,195,390,179,390,179,390,179,124,179,122,195,124,195,124,195,390,469,80,139,80,139,80,141,70,141,70,469,68,469,68,469,80,89,328,3,330,89,328,91,386,91,386,1,386,157,458,247,458,247,458,245,514,245,514,159,512,159,512,157,460,295,208,295,248,295,248,231,248,231,248,231,208,231,208,295,206,275,290,333,288,335,288,337,332,337,332,277,330,275,292,277,330,293,368,229,368,229,368,229,410,229,410,291,410,293,410,293,370] ),
                    new VectorImage( [14,46,48,61,48,61,84,45,84,45,95,62,95,62,59,79,59,79,48,61,48,61,48,39,48,39,40,34,49,39,59,34,84,44,85,20,85,20,48,0,48,0,48,28,48,28,83,44,47,30,14,45,14,45,0,47,0,47,32,29,32,29,45,29,47,0,11,17,11,17,11,38] ),
                    1000,5000,10000,
                    new GameColors(
                            1,1,1,
                            0.561,0.29,0.129,
                            0.6,1,0.6
                    ),
                    []
            ),
            new Level( 115,100,"Rays",14,
                    new VectorImage( [186,545,328,593,328,593,782,593,782,593,782,481,782,481,722,301,722,301,740,285,740,285,754,265,754,265,770,227,770,227,774,179,774,179,760,137,760,137,734,103,734,103,704,79,704,81,670,69,670,69,640,67,640,67,608,73,608,73,576,87,576,87,560,99,560,99,544,115,544,115,348,15,348,15,12,17,12,17,12,363,12,363,54,451,54,451,34,467,34,467,18,493,18,493,20,515,18,515,28,533,28,533,46,551,46,551,74,565,74,565,100,571,100,571,128,569,128,569,154,563,154,563,184,547,206,509,204,519,204,519,350,569,350,569,358,553,358,553,364,535,364,535,366,503,366,501,206,507,358,473,200,479,200,479,194,469,194,469,176,455,176,455,158,447,158,447,182,351,182,351,246,371,246,371,300,399,300,399,336,433,336,433,360,473,116,439,106,439,106,439,94,441,94,441,50,349,50,349,80,345,80,345,122,345,122,345,142,347,142,347,116,439,318,67,520,169,520,169,516,179,516,179,516,187,516,187,296,199,296,199,296,171,296,171,300,127,300,127,318,67,306,257,524,245,524,245,534,261,534,261,552,285,552,285,582,311,582,311,546,495,546,495,482,469,482,469,430,437,430,437,396,409,396,409,368,377,368,377,338,335,338,335,320,299,306,257,320,299,638,327,652,327,652,327,668,323,668,323,730,501,730,501,692,507,692,507,648,507,648,509,602,505,602,505,636,327,674,261,654,269,654,269,620,263,620,265,604,257,604,257,586,239,586,239,576,219,576,219,572,197,572,197,576,173,576,173,590,149,590,149,612,133,612,133,644,123,644,123,674,131,674,131,698,147,698,147,714,177,714,177,716,207,716,207,706,233,706,233,692,251,692,251,672,263,112,541,94,539,94,539,78,531,78,533,62,519,62,519,60,503,60,503,64,491,64,491,72,481,72,481,90,471,90,471,116,467,116,467,142,475,142,475,162,491,162,491,164,509,164,509,158,521,158,521,142,533,142,533,128,539,128,539,112,541] ),
                    new VectorImage( [6,76,18,76,18,76,15,40,15,40,23,39,23,39,35,77,35,77,50,77,50,77,30,35,30,35,34,32,34,32,71,77,71,77,97,76,97,76,39,26,39,26,42,21,42,21,101,55,101,55,102,31,102,31,44,15,44,15,44,9,44,9,102,15,102,15,101,0,101,0,0,0,0,0,2,40,2,40,8,41,8,41,6,75] ),
                    1000,5000,10000,
                    new GameColors(
                            1,1,1,
                            0,0,0,
                            0.6,1,0.6
                    ),
                    []
            ),
            new Level( 610,155,"The Rings",15,
                    new VectorImage( [550,479,514,485,514,485,470,489,470,489,430,489,428,489,406,485,404,485,392,503,392,505,370,525,370,525,342,541,342,543,308,557,308,557,264,565,264,565,228,567,228,567,184,563,184,563,142,549,142,549,112,533,112,533,84,511,84,513,62,483,60,483,48,451,48,451,44,423,44,423,50,395,50,395,62,367,62,367,76,347,76,347,100,327,100,325,126,309,126,309,156,297,156,297,182,289,182,289,206,285,206,285,218,261,218,261,192,263,192,263,160,265,160,265,132,261,132,261,100,253,100,253,74,241,74,241,54,227,54,227,44,211,44,211,36,193,36,193,38,173,38,173,46,153,46,153,60,139,60,139,80,127,80,127,106,115,106,115,138,109,138,109,172,107,172,107,206,109,206,109,236,115,236,115,262,125,262,125,280,137,280,137,286,125,286,125,300,103,300,103,318,83,318,83,344,65,344,65,372,51,372,51,408,39,408,39,446,33,446,33,490,33,490,33,532,41,532,41,564,51,566,53,598,71,598,71,622,91,622,91,644,123,644,123,652,149,652,149,654,179,654,179,652,195,652,195,646,207,646,207,664,221,664,221,688,243,688,243,706,269,706,269,716,293,716,293,740,313,740,313,764,349,764,349,776,385,776,385,782,423,782,423,780,455,780,455,770,499,770,499,758,529,758,529,740,555,740,555,716,575,716,575,688,589,688,589,666,591,666,593,640,589,640,589,614,577,614,577,590,557,590,557,574,537,574,537,562,513,562,515,550,479,714,363,728,389,726,391,732,423,730,425,732,453,732,453,726,479,726,479,714,507,714,507,698,527,698,527,684,537,684,537,668,543,668,543,648,541,652,543,636,533,636,533,620,515,618,515,606,493,606,493,596,465,596,465,618,457,618,457,650,439,650,439,678,415,678,415,698,391,700,389,714,363,670,325,662,325,662,325,648,327,648,327,630,337,630,337,616,353,616,353,604,377,604,379,596,411,596,411,622,399,624,399,646,381,646,381,660,361,660,361,668,345,668,345,672,325,650,277,624,285,624,285,600,301,598,303,576,327,576,327,560,357,560,357,550,387,550,387,546,413,546,413,546,431,546,431,520,437,520,437,482,441,482,441,450,441,450,443,422,439,422,439,424,407,424,407,412,375,412,375,386,341,386,339,362,321,362,321,334,305,334,305,304,293,304,293,278,287,278,287,260,285,260,285,274,267,274,267,292,253,292,253,306,245,306,245,324,259,324,259,346,275,346,275,374,287,374,287,408,297,408,297,438,303,438,303,486,303,486,303,526,297,526,297,564,285,564,285,592,269,592,269,618,247,618,249,640,261,640,263,654,277,568,225,530,215,530,215,492,209,492,209,448,207,448,207,404,211,404,211,354,223,354,223,386,241,386,243,428,255,428,255,480,257,480,257,516,249,516,249,550,239,550,239,570,227,602,189,580,179,580,179,546,169,546,169,504,163,504,163,458,161,458,161,410,163,408,165,372,169,372,169,326,181,326,181,324,161,324,161,340,127,340,127,364,107,366,105,390,93,390,93,420,83,420,85,452,79,454,79,508,83,508,83,550,97,550,97,582,117,582,117,600,139,600,139,608,163,608,165,604,187,260,187,250,199,250,199,224,209,224,209,192,215,192,215,160,215,160,215,134,213,134,213,106,203,106,203,90,195,90,195,84,185,82,185,88,177,88,177,104,169,104,169,128,159,128,159,150,155,150,155,182,155,182,155,216,159,216,159,242,167,242,167,258,181,374,433,350,425,350,425,314,409,314,409,286,393,286,393,262,365,262,365,250,345,250,343,248,333,248,333,276,335,276,335,310,345,310,345,344,365,344,365,364,385,364,385,374,407,374,407,376,433,352,477,322,465,322,465,286,447,286,447,254,427,252,427,234,407,232,405,210,371,210,371,202,351,202,351,200,335,200,335,166,343,166,343,136,357,136,357,106,385,106,385,94,407,94,407,92,433,92,433,102,459,102,459,118,481,118,481,140,495,140,495,174,509,174,509,212,519,212,519,242,519,242,519,276,515,276,515,310,505,310,505,352,477] ),
                    new VectorImage( [50,38,40,42,40,42,28,43,28,43,15,41,15,41,3,35,3,35,3,28,3,28,16,22,16,22,31,21,31,21,44,24,44,24,44,29,44,29,50,37,50,37,61,40,61,40,73,39,73,39,84,35,84,35,93,25,93,25,95,18,95,18,93,11,93,11,82,8,82,8,68,10,68,10,55,17,55,17,49,23,49,23,47,31,44,22,46,14,46,14,54,8,54,8,65,2,65,2,77,0,77,0,85,0,85,0,92,4,92,4,96,8,96,8,96,17,91,13,82,25,82,25,70,30,70,30,56,31,55,31,49,26,56,29,56,23,56,23,54,18,50,10,39,7,39,7,26,7,26,7,14,8,14,8,3,12,3,12,1,17,1,17,0,23,0,23,2,31,8,25,18,28,18,28,29,29,29,29,38,28,38,28,43,28] ),
                    1000,5000,10000,
                    new GameColors(
                            1,1,1,
                            0,0,0,
                            0.6,1,0.6
                    ),
                    []
            ),
            new Level( 280,450,"Planet Flower",16,
                    new VectorImage( [181,568,192,572,192,572,211,572,211,572,234,566,234,567,245,562,245,562,259,551,259,551,270,535,270,535,273,514,273,514,272,498,272,498,261,483,261,483,247,476,247,476,232,477,232,477,212,482,212,482,195,491,195,491,175,505,175,505,161,523,161,523,161,532,161,532,167,538,167,538,173,543,174,543,176,552,176,552,175,562,175,562,181,568,83,543,76,541,76,541,59,532,59,532,41,519,41,519,36,506,36,506,34,493,34,493,37,481,37,481,33,471,33,471,35,458,35,458,38,449,38,449,52,445,52,445,75,449,75,449,97,457,97,457,118,473,118,473,127,487,127,487,126,492,126,492,120,501,120,501,118,513,118,513,120,527,120,527,114,537,114,537,99,542,99,542,82,542,371,413,360,409,360,409,343,400,343,400,328,382,328,382,315,352,315,352,314,338,314,338,331,330,331,330,339,314,339,314,346,309,346,309,358,311,358,311,384,324,384,324,412,350,412,350,423,371,423,371,422,384,422,384,414,398,414,398,397,408,397,408,383,412,383,412,371,413,264,333,276,332,276,332,284,337,284,337,289,353,289,353,287,374,287,374,278,392,278,392,261,408,261,408,248,413,248,413,239,414,239,414,221,408,221,408,212,410,212,410,198,410,198,410,189,399,189,399,187,384,187,384,197,361,197,361,208,342,208,342,227,326,227,326,241,321,241,321,248,327,248,327,262,333,120,331,99,326,99,326,79,317,79,317,68,301,68,301,68,292,68,292,74,285,74,285,92,276,92,276,135,271,135,271,178,272,178,272,206,277,206,277,213,283,213,283,214,289,214,289,220,298,220,298,216,306,216,306,190,319,190,319,152,328,152,328,119,331,355,291,405,296,405,296,447,298,447,298,477,292,477,292,491,280,492,280,493,266,493,266,486,251,486,251,473,246,473,246,449,244,449,244,425,239,425,239,411,234,411,234,389,235,389,235,362,247,362,247,341,258,341,258,341,263,341,263,347,271,347,271,347,281,356,291,348,287,348,287,347,282,248,285,256,296,256,296,275,304,275,304,295,302,295,302,314,291,314,291,315,279,315,279,310,267,310,267,292,260,292,260,266,261,266,261,251,267,251,267,247,275,247,275,248,286,198,257,162,244,162,244,132,228,132,228,112,212,112,212,110,204,110,204,111,193,111,193,121,182,121,182,143,169,143,169,161,165,161,165,179,167,179,167,206,179,206,179,228,195,228,195,252,221,252,221,250,227,250,227,235,232,235,232,225,235,225,235,219,241,218,241,216,249,216,249,209,256,209,256,198,257,332,237,342,238,342,238,365,228,365,228,384,214,384,214,392,205,392,205,398,191,398,191,398,177,398,177,387,161,387,161,363,150,363,150,334,145,334,145,318,146,318,146,304,156,304,156,292,173,292,173,281,200,281,200,283,214,283,214,291,222,291,223,302,225,302,225,316,226,316,226,330,238,264,200,262,172,262,172,262,148,262,148,265,136,265,136,257,103,257,103,243,62,243,62,230,38,230,38,226,43,226,43,253,124,253,124,254,140,254,140,252,161,252,161,255,183,255,183,258,193,258,193,263,200,478,124,498,122,498,122,509,119,509,119,531,119,531,119,545,121,545,121,559,117,559,117,580,104,580,104,604,83,604,83,604,75,604,75,598,67,597,66,595,58,595,58,590,53,590,52,576,51,576,51,531,60,531,59,500,66,500,66,470,79,470,79,458,91,458,91,454,101,454,101,460,114,460,114,471,123,471,123,478,124,672,162,657,146,657,146,645,118,645,118,641,97,641,97,645,90,645,90,655,83,655,83,662,68,662,68,667,55,667,55,680,49,680,49,703,56,703,56,719,67,719,67,735,89,735,89,736,103,736,103,731,125,731,125,717,149,717,149,700,165,700,165,687,169,687,169,677,166,677,166,671,162,600,378,596,366,596,366,592,323,592,323,591,280,591,280,596,241,596,241,603,197,603,197,608,194,608,194,609,206,609,206,607,231,607,231,603,270,603,270,601,293,601,293,603,327,603,327,603,377,610,498,601,498,601,498,589,489,589,489,581,476,581,476,581,470,581,470,594,459,594,459,609,454,609,454,629,458,629,458,642,467,642,467,643,477,643,477,635,489,635,489,623,497,623,497,611,499,504,524,515,527,515,527,531,521,531,521,555,508,556,508,566,498,566,498,565,494,565,494,556,494,556,494,535,506,535,506,503,522,482,466,497,469,497,469,549,467,549,467,562,471,562,471,564,475,564,475,554,478,554,478,505,480,505,480,490,475,490,475,480,468,509,432,511,437,511,437,523,443,523,443,566,456,566,456,571,455,571,455,570,448,570,448,545,437,545,437,527,433,527,433,517,433,517,433,511,431,592,439,586,439,586,439,571,417,571,417,568,408,568,408,571,403,571,403,579,405,579,405,588,415,588,415,596,431,596,431,593,440,626,435,622,435,622,435,618,430,618,430,619,409,619,409,626,393,626,393,634,389,634,389,638,389,638,389,639,398,639,398,627,433,655,446,681,433,681,433,708,420,708,420,713,411,713,411,709,407,709,407,694,415,694,415,677,422,677,422,659,434,659,434,651,445,651,445,655,448,734,470,713,479,713,479,691,478,691,478,674,476,674,476,664,471,664,471,669,467,669,467,687,468,687,468,702,471,702,471,720,470,720,470,734,468,656,500,668,506,668,506,674,513,674,513,685,518,685,518,670,519,670,519,654,508,654,508,652,503,652,503,657,500,614,522,621,528,621,528,619,546,619,546,612,550,612,550,608,543,608,543,609,528,609,528,613,522,588,514,589,521,589,521,576,540,576,540,568,545,568,545,562,546,562,546,565,536,565,536,575,520,575,520,583,513,583,513,589,514] ),
                    new VectorImage( [26,0,34,12,34,12,36,24,36,24,35,43,35,43,27,46,27,46,23,53,23,53,27,62,27,62,37,64,37,64,45,57,45,57,43,49,42,47,36,44,26,40,26,26,26,26,23,24,23,24,9,30,9,30,10,36,10,36,23,44,19,47,10,41,10,41,4,40,4,40,0,54,0,54,4,57,4,57,18,55,20,62,5,67,5,67,6,72,6,72,13,81,13,81,17,81,17,81,25,65,31,67,23,81,23,81,24,87,24,87,38,87,38,87,42,84,42,84,38,68,43,68,49,80,49,80,54,83,54,83,62,76,62,76,61,71,61,71,49,64,50,58,64,63,64,63,67,59,67,59,66,49,66,49,62,45,62,45,50,52,47,47,60,41,59,40,59,34,59,34,54,31,54,31,48,31,48,31,43,42] ),
                    1000,5000,10000,
                    new GameColors(
                            1,0.7,0.5,
                            54/255.0,139/255.0,54/255.0,
                            0.95,0.90,0.55
                    ),
                    []
            ),
            new Level( 455,250,"Earth Town",17,
                    new VectorImage( [168,547,77,546,77,546,78,441,78,441,169,488,169,488,168,547,240,490,42,390,42,390,439,390,439,390,239,490,401,360,350,360,350,360,350,341,350,341,401,340,401,340,401,360,355,289,356,309,356,309,305,311,305,311,304,289,304,289,354,288,351,258,402,259,402,259,402,239,402,239,349,237,349,237,348,256,311,240,311,260,311,260,260,260,260,260,258,239,258,239,309,239,356,209,306,208,306,208,303,188,303,188,354,189,354,189,355,208,351,159,403,158,403,158,402,140,402,140,349,139,349,139,349,158,311,140,310,159,310,159,258,159,258,159,259,139,259,139,310,140,220,140,220,158,220,158,170,160,170,160,169,138,169,138,218,139,214,189,266,190,266,190,266,209,266,209,213,209,213,209,213,190,175,189,176,210,176,210,126,209,126,209,123,189,123,189,174,189,131,159,130,140,130,140,78,139,78,139,78,158,78,158,129,159,1,110,797,108,757,163,755,225,755,225,711,227,711,227,703,230,703,230,696,239,696,239,686,274,685,275,644,280,644,280,514,272,514,272,501,235,501,235,494,224,494,224,483,218,483,217,467,212,467,212,463,164,463,164,481,160,481,160,495,161,495,161,497,173,497,173,506,189,506,189,522,203,522,203,541,210,541,210,560,208,560,208,578,200,578,200,589,186,589,186,594,173,594,173,596,161,596,161,632,161,632,161,633,174,633,174,641,189,641,189,652,201,652,201,671,209,671,209,692,209,692,209,707,202,707,202,718,191,718,191,728,175,728,175,731,161,731,161,757,163,700,140,707,150,707,150,709,162,709,162,705,174,705,174,695,185,695,185,678,187,678,187,661,181,661,181,652,165,652,165,653,149,653,149,665,135,665,135,682,134,683,133,700,139,572,152,563,139,563,139,547,133,547,133,529,136,529,136,518,148,518,148,518,164,518,164,525,179,525,179,540,188,540,188,557,185,557,185,569,175,569,175,575,163,575,163,573,152,169,239,220,239,220,239,221,259,221,259,170,258,170,258,169,239,129,240,132,260,132,260,81,258,81,258,79,240,79,240,129,239,124,289,174,290,174,290,176,311,176,311,123,310,123,310,122,290,215,289,264,290,264,290,266,309,266,309,214,311,214,311,214,291,258,341,310,339,310,339,311,361,311,361,261,361,261,361,259,343,220,341,170,341,170,341,168,361,168,361,220,360,220,360,219,341,131,341,131,360,131,360,79,360,79,360,80,341,80,341,130,341] ),
                    new VectorImage( [22,77,79,64,79,64,93,43,93,43,100,38,100,38,36,47,36,47,30,52,30,52,82,44,31,53,21,75,21,75,13,43,13,43,7,32,7,32,0,27,0,27,4,23,4,23,13,25,13,25,13,33,13,33,34,41,33,47,33,1,33,1,4,1,4,1,3,22,13,23,12,3,19,12,26,12,26,12,26,33,26,33,20,31,20,31,20,11,22,49,26,49,26,49,26,58,22,47,22,58,22,58,27,62,22,60,18,43,18,43,15,35,15,35,6,26,36,15,47,18,47,18,96,12,96,12,96,0,96,0,44,1,44,1,33,0,45,1,46,18,46,18,49,43,64,31,63,6,62,31,51,33,51,33,51,4,64,32,86,29,86,29,86,35,86,30,85,2,72,12,77,11,77,11,80,28,72,28,71,10,48,33,36,35] ),
                    1000,5000,10000,
                    new GameColors(
                            1,1,1,
                            0,0,0,
                            0.6,1,0.6
                    ),
                    []
            ),
            new Level( 735,300,"My Plumbing",18,
                    new VectorImage( [415,566,415,600,385,600,385,566,385,566,277,490,277,490,277,600,247,402,247,600,245,400,223,404,223,404,199,406,199,406,175,400,177,400,157,384,157,384,133,346,133,346,97,276,97,276,73,250,73,250,39,224,39,224,1,200,1,166,39,188,39,188,83,216,83,216,113,248,113,248,147,302,147,302,175,358,175,358,195,374,195,374,217,374,217,374,247,368,247,368,247,274,247,274,93,4,127,6,247,210,247,210,247,6,277,6,277,146,277,148,299,120,299,120,315,102,315,102,383,50,383,50,385,4,383,88,337,122,337,122,277,202,277,202,279,306,279,306,343,324,343,324,383,340,383,340,401,354,401,354,433,394,433,394,467,370,467,370,493,354,493,354,505,344,505,344,515,320,515,320,519,296,519,296,521,264,521,264,491,258,491,258,463,248,463,248,439,230,439,230,407,196,407,196,391,160,391,160,385,124,385,124,383,88,1,386,123,600,87,598,1,450,387,528,279,454,279,454,279,340,279,340,331,352,331,352,363,366,363,366,379,378,379,378,411,418,411,418,403,432,403,432,393,466,393,466,387,528,417,564,475,542,475,542,501,536,501,536,535,538,535,538,575,546,575,546,603,558,603,558,621,572,621,572,639,600,673,600,643,550,643,550,621,532,621,532,587,516,587,516,545,508,545,508,505,506,505,506,459,516,459,516,417,530,417,530,423,476,423,476,427,452,427,452,439,430,439,430,459,414,459,414,501,384,501,384,525,364,525,364,545,330,545,330,549,296,549,296,549,262,549,262,599,266,599,266,645,274,645,274,671,284,671,284,737,336,737,336,799,448,799,384,759,314,759,314,687,258,687,258,655,246,655,246,619,236,619,236,593,234,593,234,517,230,517,230,491,224,491,224,467,214,467,214,445,194,445,194,427,170,427,170,417,140,417,140,415,110,415,110,415,6,639,4,713,124,713,124,745,162,745,162,773,184,773,184,797,200,797,164,757,130,757,130,725,88,725,88,677,4] ),
                    new VectorImage( [64,53,53,58,53,58,35,60,35,60,17,62,17,62,3,62,3,62,0,58,0,58,1,51,1,51,18,47,18,47,31,47,31,47,49,45,49,45,57,38,38,45,43,39,43,39,43,37,43,37,58,32,58,32,64,29,64,29,69,31,69,31,77,35,77,35,80,40,80,40,76,59,76,58,83,71,83,71,87,89,87,89,81,94,81,94,74,96,74,96,70,100,70,100,60,100,60,100,55,97,55,97,53,94,53,94,46,91,46,91,45,73,45,73,51,60,51,60,64,58,64,58,74,59,60,64,61,86,53,89,52,68,70,88,68,65,74,73,76,89,72,95,65,93,65,93,59,93,76,44,72,39,72,39,65,39,61,46,49,50,49,50,35,49,17,59,17,48,25,47,24,38,24,38,15,37,15,37,3,41,3,41,3,47,16,48,16,39,49,33,50,2,69,30,69,0,65,26,60,24,65,24,59,19,65,17,60,13,64,11,59,7,64,6,59,2] ),
                    1000,5000,10000,
                    new GameColors(
                            1,1,1,
                            0.6,0,0.2,
                            0.8,0.8,0.4
                    ),
                    []
            ),
            new Level( 375,305,"My P Man",19,
                    new VectorImage( [385,586,11,586,11,586,11,416,11,416,149,410,151,412,153,340,153,340,1,342,1,296,147,294,149,296,149,228,149,228,17,224,17,224,17,124,17,124,63,120,65,106,63,122,65,106,15,104,15,104,13,10,13,10,787,10,787,10,783,108,783,108,727,106,727,106,729,124,729,124,785,126,785,126,783,218,647,223,781,219,641,293,647,223,641,295,797,295,797,339,645,343,645,343,647,413,647,413,781,419,781,419,785,587,785,587,415,585,415,585,413,521,413,521,409,515,409,515,385,517,385,517,383,585,311,547,219,547,219,547,213,543,213,543,215,519,215,519,225,515,225,515,319,513,319,513,323,519,323,519,323,539,323,541,313,547,153,543,147,547,147,547,83,549,83,549,71,541,71,541,71,519,71,519,81,513,81,513,143,511,143,511,153,517,153,517,153,541,149,473,77,473,77,473,69,465,69,465,71,457,71,457,145,451,145,451,151,459,151,459,151,471,229,475,217,469,217,469,213,345,213,345,225,339,225,339,229,339,229,339,237,345,237,345,239,393,239,393,249,397,249,397,317,397,317,397,323,403,323,403,323,409,323,409,317,415,317,415,243,417,243,417,239,467,239,467,229,475,489,473,309,473,309,473,301,467,301,467,299,455,299,455,307,451,307,451,379,451,379,451,387,445,387,445,387,403,387,403,399,399,399,399,409,403,409,403,413,449,413,449,421,455,421,455,487,455,487,455,493,459,493,459,497,469,497,469,491,473,573,513,483,515,483,515,471,521,471,521,479,547,479,547,573,545,573,545,581,539,581,539,581,517,581,517,573,513,651,513,717,513,717,513,721,521,721,521,721,543,721,543,719,547,719,547,655,547,655,547,649,537,649,537,647,515,717,469,647,473,647,473,643,459,643,459,653,455,653,455,715,455,715,455,723,459,723,459,725,465,725,465,715,471,577,469,557,467,557,467,561,419,561,419,551,413,551,413,477,413,477,413,471,407,471,407,475,399,475,399,481,395,483,395,547,397,547,397,557,391,557,391,557,345,557,345,567,339,567,339,573,339,573,339,581,343,581,343,581,461,581,461,577,469,571,299,557,293,557,293,557,231,557,231,565,223,565,223,575,221,575,221,585,233,585,233,585,287,585,287,573,299,431,355,495,355,495,355,497,281,497,281,299,281,299,281,301,355,301,355,367,357,367,357,367,345,367,345,315,349,315,349,313,289,313,289,485,291,485,291,487,349,487,349,429,347,429,347,429,355,237,299,223,299,223,299,215,293,215,293,213,225,213,225,237,221,235,221,243,231,243,231,243,289,243,289,237,297,297,235,307,239,307,239,499,237,499,237,497,227,497,227,423,225,423,225,409,215,409,215,409,173,409,173,403,167,403,167,393,167,393,167,385,171,385,171,387,219,387,219,381,223,381,223,309,221,309,221,299,223,299,223,297,233,319,183,225,183,225,183,217,179,217,179,217,167,217,167,227,163,227,163,313,167,313,167,325,169,325,169,319,181,153,179,143,183,143,183,81,183,81,183,73,179,73,177,73,167,73,167,79,163,79,163,123,163,123,163,129,155,129,155,129,115,129,115,135,109,135,109,151,107,151,107,155,113,155,113,155,177,83,67,207,69,207,69,217,73,217,73,217,117,217,117,221,125,221,125,233,125,233,125,239,117,239,117,239,75,239,75,247,69,247,69,251,67,251,67,327,63,327,63,327,53,327,53,317,47,317,47,77,49,77,49,69,59,71,59,83,67,579,179,481,181,481,181,471,173,471,173,479,163,479,163,567,165,567,165,581,171,583,173,577,181,651,105,673,113,671,113,671,155,671,155,677,167,677,167,719,163,719,163,723,169,723,169,723,177,723,177,719,181,719,181,649,185,647,185,643,177,643,177,645,111,651,105,645,111,493,121,307,125,307,125,297,113,297,113,307,105,307,105,373,109,373,109,389,103,389,103,385,53,385,53,399,47,399,47,411,53,411,55,415,101,415,99,423,107,423,107,487,107,487,107,499,115,499,115,493,121,597,65,719,65,719,65,727,51,727,51,487,45,487,45,473,51,473,51,469,59,469,59,481,65,481,65,549,67,549,67,557,75,557,75,557,117,557,117,559,123,559,123,575,123,577,121,583,117,583,117,585,71,595,65,585,71] ),
                    new VectorImage( [5,1,5,25,5,25,14,2,14,2,17,2,17,2,26,26,26,26,27,0,27,0,31,2,31,2,31,33,31,33,25,34,25,34,17,10,17,10,7,33,7,33,1,34,1,34,0,3,0,3,4,1,37,2,40,2,40,2,40,16,40,16,44,21,44,21,46,21,46,21,48,25,48,25,43,28,43,28,39,23,39,23,39,28,39,28,37,28,37,28,36,2,63,2,63,32,63,32,78,33,78,33,85,29,85,29,85,20,85,20,80,14,80,14,68,13,68,13,67,3,67,3,62,1,67,19,76,19,76,19,81,21,81,21,81,27,81,27,77,29,77,29,68,28,68,28,67,19,86,6,85,1,85,1,89,1,89,1,89,7,89,7,85,7] ),
                    1000,5000,10000,
                    new GameColors(
                            1,1,1,
                            0,0,0,
                            0.6,1,0.6
                    ),
                    []
            )
/* // template level
            new Level( 400,300,"",1,
                    new VectorImage( [] ),
                    new VectorImage( [] ),
                    1000,1500,10000,
                    new GameColors(
                            1,1,1,
                            0,0,0,
                            0.6,1,0.6
                    ),
                    []
            ),
*/
        ]

        @levels.each() do |level|
            level.setParent( this )
        end
        $UNLOCKED_OFFSET.times() do |i|
            @levels[i].setUnlocked()
        end
        
        @levelLock = 0
    end
    
    def each()
        i = 0
        levels = @levels
        size = levels.size()
        while i < size
            yield levels[i]
            i = i+1
        end
    end
    
    def getByTitle( title )
        i = 0
        levels = @levels
        size = levels.size()
        while i < size
            level = levels[ i ]
            if title == level.getName()
                return level
            end
        end
        
        return null
    end
    
    def get( index )
        return @levels[ index ]
    end
    
    def unlockLevel()
        this.increaseLevelLock( $LEVEL_UNLOCKING )
    end
    
    def unlockFullLevel()
        this.increaseLevelLock( $LEVEL_UNLOCKING*2 )
    end
    
    def increaseLevelLock( num )
        levelCount = (@levelLock / $LEVEL_LOCK_THRESHOLD ).floor()
        @levelLock = (@levelLock + num).min( $MAX_LEVEL_LOCK )
        newLevelCount = ( @levelLock / $LEVEL_LOCK_THRESHOLD ).floor()
        unlockedLevels = newLevelCount - levelCount

        if unlockedLevels > 0
            // this is to skip the ones that come unlocked
            newLevelCount = newLevelCount + $UNLOCKED_OFFSET
            newLevelCount = newLevelCount.max( @levels.length() )
            
            // for loop cos we might have unlocked multiple levels
            // (typically it's either 1 or 2)
            (newLevelCount-unlockedLevels).upTo( newLevelCount ) do |i|
                @levels[i].setUnlocked()
            end
        end
    end

    def getCompletion()
        return ( 100.0 * (@levelLock / $MAX_LEVEL_LOCK) ).round()
    end
end

class Level
    def new( x,y,name,collisionNum,levelImage,icon,targetBronze,targetSilver,targetGold,colors,gravityPoints)
        @collisionMap = new LevelCollMap( collisionNum )
        @name = name
        @levelImage = levelImage.flip(600).resizeFrom(800,600,$WIDTH,$HEIGHT)
        @icon = icon.flip()

        @x = x*$MULT_WIDTH
        @y = $HEIGHT-y*$MULT_HEIGHT

        @gravityPoints = gravityPoints
        @isUnlocked = false
        @colors = colors

        @targetBronze = targetBronze
        @targetSilver = targetSilver
        @targetGold    = targetGold

        @isBronzePassed = false
        @isSilverPassed = false
        @isGoldPassed   = false

        @highscores = []
        $NUM_HIGHSCORES.times() do
            @highscores.push( 0 )
        end
        
        @parent = null
    end
    
    def clear()
        @collisionMap.clear()
    end
    
    def setParent( parent )
        @parent = parent
    end

    def getImage()
        return @collisionMap
    end

    def getColors()
        return @colors
    end

    def isNewHighscore(score)
        index = -1
        isRunning = true
        i = 0
        size = @highscores.size()
        
        while i < size && isRunning
            if @highscores[i] < score
                setAchievement( score )
                index = i
                isRunning = false
            end
            
            i = i+1
        end

        return index
    end

    def setAchievement(score)
        if ( !@isBronzePassed && score > @targetBronze )
            @parent.unlockLevel()
            @isBronzePassed = true
        end
        if ( !@isSilverPassed && score > @targetSilver )
            @parent.unlockLevel()
            @isSilverPassed = true
        end
        if ( !@isGoldPassed && score > @targetGold )
            @parent.unlockFullLevel()
            @isGoldPassed = true
        end
    end

    def setScore(score)
        setAchievement( score )
        
        /* Iterate through each score in turn,
         * from highest to lowest to find one to override.
         */
        i = 0
        size = @highscores.size()
        isRunning = true
        while i < size && isRunning
            if @highscores[i] < score
                // shuffle all the scores along,
                // but do it without making any new objects
                (size-1).downTo( i ) do |j|
                    @highscores[ j ] = @highscores[j-1]
                end
                
                @highscores[i] = score
                isRunning = false
            end
            i = i+1
        end
    end
    
    def isBronzePassed()
        return @isBronzePassed
    end

    def isSilverPassed()
        return @isSilverPassed
    end

    def isGoldPassed()
        return @isGoldPassed
    end

    def getTargetBronze()
        return @targetBronze
    end

    def getTargetSilver()
        return @targetSilver
    end

    def getTargetGold()
        return @targetGold
    end

    def setUnlocked()
        @isUnlocked = true
    end
    
    def isUnlocked()
        return @isUnlocked
    end
    
    def newSnake( world )
        s = new Snake( world )
        s.start( @x,@y )
        return s
    end
    
    def getName()
        return @name
    end

    def isCollision(x,y)
        if ( x < 0 || x >= $WIDTH ||
                y < 0 || y >= $HEIGHT )
            return false
        else
            return @collisionMap.getValue( x,y ) >= $COLLISION_COLOR
        end
    end
    
    def getLevelImage()
        return @levelImage
    end

    def getIcon()
        return @icon
    end

    def getGravityPoints()
        return @gravityPoints
    end

    def getHighscores()
        return @highscores
    end
end

$SCORE_PADDING_X = 8
$SCORE_PADDING_Y = 8
$SCORE_TEXT_HEIGHT = 48
$SCORE_TEXT_MAX_ALPHA = 0.5

class Game
    def new(app, level, sounds)
        @app = app
        app.mouse().onScroll()
        @sounds = sounds
        
        @level = level
        @snake = level.newSnake( this )
        @sounds[:start].play()
        
        @gravityPoints = level.getGravityPoints()
        @foods = []

        setScore( 0 )
    end
    
    def incrementScore( i )
        setScore( @score+i )
    end
    
    def setScore( s )
        @score = s
        @scoreText = $TEXT.newImage( ''+@score,$SCORE_TEXT_HEIGHT )
    end
    
    def getScore()
        return @score
    end
    
    def getLevel()
        return @level
    end
    
    def removeFood( food )
        @foods.delete( food )
    end
    
    def addFood()
        food = new Food( this, @sounds[:food] )
        level = @level
        
        hasPosition = true
        while hasPosition
            x = rand( 0, $WIDTH )
            y = rand( 0, $HEIGHT )
            
            if ( ! level.isCollision(x,y) )
                food.setLocation( x,y )
                hasPosition = false
            end
        end
        
        level.getColors().setFoodColor( food )
        @foods.add( food )
    end
    
    def eachIntersectingFood( snake )
        x = snake.getX()
        y = snake.getY()
        
        @foods.each() do |food|
            if isEllipseOverlap(
                    x,y,1,1,
                    food.getX(),food.getY(),
                    $FOOD_WIDTH,$FOOD_HEIGHT,
                    true
            )
                yield food
            end                    
        end
    end

    def eachGravityPoint()
        @gravityPoints.each() { |g| yield g }
    end
    
    def checkCollision( x,y )
        if @level.isCollision(x,y)
            onGameEnd()
        end
    end
    
    def selfCollision()
        onGameEnd()
    end
    
    def onGameEnd()
        @sounds[:end].play()
        @app.next( new GameEnd(@level, @score) )
        @level.clear()
    end
    
    def update( parent,delta )
        @gravityPoints.each() { |gPoint| gPoint.update( this,delta ) }
        @snake.update( this,delta )
        
        if @foods.isEmpty()
            addFood()
        end
        @foods.each() { |food| food.update( this,delta ) }
    end
    
    def draw(g)
        level = @level
        
        level.getColors().setBackground()
        fill()
        
        level.getColors().setForground()
        level.getLevelImage().draw( g,0,0,false )
        
        @gravityPoints.each() { |gPoint| gPoint.draw( g ) }
        @foods.each() { |food| food.draw( g ) }
        @snake.draw( g )
        
        tempA = getAlpha()
        setMultAlpha( $SCORE_TEXT_MAX_ALPHA )
        scoreText = @scoreText
        scoreText.draw(
                g,
                getScreenWidth()-(scoreText.getWidth()+$SCORE_PADDING_X),
                getScreenHeight()-(scoreText.getHeight()+$SCORE_PADDING_Y),
                false )
        setAlpha( tempA )
    end
end

class GameEnd
    def new(level, score)
        mouse = $GAME.mouse()
        level.setScore( score )
//        $GAME.save()
        
        mouse.show()
        mouse.onScroll()
        
        @laval = level
        @score = score
        
        @img = new VectorImage( [
                0, 123, 16, 123, 16, 123, 43, 68, 43, 68, 73, 123, 73, 123, 87, 123, 87, 123, 50, 55, 50, 55, 50, 2, 50, 2, 37, 1, 37, 1, 37, 51, 1, 122, 37, 51, 135, 110, 120, 102, 120, 102, 111, 81, 111, 81, 109, 62, 109, 62, 113, 37, 113, 37, 127, 19, 128, 19, 147, 15, 147, 15, 168, 34, 168, 34, 173, 61, 173, 61, 170, 86, 170, 86, 159, 103, 159, 103, 148, 111, 148, 111, 136, 110, 130, 125, 118, 121, 118, 121, 104, 104, 104, 104, 95, 74, 95, 74, 96, 43, 96, 43, 107, 17, 107, 17, 130, 1, 130, 1, 159, 3, 159, 3, 177, 20, 177, 20, 187, 47, 187, 47, 186, 76, 186, 76, 180, 99, 180, 99, 169, 117, 169, 117, 152, 125, 152, 125, 129, 125, 216, 124, 203, 123, 203, 123, 203, 33, 203, 33, 211, 12, 211, 12, 231, 0, 231, 0, 257, 3, 257, 3, 272, 17, 272, 17, 279, 40, 279, 40, 279, 124, 279, 124, 266, 124, 266, 124, 265, 40, 265, 40, 260, 25, 260, 25, 247, 16, 247, 16, 231, 17, 231, 17, 219, 30, 219, 30, 216, 48, 216, 48, 215, 123, 335, 125, 384, 125, 384, 125, 397, 116, 397, 116, 410, 96, 410, 96, 415, 70, 415, 70, 413, 42, 413, 42, 407, 20, 407, 20, 395, 6, 395, 6, 378, 1, 378, 1, 336, 2, 336, 2, 336, 123, 349, 109, 380, 109, 380, 109, 390, 104, 390, 104, 397, 91, 397, 91, 402, 72, 402, 72, 401, 46, 401, 46, 392, 25, 392, 25, 380, 15, 380, 15, 349, 16, 349, 16, 350, 108, 447, 123, 435, 123, 435, 123, 436, 1, 436, 1, 447, 1, 447, 1, 447, 123, 471, 123, 540, 124, 540, 124, 539, 109, 539, 109, 484, 109, 484, 109, 486, 72, 486, 72, 535, 71, 535, 71, 536, 57, 536, 57, 485, 56, 485, 56, 484, 15, 484, 15, 542, 16, 542, 16, 542, 2, 542, 2, 470, 2, 470, 2, 470, 123, 559, 123, 606, 124, 606, 124, 621, 117, 621, 117, 632, 102, 632, 102, 638, 80, 638, 80, 638, 54, 638, 54, 634, 34, 634, 34, 624, 11, 624, 11, 605, 3, 605, 3, 559, 1, 559, 1, 559, 122, 572, 109, 604, 109, 604, 109, 615, 102, 615, 102, 622, 84, 622, 84, 626, 59, 626, 59, 621, 36, 621, 35, 608, 19, 608, 19, 573, 15, 573, 15, 572, 109, 672, 123, 658, 124, 658, 124, 658, 81, 658, 81, 659, 47, 659, 47, 662, 29, 662, 29, 669, 29, 669, 29, 671, 60, 671, 60, 672, 91, 672, 91, 673, 123, 671, 17, 658, 17, 658, 17, 658, 1, 658, 1, 673, 1, 673, 1, 673, 17
] ).flip().resizeFrom( 800, 600, $WIDTH, $HEIGHT )
        @ha = new VectorImage( [
                1, 43, 0, 1, 0, 1, 5, 0, 6, 1, 6, 20, 6, 20, 24, 21, 24, 21, 23, 1, 23, 1, 29, 1, 29, 1, 29, 42, 28, 43, 24, 43, 24, 43, 23, 25, 23, 25, 5, 24, 5, 24, 5, 43, 5, 43, 0, 42, 48, 43, 52, 43, 52, 43, 68, 2, 68, 2, 62, 1, 62, 1, 57, 13, 57, 13, 44, 13, 44, 13, 40, 0, 40, 0, 33, 1, 33, 1, 48, 42, 45, 19, 50, 34, 50, 34, 56, 18, 56, 18, 44, 18
] ).flip()
        @haXs = []
        @haYs = []

        numHas = 20
        angle = 0
        angleInc = $TAO / numHas
        maxDist = 230
        dist = rand( 0, maxDist )
        numHas.times() do
            x = $WIDTH/2 + dist*angle.cos()
            y = $HEIGHT/2 + dist*angle.sin()
            
            @haXs.push( x )
            @haYs.push( y )
            
            dist = ((dist + rand( 75, maxDist )) % maxDist)
            if dist < 60
                dist = rand( 75, maxDist )
            end
            angle = angle + angleInc
        end

        backToUniImg = new VectorImage([
                    111, 51, 12, 52, 12, 52, 1, 44, 1, 44, 0, 8, 0, 8, 8, 0, 7, 2, 112, 1, 112, 1, 118, 8, 118, 8, 120, 46, 120, 46, 111, 51, 10, 44, 11, 17, 11, 17, 13, 11, 13, 11, 16, 10, 16, 10, 18, 15, 18, 15, 21, 42, 25, 10, 26, 43, 26, 43, 36, 11, 36, 11, 35, 43, 41, 42, 41, 11, 45, 43, 50, 11, 50, 11, 56, 44, 61, 43, 60, 10, 60, 10, 68, 10, 68, 28, 62, 28, 68, 44, 61, 43, 72, 11, 75, 44, 75, 44, 82, 36, 82, 36, 78, 25, 78, 25, 74, 24, 78, 24, 82, 10, 87, 17, 92, 11, 92, 11, 96, 16, 96, 16, 88, 32, 88, 32, 91, 44, 91, 44, 95, 37, 102, 42, 102, 11, 102, 11, 110, 9, 109, 28, 102, 28, 102, 44, 110, 44
        ]).flip()
        replayImg= new VectorImage([
                2, 44, 9, 51, 9, 51, 85, 52, 85, 52, 92, 44, 92, 44, 93, 5, 93, 5, 87, 1, 87, 1, 10, 0, 10, 0, 0, 6, 0, 7, 2, 43, 9, 41, 9, 10, 11, 43, 18, 43, 18, 43, 19, 32, 19, 32, 12, 24, 13, 25, 20, 10, 25, 10, 26, 43, 34, 43, 25, 43, 33, 29, 27, 29, 33, 10, 26, 10, 38, 9, 40, 43, 40, 43, 47, 39, 47, 39, 46, 29, 46, 29, 42, 24, 52, 42, 52, 11, 52, 11, 58, 10, 62, 11, 68, 43, 68, 43, 74, 9, 70, 21, 64, 21, 74, 44, 79, 28, 79, 28, 84, 44, 79, 27, 79, 10
        ]).flip()
        @buttons = [
            new Button( backToUniImg,
                    40+backToUniImg.getWidth()/2,
                    $HEIGHT-30-backToUniImg.getHeight()/2
            ) do
                $GAME.galaxy()
            end,
            new Button( replayImg,
                    $WIDTH - (40+replayImg.getWidth()/2),
                    $HEIGHT-30-replayImg.getHeight()/2
            ) do
                $GAME.play( level )
            end
        ]
    end
    
    def update( app, delta )
        @buttons.each() do |button|
            button.update( this, delta, false )
        end
    end
    
    def draw(gfx)
        haXs = @haXs
        haYs = @haYs
        ha = @ha
        
        setColor( $BACK_COL, $BACK_COL, $BACK_COL, getAlpha() )
        haXs.length().times() do |i|
            ha.draw( gfx, haXs[i], haYs[i], true )
        end
        
        setColor( 255, 255, 255, getAlpha() )
        @img.draw( gfx, $WIDTH/2, $HEIGHT-335, true )
        @buttons.each() do |button|
            button.draw( gfx )
        end
    end
end

class GameColors
    def new( foreRed,foreGreen,foreBlue,
             backRed,backGreen,backBlue,
             foodRed,foodGreen,foodBlue )

        // original colours supplied as 0 to 1,
        // need to alter to 0 to 255
        @foreRed   = foreRed*255
        @foreGreen = foreGreen*255
        @foreBlue  = foreBlue*255
        @backRed   = backRed*255
        @backGreen = backGreen*255
        @backBlue  = backBlue*255
        @foodRed   = foodRed*255
        @foodGreen = foodGreen*255
        @foodBlue  = foodBlue*255
    end
    
    def setFoodColor(food)
        food.setColor( @foodRed,@foodGreen,@foodBlue )
    end

    def setBackground()
        setColor( @backRed,@backGreen,@backBlue,getAlpha() )
    end

    def setForground()
        setColor( @foreRed,@foreGreen,@foreBlue,getAlpha() )
    end
end

$REMOVAL_TIME = 600

// the number of ticks before the in-time extra points expires
$COLLECT_TICKS = 60.0*60.0 // 60 seconds * 60 fps
$BASE_POINTS = 60
$IN_TIME_POINTS = 75
$GROW_POINTS = 10
$FOOD_IMG = new VectorImage(
        [ 1,11,9,0,11,14,3,3,12,15,9,1,8,15,0,12 ]
)
$FOOD_WIDTH  = $FOOD_IMG.getWidth()
$FOOD_HEIGHT = $FOOD_IMG.getHeight()

class Food
    def new( parent, sound )
        @sound = sound
        @ticks = $COLLECT_TICKS
        @parent = parent
        @removalTimer = null
        
        this.setColor( 0.6,1.0,0.6 )
        
        @x = 0
        @y = 0
    end

    def update( parent,delta )
        if @ticks > 0
            @ticks = @ticks - delta
        end
        
        if @removalTimer != null && @removalTimer.isPastDuration()
            @parent.removeFood( this )
        end
    end
    
    def setColor( r,g,b )
        @r = r
        @g = g
        @b = b
    end
    
    def getScore()
        collectionMult = @ticks / $COLLECT_TICKS
        return ( $BASE_POINTS + $IN_TIME_POINTS*collectionMult ).round()
    end
    
    def collect(snake)
        if @removalTimer == null
            snake.addPoints( $GROW_POINTS )
            @parent.incrementScore( getScore() )
            @sound.play()
            
            this.remove()
        end
    end
    
    def remove()
        if @removalTimer == null
            @removalTimer = new Timer2( $REMOVAL_TIME )
        end
    end
    
    def setLocation( x,y )
        @x = x
        @y = y
    end

    def getX()
        return @x
    end

    def getY()
        return @y
    end
    
    def draw( g )
        randomDraw = 0
        if @removalTimer != null
            randomDraw = g.getRandomDraw()
            g.setRandomDraw( @removalTimer.getPercentDuration() )
        end
        
        getColors() do |red,green,blue,a|
            setColor( @r,@g,@b,a )
            $FOOD_IMG.draw( g,@x,@y,true )
            setColor( red,green,blue,a )
        end
        
        if @removalTimer != null
            g.setRandomDraw( randomDraw )
        end
    end
end

class Timer2
    def new( duration,percentDone )
        if duration <= 0
            error("The duration cannot be less or equal to 0,given: " +
                    duration)
        else if percentDone < 0
            error("The percentDone cannot be less or equal to 0,given: " +
                    percentDone)
        end
        
        @duration = duration
        @startTime = getTime() - (duration*percentDone).round()
        @endTime = @startTime + duration
    end

    def new(duration)
        init( duration )
    end
    
    def new()
        init( 700 )
    end
    
    def init( duration )
                if duration <= 0
            error("The duration cannot be less or equal to 0,given: " +
                   duration)
        end
        
        @duration = duration
        @startTime = getTime()
        @endTime = @startTime + duration
    end
    
    def getInverse()
       return new Timer2( @duration,1.0-getPercentDuration() )
    end
    
    def getStartTime()
        return @startTime
    end
    
    def getEndTime()
        return @endTime
    end
    
    def isPastDuration()
        return getTime() > getEndTime()
    end

    def getDuration()
        return @duration;
    end

    def getPercentDuration()
        percent = (getTime()-@startTime) / @duration
        return percent.limit( 0.0,1.0 )
    end
end

$ARROW_IMAGE = new VectorImage(
        [ 4,8,0,3,0,3,5,0,5,0,8,5,8,5,3,9 ]
)

$ARROW_SPEED = 0.8
$ARROW_ANGLE_SPEED = 0.25.toRadians()
$NUM_ARROWS = 5
$ARROW_MAX_ALPHA = 0.3
$ARROW_RED = 0.9
$ARROW_GREEN = 0.9
$ARROW_BLUE = 1.0

$GRAVITY_MULTIPLYER = 0.6

class GravityPoint
    def new( x,y,gravity,radius )
        setLocation( x*$MULT_WIDTH,y*$MULT_HEIGHT )
        @gravity = gravity*$GRAVITY_MULTIPLYER
        @radius = radius
        
        @arrowAngles = []
        @arrowDists  = []
        
        angleOffset = rand( 0, $TAO )
        angleSegmentSize = $TAO / $NUM_ARROWS
        angleRadiusIncrement = radius / $NUM_ARROWS
        
        $NUM_ARROWS.times() do |i|
            @arrowAngles.push( angleOffset + angleSegmentSize*i )
            @arrowDists.push( angleRadiusIncrement*i )
        end
        
        @arrowIncrement = - gravity*$ARROW_SPEED
    end
    
    def getGravity( x,y,total )
        distX = getX() - x
        distY = getY() - y
        dist = ( distX*distX + distY*distY ).sqrt()
        
        if (-@radius) < dist && dist < @radius
            angle = distY.atan2( distX )
            distPercent = 1.0 - (dist / @radius )
            distGravity = distPercent * @gravity
            
            total.move( distGravity * angle.cos(),
                    distGravity * angle.sin() )
        end
    end

    def update( game,delta )
        $NUM_ARROWS.times() do |i|
            arrowDist = @arrowDists[i] + @arrowIncrement*delta
            if arrowDist < 0
                arrowDist = arrowDist + @radius
            else if arrowDist > @radius
                arrowDist = arrowDist - @radius
            end
            
            @arrowDists[i] = arrowDist
            @arrowAngles[i] = @arrowAngles[i] + $ARROW_ANGLE_SPEED*delta
        end
    end

    def draw( gfx )
        x = getX()
        y = getY()
        
        getColors() do |r,g,b,a|
            arrowRed   = r * $ARROW_RED
            arrowGreen = g * $ARROW_GREEN
            arrowBlue  = b * $ARROW_BLUE
            
            $NUM_ARROWS.times() do |i|
                arrowAngle = @arrowAngles[i]
                arrowDist = @arrowDists[i]
                
                alpha = $ARROW_MAX_ALPHA * ((arrowDist/@radius)*$PI).sin()
                
                arrowX = x + arrowDist*arrowAngle.cos()
                arrowY = y + arrowDist*arrowAngle.sin()
                
                setColor( arrowRed,arrowGreen,arrowBlue,a*alpha )
                
                // TODO draw arrows rotated
                $ARROW_IMAGE.draw( gfx,arrowX,arrowY,true )
            end
            
            setColor( r,g,b,a )
        end
    end

    def setLocation( x,y )
        @x = x
        @y = y
    end
    
    def getX()
        return @x
    end
    
    def getY()
        return @y
    end
end

class Snake
    def new( world )
        initialize( world,true )
    end

    def new( world,collisionsOn )
        initialize( world,$START_ANGLE,collisionsOn )
    end

    def new( world,startAngle,collisionsOn )
        initialize( world,startAngle,collisionsOn )
    end
    
    def initialize( world,collisionsOn )
        initialize( world,$START_ANGLE,collisionsOn )
    end
    
    def initialize( world,startAngle,collisionsOn )
        @world = world
        
        @lineIntersectXYsA = [
                [ 0,0,0,0 ],
                [ 0,0,0,0 ]
        ]
        @lineIntersectXYsB = [
                [ 0,0,0,0 ],
                [ 0,0,0,0 ]
        ]

        @points = []
        @startAngle = startAngle
        @collisionsOn = collisionsOn
        
        @gravityPullTotal = new Point()
        @gravityPullX = 0
        @gravityPullY = 0
        
        @x = 0
        @y = 0
        
        @startAlt = 0
        @startInc = 2.2
        
        @lastDelta = 1
    end
    
    def getX()
        return @x
    end
    
    def getY()
        return @y
    end
    
    def setLocation( x,y )
        @x = x
        @y = y
    end
    
    def start( x,y )
        this.start( x,y,1 )
    end
    
    def start( x,y,delta )
        setLocation( x,y )
        
        @points.push(
                new SnakePoint(
                        this,
                        x,y,// X and Y
                        @startAngle
                )
        )

        // -1 cos we already have the head point
        addPoints( $MINIMUM_POINTS-1 )
    end
    
    /**
    * Adds the given number of points to this Snake at it's
    * current location. A negative number or 0 will do nothing.
    * When you add points to the snake it will becomes longer.
    * @param numPoints The number of points to add to this Snake
    */
    def addPoints(numPoints)
        numPoints.times() { addPoint() }
    end
    
    /**
    * Adds a Single point to this Snake.
    */
    def addPoint()
        @points.add( @points[-1].clone() )
    end

    /**
    * Removes the given number of points from the end of the snake.
    * However it will not remove points to make the snake smaller then
    * t's starting length.
    * @param numPoints The number of points to remove.
    */
    def removePoints(numPoints)
        // we cannot remove less then the minimum number of points
        numPoints = numPoints.min( @points.size()-$MINIMUM_POINTS )
        
        if numPoints > 0
            numPoints.times() { @points.deleteAt( -1 ) }
        end
    end
    
    /**
    * Updates this Snakes movement,it's points and it's
    * collision detection
    */
    def update( parent,delta )
        @startAlt = (@startAlt + 1) % @startInc
        
        updateTurn( delta )
        updateSnakePoints( delta )
    end
    
    /**
    * All the points in this Snake are moved along.
    * The angles of it's points are also altered based
    * on the point infront to create the turning effect.
    *
    * Collision detection is also performed by the head
    * against the points behind it,but it skips certain
    * points first (i.e. the neck of the Snake).
    */
    def updateSnakePoints( delta )
        points = @points
        
        head = points[0]
        head.updateHead( delta )
        collEnd = points[ $SNAKE_COLL_CHECK_POINT.min(points.size()) ]

        headX1 = head.getX().round()
        headX2 = collEnd.getX().round()
        headY1 = head.getY().round()
        headY2 = collEnd.getY().round()

        pointsSize = points.size()
        
        startCollsI = $COLLISION_START_CHECKS_POINT + @startAlt.ceil()
        i = 1 + @startAlt
        inc = @startInc
        while i < pointsSize
            point = points[ i ]
            pointInfront = points[ i-1 ]

            otherX1 = point.getX().round()
            otherY1 = point.getY().round()
            otherX2 = pointInfront.getX().round()
            otherY2 = pointInfront.getY().round()

            // check self collision detection if it's far
            // enough from the head of the Snake
            if @collisionsOn && i > startCollsI
                // test various lines at the front of the snake
                // collisions with the rest of the snake's body
                if (
                        isLine( headX1,headY1,headX2,headY2) &&
                        isLine( otherX1,otherY1,otherX2,otherY2)
                )
                    if ( lineIntersect(
                            headX1,headY1,headX2,headY2,
                            otherX1,otherY1,otherX2,otherY2 )
                    )
                        @world.selfCollision()
                        return // no point in carrying on,I'm dead!
                    end
                end
            end

            point.updateBody( pointInfront, delta )
            
            i = i+inc
        end
        
        // update the head of the snake
        actCollectCollectables()
        
        // This is to stop the snake travelling on forever and eventually
        // wrapping over max.
        if head.getX() > $MAX_WIDTH
            movePoints( -$MAX_WIDTH,0 )
        else if head.getX() < -$MAX_WIDTH
            movePoints( $MAX_WIDTH,0 )
        end
        if head.getY() > $MAX_HEIGHT
            movePoints( -$MAX_HEIGHT,0 )
        else if head.getY() < -$MAX_HEIGHT
            movePoints( $MAX_HEIGHT,0 )
        end
        
        @x = mod( head.getX(),$WIDTH  )
        @y = mod( head.getY(),$HEIGHT )

        calculateGravity()
        if @collisionsOn
            checkSpaceBounds()
        end
    end

    /**
    * Fills the given array with all the different 'border lines' generated from
    * the given line. When a line crosses the edge of the screen it should wrap
    * to the other side. This can be done by representing the line twice (once
    * for each side of the screen). Theses multiple representations are the
    * border lines.
    *
    * @param xys
    * @param index
    * @param mx1
    * @param my1
    * @param mx2
    * @param my2
    * @param x1
    * @param y1
    * @param x2
    * @param y2
    * @return
    */
    def fillWithBorderLines( xys,index,mx1,my1,mx2,my2,x1,y1,x2,y2 )
        if ( (mx1-mx2).abs() > $HALF_WIDTH )
            if ( (my1-my2).abs() > $HALF_HEIGHT )
                if ( x1 < x2 )
                    if ( y1 < y2 )
                        setArrXY(xys,index,mx1,my1,
                                mx2+$WIDTH,my2+$HEIGHT )
                        index = index+1
                        setArrXY(xys,index,mx1-$WIDTH,my1-$HEIGHT,
                                mx2,my2 )
                        index = index+1
                    else
                        setArrXY(xys,index,mx1,my1,
                                mx2+$WIDTH,my2-$HEIGHT )
                        index = index+1
                        setArrXY(xys,index,mx1-$WIDTH,my1+$HEIGHT,
                                mx2,my2 )
                        index = index+1
                    end
                else
                    if ( y1 < y2 )
                        setArrXY(xys,index,mx1,my1,
                                mx2-$WIDTH,my2+$HEIGHT )
                        index = index+1
                        setArrXY(xys,index,mx1+$WIDTH,my1-$HEIGHT,
                                mx2,my2 )
                        index = index+1
                    else
                        setArrXY(xys,index,mx1,my1,
                                mx2-$WIDTH,my2-$HEIGHT )
                        index = index+1
                        setArrXY(xys,index,mx1+$WIDTH,my1+$HEIGHT,
                                mx2,my2 )
                        index = index+1
                    end
                end
            else
                if ( x1 < x2 )
                    setArrXY(xys,index,mx1,my1,mx2+$WIDTH,my2 )
                    index = index+1
                    setArrXY(xys,index,mx1-$WIDTH,my1,mx2,my2 )
                    index = index+1
                else
                    setArrXY(xys,index,mx1,my1,mx2-$WIDTH,my2 )
                    index = index+1
                    setArrXY(xys,index,mx1+$WIDTH,my1,mx2,my2 )
                    index = index+1
                end
            end
        else if ( (my1-my2).abs() > $HALF_HEIGHT )
            if ( y1 < y2 )
                setArrXY(xys,index,mx1,my1,mx2,my2+$HEIGHT )
                index = index+1
                setArrXY(xys,index,mx1,my1-$HEIGHT,mx2,my2 )
                index = index+1
            else
                setArrXY(xys,index,mx1,my1,mx2,my2-$HEIGHT )
                index = index+1
                setArrXY(xys,index,mx1,my1+$HEIGHT,mx2,my2 )
                index = index+1
            end
        else
            setArrXY(xys,index,mx1,my1,mx2,my2 )
            index = index+1
        end

        return index
    end
    
    def lineIntersect(ax1,ay1,ax2,ay2,bx1,by1,bx2,by2 )
        // max1 == modded,line a,x co-ordinate for point 1 (point)
        // mby2 == modded,line b,y co-ordinate for point 2 (point)

        // mod all points
        max1 = mod( ax1,$WIDTH )
        may1 = mod( ay1,$HEIGHT )
        max2 = mod( ax2,$WIDTH )
        may2 = mod( ay2,$HEIGHT )
        
        mbx1 = mod( bx1,$WIDTH )
        mby1 = mod( by1,$HEIGHT )
        mbx2 = mod( bx2,$WIDTH )
        mby2 = mod( by2,$HEIGHT )
        
        indexA = 0
        indexB = 0

        // work out all the possible lines
        indexA = fillWithBorderLines( @lineIntersectXYsA, indexA,
                max1,may1,max2,may2, ax1,ay1,ax2,ay2 )
        indexB = fillWithBorderLines( @lineIntersectXYsB, indexB,
                mbx1,mby1,mbx2,mby2, bx1,by1,bx2,by2 )

        // check all A lines against B lines for a collision
        i = 0
        while i < indexA
            j = 0
            while j < indexB
                axy = @lineIntersectXYsA[i]
                bxy = @lineIntersectXYsB[j]

                if ( isLineOverlap(
                        axy[0],axy[1],axy[2],axy[3],
                        bxy[0],bxy[1],bxy[2],bxy[3] )
                )
                    return true
                end
                
                j = j+1
            end
            
            i = i+1
        end
        
        return false
    end
    
    /**
        * If both ends of the line sit on the same pixel,then it is not a line
        * and this will return false.
        *
        * @return True if there is distance between the two points of the line.
        */
    def isLine( x1,y1,x2,y2)
        return x1 != x2 || y1 != y2
    end

    def checkSpaceBounds()
        @world.checkCollision( getX(),getY() )
    end

    def movePoints( moveX,moveY )
        @points.each() do |p|
            p.move( moveX,moveY )
        end
    end
    
    /**
    * Checks if the given point collides with any Food
    * objects in the World. If it does then the Food is
    * collected and new points are added to this Snake.
    * @param point The point to check if it collides with a Food object.
    */
    def actCollectCollectables()
        @world.eachIntersectingFood( this ) do |actor|
            actor.collect( this )
        end
    end

    def calculateGravity()
        @gravityPullTotal.reset()

        @world.eachGravityPoint() do |gPoint|
            gPoint.getGravity( getX(),getY(),@gravityPullTotal )
        end

        @gravityPullX = @gravityPullTotal.getX()
        @gravityPullY = @gravityPullTotal.getY()
    end
    
    def getGravityPullX()
        return @gravityPullX
    end
    
    def getGravityPullY()
        return @gravityPullY
    end
    
    /**
    * Draws this Snake to the given img.
    * @param img The image to draw this Snake too.
    */
    def draw(g)
        lastPoint = @points[ 0 ]
        points = @points
        
        i = 1
        size = @points.size()
        while i < $MINIMUM_DRAW_POINTS
            point = points[i]
            drawPoint( g, point, lastPoint )
            
            lastPoint = point
            i = i+1
        end
        
        i = i+@startAlt
        inc = @startInc
        while i < size
            point = points[i]
            drawPoint( g, point, lastPoint )
            
            lastPoint = point
            i = i+inc
        end
        
        // always draw the last point!
        endPoint = @points[-1]
        if endPoint != lastPoint
            drawPoint( g, lastPoint, endPoint )
        end
    end
    
    def drawPoint( g, point, lastPoint )
        lpX = lastPoint.getX()
        lpY = lastPoint.getY()
        pX = point.getX()
        pY = point.getY()
        
        x1 = mod( lpX,$WIDTH )
        x2 = mod( pX,$WIDTH )
        y1 = mod( lpY,$HEIGHT )
        y2 = mod( pY,$HEIGHT )
        if ( (x1-x2).abs() > $HALF_WIDTH )
            if ( (y1-y2).abs() > $HALF_HEIGHT )
                if ( lpX < pX )
                    if ( lpY < pY )
                        g.drawShadedLine( x1,y1,
                                x2+$WIDTH,y2+$HEIGHT )
                        g.drawShadedLine( x1-$WIDTH,y2-$HEIGHT,
                                x2,y2 )
                    else
                        g.drawShadedLine( x1,y1,
                                x2+$WIDTH,y2-$HEIGHT )
                        g.drawShadedLine( x1-$WIDTH,y2+$HEIGHT,
                                x2,y2 )
                    end
                else
                    if ( lpY < pY )
                        g.drawShadedLine( x1,y1,x2-$WIDTH,y2+$HEIGHT )
                        g.drawShadedLine( x1+$WIDTH,y2-$HEIGHT,x2,y2 )
                    else
                        g.drawShadedLine( x1,y1,x2-$WIDTH,y2-$HEIGHT )
                        g.drawShadedLine( x1+$WIDTH,y2+$HEIGHT,x2,y2 )
                    end
                end
            else
                if ( lpX < pX )
                    g.drawShadedLine( x1,y1,x2+$WIDTH,y2 )
                    g.drawShadedLine( x1-$WIDTH,y2,x2,y2 )
                else
                    g.drawShadedLine( x1,y1,x2-$WIDTH,y2 )
                    g.drawShadedLine( x1+$WIDTH,y1,x2,y2 )
                end
            end
        else if ( (y1-y2).abs() > $HALF_HEIGHT )
            if ( lpY < pY )
                g.drawShadedLine( x1,y1,x2,y2+$HEIGHT )
                g.drawShadedLine( x1,y1-$HEIGHT,x2,y2 )
            else
                g.drawShadedLine( x1,y1,x2,y2-$HEIGHT )
                g.drawShadedLine( x1,y1+$HEIGHT,x2,y2 )
            end
        else
            g.drawShadedLine( x1,y1,x2,y2 )
        end
    end

    /**
        * @return True if the Snake should turn left.
        */
    def isTurnLeft()
        c = getControls()
        return c.isKeyDown( :left ) ||
                c.isKeyDown( :a ) ||
                c.isLeftDown()
    end
    
    /**
        * @return True if the Snake should turn right.
        */
    def isTurnRight()
        c = getControls()
        return c.isKeyDown( :right ) ||
                c.isKeyDown( :d ) ||
                c.isRightDown()
    end

    def turnLeft( delta )
        turn( - $SNAKE_TURN_SPEED*delta )
    end

    def turnRight( delta )
        turn( $SNAKE_TURN_SPEED*delta )
    end
    
    /**
        * Checks if the Snake is turning left or right and if
        * so updates it's angle.
        */
    def updateTurn( delta )
        if isTurnLeft()
            turnLeft( delta )
        else if isTurnRight()
            turnRight( delta )
        end
    end
    
    /**
        * Turns the head of the Snake by the given amount.
        * @param angle The angle to turn by,in radians.
        */
    def turn( angle )
        @points[0].turn( angle )
    end
end

/**
* This class is for storing the data for a single
* Point in the Snake. This includes it's position,
* the angle it is facing and the amount it is
* moving by.
*/
class SnakePoint
    def new( snake,x,y,angle )
        @snake = snake
        @x = x
        @y = y
        @angle = angle
        @angleCos = angle.cos()
        @angleSin = angle.sin()
    end
    
    /**
     * Creates a new Point which is a copy of the
     * given point. It has the same position,
     * angle and movements.
     */
    def clone()
        return new SnakePoint( @snake,@x,@y,@angle )
    end
    
    def updateHead( delta )
        deltaX = ($SNAKE_SPEED*@angleCos - @snake.getGravityPullX()) *
                      delta
        deltaY = ($SNAKE_SPEED*@angleSin - @snake.getGravityPullY()) *
                      delta
        @x = @x - deltaX
        @y = @y - deltaY
    end
    
    def updateBody( pointInfront, delta )
        // todo
            // move below calculations into a lookup table
            // this is based on x/y diffs (probs 0 .. 2)
            // test for max diff!
        x = @x
        y = @y
        otherX = pointInfront.getX()
        otherY = pointInfront.getY()
        
        angle = ( y-otherY ).atan2( x-otherX )
        
        diffX = x-otherX
        diffY = y-otherY
        hypot = (
                diffX * diffX +
                diffY * diffY
        ).sqrt() * 0.2 * $SNAKE_SPEED

        if angle != @angle
            angleCos = angle.cos()
            angleSin = fastSin(angle)
            
            @angleCos = angleCos
            @angleSin = angleSin
            @angle = angle

            deltaX = hypot * angleCos
            deltaY = hypot * angleSin
        else
            deltaX = hypot * @angleCos
            deltaY = hypot * @angleSin
        end

        newX = x - deltaX * delta
        newY = y - deltaY * delta
        
        if (x < otherX && newX > otherX)
            newX = otherX-$SNAKE_DRIFT
        else if(x > otherX && newX < otherX)
            newX = otherX+$SNAKE_DRIFT
        end
        if (y < otherY && newY > otherY)
            newY = otherY-$SNAKE_DRIFT
        else if (y > otherY && newY < otherY)
            newY = otherY+$SNAKE_DRIFT
        end

        @x = newX
        @y = newY
    end

    def getX()
        return @x
    end
    
    def getY()
        return @y
    end
    
    def turn( turnAngle )
        @angle = @angle + turnAngle
        @angleCos = @angle.cos()
        @angleSin = @angle.sin()
    end

    def move( moveX,moveY )
        @x = @x + moveX
        @y = @y + moveY
    end
end

$BACKGROUND = new VectorImage( [
            204,137,274,281,277,409,204,536,542,325,475,493,207,668,267,799,480,619,563,754,729,568,796,644,357,920,463,992,564,1043,736,1079,657,814,887,868,857,1092,1029,1048,1162,1015,1270,940,1353,858,1409,743,1420,619,1376,471,1321,341,1245,216,1099,172,910,132,776,131,610,193,1002,853,1132,716,1133,584,1044,438,916,393,773,487
] ).flip()

$BUTTON_X_OFFSET = -12
$BUTTON_Y_OFFSET = 12

$MIN_SCROLL_X = 0
$MIN_SCROLL_Y = -800

$MAX_SCROLL_X = 980
$MAX_SCROLL_Y = 0

class Universe
    def new(app,levels)
        @app = app
        @backgrounds  = []
        @backgroundXs = []
        @backgroundYs = []
        @buttons = []

        @scrollX = 0
        @scrollY = 0
        
        mouse = app.mouse()
        mouse.onScroll() do |scrollX,scrollY,angle|
            @scrollX = (@scrollX+scrollX).limit($MIN_SCROLL_X,$MAX_SCROLL_X)
            @scrollY = (@scrollY+scrollY).limit($MIN_SCROLL_Y,$MAX_SCROLL_Y)
        end
        
        // The Comet
        addBackground( 1300,1000,[
                123,222,87,218,87,218,56,185,56,185,34,180,34,180,17,143,38,151,10,140,10,140,3,106,14,117,1,97,1,97,0,85,0,85,18,77,21,95,18,50,18,50,27,36,27,36,43,32,31,34,36,21,36,21,49,15,49,15,74,13,74,13,99,21,71,11,84,7,84,7,102,1,102,1,129,0,129,0,145,3,145,3,151,24,148,17,187,17,187,17,210,45,208,38,221,42,221,41,231,60,80,154,56,151,42,124,43,138,43,138,55,150,31,124,50,150,50,150,84,173,84,173,117,197,117,197,137,208,137,208,158,222,158,222,179,228,179,228,201,250,29,126,29,134,29,134,43,155,43,155,76,176,76,176,115,207,115,207,158,227,159,227,183,239,182,117,222,154,222,154,252,171,252,171,273,196,273,196,310,215,310,215,336,242,220,129,250,159,250,159,302,197,302,197,330,208,330,208,350,235,350,235,376,253,92,32,129,34,129,34,169,57,169,57,206,76,206,76,220,91,220,91,242,101,242,101,285,131,284,131,288,140,288,140,309,152,203,98,217,99,217,99,224,109,224,109,252,123,252,123,273,134,204,122,228,127,228,127,275,150,275,150,326,173,326,173,379,207,401,236,371,208,375,229,345,206,257,155,289,165,173,178,204,201,204,201,241,220,241,220,264,227,264,227,287,249,287,249,341,274,189,179,224,194,225,193,268,217,268,217,295,236,295,236,316,245,192,161,220,169,173,197,192,207,192,207,214,229,214,229,247,259,247,259,275,278,275,278,313,302,301,274,257,252,257,252,238,227,1,138,21,178,21,178,43,227,43,227,73,274,46,200,70,228,70,228,88,263,88,241,105,255,105,255,112,276,112,276,165,312,166,312,192,340,192,340,235,366,235,366,270,399,270,399,334,421,108,232,144,260,144,260,222,288,222,288,302,333,302,333,365,359,208,262,231,274,231,274,252,291,252,291,280,305,280,305,305,322,306,322,358,347,126,235,143,238,143,238,180,257,172,290,215,313,217,312,222,322,222,322,302,372,302,372,323,378,323,378,345,399,194,311,211,324,211,324,301,380,301,380,331,397,123,262,159,287,218,64,239,73,239,73,242,88,242,88,268,101,228,32,271,53,259,43,296,52,296,52,392,115,350,78,368,81,371,83,399,104,394,104,468,136,313,76,389,123,389,123,422,133,422,133,470,150,275,67,309,83,246,52,292,88,305,91,343,113,343,113,359,116,359,116,408,151,408,151,440,168,440,168,460,192,473,185,442,157,442,157,407,140,449,231,392,182,392,182,350,165,350,165,340,150,340,150,309,140,309,140,295,123,375,161,330,123,329,122,296,98,327,131,277,92,277,91,252,78,323,291,372,316,148,55,131,50,131,50,127,38,57,35,59,45,59,45,56,64,56,64,87,83,31,90,52,87,52,87,55,80,169,207,161,192,154,200,140,172,176,127,172,97,172,97,161,77,343,252,394,295,361,386,317,368,317,368,289,350,397,217,436,255,421,168,431,179,431,179,488,213,424,193,443,207,443,207,485,257,329,352,344,364,345,364,404,387,324,312,404,343,298,166,312,186,312,186,338,201,399,152,366,141,366,141,347,119
        ] )

        // Icarus
        addBackground( 1200,430,[
                85,233,99,237,99,237,110,236,110,236,125,224,125,224,140,207,140,207,152,203,152,203,164,192,164,192,181,176,181,176,175,144,175,144,162,149,162,149,154,150,154,150,151,128,151,128,161,124,161,124,167,119,167,119,174,129,174,129,177,142,154,151,153,171,153,171,161,184,161,184,163,192,151,173,139,177,138,177,128,185,128,185,118,190,118,190,110,191,110,191,102,200,102,200,94,204,102,202,101,207,81,202,96,206,140,205,136,192,136,192,129,186,140,177,149,187,149,187,153,200,108,192,102,180,102,180,97,178,97,178,93,162,93,162,87,152,95,135,95,141,95,141,91,152,92,140,81,155,81,155,68,154,68,154,60,149,33,190,40,173,42,172,48,167,48,167,57,150,57,150,62,140,62,140,74,129,74,129,87,122,50,192,47,189,47,189,48,187,48,187,52,190,59,182,78,186,77,185,80,190,80,190,88,196,57,171,61,171,69,172,75,176,61,162,72,164,80,168,84,174,72,228,62,224,53,217,44,212,44,212,38,202,38,202,33,196,33,196,33,189,45,216,40,214,40,214,18,193,18,193,9,180,9,180,7,166,7,166,11,163,28,194,13,179,13,179,12,166,11,164,9,152,9,152,10,140,10,140,23,120,23,120,40,114,40,114,54,111,54,111,67,111,67,111,82,110,82,110,84,104,81,112,73,116,73,116,66,127,66,127,56,135,56,135,49,143,49,143,38,148,40,147,31,155,31,155,31,169,31,169,30,185,32,190,19,168,19,168,14,161,14,161,13,148,21,161,17,157,21,160,20,151,20,151,18,142,18,142,29,129,29,146,37,134,25,171,25,143,25,143,31,132,48,216,46,221,46,221,49,236,49,236,47,249,47,249,42,258,42,258,46,268,46,268,53,269,53,269,59,277,59,277,67,274,67,274,76,279,76,279,86,279,54,270,62,271,47,252,52,258,52,258,66,255,54,231,61,240,61,246,65,246,65,246,75,260,75,260,83,265,83,265,90,260,81,256,88,256,88,256,92,256,88,276,83,268,52,265,55,261,72,279,76,281,76,282,89,285,89,285,96,281,97,281,102,279,102,279,112,273,112,273,118,265,118,265,120,256,111,249,121,252,118,239,122,242,113,246,103,249,112,253,108,260,106,269,102,269,106,241,99,246,183,317,169,332,168,333,164,329,170,322,160,331,160,331,151,330,151,330,150,321,150,321,141,313,148,312,139,310,155,306,143,302,143,302,139,295,141,308,132,297,132,297,133,290,132,289,125,271,130,269,121,271,121,271,119,267,136,264,127,264,127,264,121,264,157,304,162,296,158,294,154,289,154,289,154,285,154,285,149,280,149,280,149,273,149,273,141,267,146,267,151,266,150,266,158,271,154,262,153,252,153,252,145,245,145,245,144,252,144,252,145,264,142,253,138,246,136,257,138,245,137,244,135,233,135,233,130,232,130,232,127,242,136,235,137,218,137,218,140,210,140,210,147,220,146,220,146,237,148,219,154,219,154,219,157,237,157,237,153,249,159,240,166,249,166,249,166,256,162,271,168,255,168,255,179,271,173,276,182,284,172,277,170,279,170,279,170,284,170,290,161,284,161,284,163,278,177,288,179,296,172,297,172,307,167,306,166,311,186,315,190,304,190,304,192,270,192,270,194,251,194,251,200,222,200,222,202,209,202,209,212,197,212,197,218,181,218,181,225,150,225,150,238,122,238,122,247,103,188,253,187,238,187,238,184,226,184,226,177,218,177,218,169,233,169,233,169,244,169,244,171,249,171,249,171,256,184,253,179,264,184,251,191,258,191,258,186,265,184,279,181,267,181,258,175,251,175,219,172,205,172,205,164,200,165,199,156,215,163,225,164,239,167,199,167,191,161,206,160,199,154,216,151,208,151,208,145,214,175,195,183,184,183,184,191,158,192,174,196,165,196,165,194,158,194,158,180,155,199,151,188,152,188,152,183,151,201,135,190,137,183,150,195,121,182,132,192,100,192,100,206,80,206,80,215,70,215,70,221,73,221,73,220,90,220,90,207,120,210,124,203,136,203,136,200,148,200,148,220,143,218,149,183,217,194,197,195,216,204,172,200,170,200,170,192,177,192,177,178,209,220,117,231,90,231,90,239,82,239,82,246,82,225,98,223,90,216,122,207,143,230,133,227,126,175,125,188,91,188,91,190,97,190,97,178,126,165,116,153,101,153,101,140,95,140,95,131,84,131,84,123,80,127,91,118,80,119,93,113,82,138,119,130,112,129,112,116,96,116,96,108,90,125,95,109,87,132,115,119,109,116,113,130,119,130,119,134,123,134,123,148,125,116,116,114,108,114,108,107,107,107,107,98,113,89,132,98,108,98,108,98,99,98,99,87,103,90,102,89,129,94,123,102,122,99,129,101,122,97,128,94,128,94,161,107,146,107,146,105,137,97,142,99,144,99,144,93,153,108,130,113,135,113,135,111,164,111,164,105,176,98,168,103,153,114,186,114,176,114,175,111,170,122,172,115,157,117,157,123,153,123,153,128,154,128,154,131,176,136,157,131,168,147,161,143,173,146,159,141,157,143,153,145,141,145,141,140,137,140,137,133,140,133,140,125,150,140,130,125,130,125,130,116,141,120,127,121,120,45,233,37,239,37,239,35,251,35,251,28,257,28,257,25,263,25,263,17,264,17,264,7,258,7,258,4,241,4,241,0,237,0,237,1,224,5,234,4,206,6,200,6,184,11,201,12,188,18,215,17,194,9,219,13,226,35,229,36,217,36,226,43,220,31,234,27,239,32,244,27,243,17,246,14,244,26,248,21,252,29,222,23,221,20,118,27,96,44,99,24,91,24,91,33,73,36,79,41,90,41,90,62,105,57,110,46,99,28,112,50,108,82,104,64,92,64,92,57,81,83,94,43,74,63,103,41,76,35,65,42,64,99,82,77,63,113,86,81,45,95,88,75,77,74,77,65,70,63,76,45,66,41,73,34,71,165,112,166,98,166,98,178,80,171,123,190,83,190,83,194,65,194,65,191,52,156,99,179,60,148,93,154,81,154,81,159,79,141,90,155,72,155,72,173,59,173,59,189,45,137,83,146,70,146,70,158,62,158,62,178,40,131,77,133,60,133,60,119,28,126,79,124,66,120,74,118,58,118,58,108,41,112,54,96,38,116,76,101,54,74,61,71,46,66,56,63,45,62,57,59,49,48,64,60,36,60,33,78,19,78,44,67,33,32,64,39,60,39,60,34,49,34,49,22,39,22,39,26,34,26,34,38,47,38,47,30,28,31,27,35,27,35,27,44,42,40,29,45,31,45,31,55,45,149,61,151,28,144,51,139,20,139,20,129,0,136,54,129,30,129,30,117,13,127,59,120,43,119,43,103,28,103,28,87,24,89,38,87,28,87,28,79,18,111,26,102,17,102,17,84,15,200,77,219,35,218,67,230,17,230,17,244,3,236,81,246,58,215,32,195,48
        ] )

        // The Beast
        addBackground( 200,850,[
                0,301,11,312,11,312,134,299,134,299,200,281,200,281,251,285,251,285,302,267,29,310,58,328,58,328,110,326,110,326,154,313,154,313,202,301,202,301,246,304,246,304,282,296,118,328,176,326,176,326,181,333,181,333,202,328,198,331,203,336,203,336,221,333,221,334,222,341,222,341,243,334,243,334,250,342,250,342,272,337,262,325,243,329,267,344,285,347,283,345,293,350,293,350,334,347,360,293,358,304,358,304,341,321,341,321,331,344,331,344,331,361,331,361,322,379,322,379,373,358,373,358,393,357,393,357,432,325,432,344,406,353,432,345,437,368,437,368,467,352,467,352,488,357,488,357,539,328,539,328,553,328,553,328,557,313,549,347,521,339,545,347,600,318,600,318,608,307,593,321,609,325,609,325,625,315,625,315,640,296,617,310,605,307,699,289,691,286,691,286,665,297,665,297,641,294,699,288,694,273,694,273,697,257,697,257,691,241,691,240,680,221,680,221,672,208,672,208,665,232,685,240,672,237,672,237,657,240,657,240,646,243,646,243,640,230,640,230,649,206,649,206,654,222,654,222,654,230,638,235,611,233,611,233,603,241,603,241,592,235,592,235,577,233,577,233,565,240,565,240,549,227,549,227,557,216,557,216,569,205,569,205,576,208,576,208,577,222,577,222,577,230,592,232,598,219,598,219,605,219,605,219,609,232,677,272,633,283,633,283,630,288,630,288,616,281,616,281,621,265,613,270,592,264,605,283,600,275,600,275,587,273,619,297,601,293,601,293,582,310,582,310,565,313,565,313,547,309,547,309,536,296,536,296,520,291,520,291,513,286,513,286,496,283,496,283,473,264,473,264,446,257,446,257,441,251,441,251,472,257,472,257,499,275,499,273,534,277,534,277,550,272,550,272,571,267,571,267,582,272,581,288,565,294,565,294,549,288,549,288,553,280,553,280,569,275,569,275,579,283,585,291,574,299,574,299,558,301,558,301,542,291,539,307,533,315,533,315,512,321,512,321,477,321,477,321,440,312,440,312,406,302,406,302,381,293,381,293,355,293,355,293,325,278,325,278,307,261,307,261,314,254,314,254,338,267,338,267,382,267,382,267,419,257,419,257,443,264,496,341,453,334,453,334,421,318,421,318,416,310,353,331,374,310,392,312,416,310,333,328,325,321,325,321,325,312,325,312,344,294,322,342,307,329,307,329,312,302,0,301,64,288,64,288,78,277,78,277,123,264,123,264,125,243,125,243,115,238,115,238,117,203,117,203,126,174,126,174,134,163,125,162,118,142,118,142,125,98,125,98,134,66,134,66,181,56,181,56,187,46,187,46,200,46,200,46,216,35,224,232,240,224,240,224,259,233,259,233,280,240,280,240,299,233,222,225,240,214,240,214,259,221,259,221,278,229,278,229,298,224,261,216,262,198,262,198,274,160,274,160,294,142,294,142,307,117,307,117,307,94,307,94,352,91,352,91,358,96,358,96,385,98,350,112,393,90,393,90,417,86,417,86,451,72,451,72,488,88,488,88,568,90,568,90,617,66,617,66,635,80,635,80,640,88,640,88,630,94,630,94,640,120,640,120,629,115,627,130,611,101,622,130,606,125,606,125,601,112,629,115,621,117,603,125,589,138,581,120,587,149,587,149,565,126,565,126,574,118,557,138,566,134,550,131,557,146,557,146,547,157,547,157,536,147,536,147,536,136,531,147,525,152,525,152,518,171,518,171,523,184,523,184,523,192,523,192,550,219,643,217,638,209,638,209,630,225,630,225,621,221,621,221,616,203,616,203,608,214,608,214,597,201,597,201,585,190,585,190,585,178,585,178,574,170,574,170,579,150,579,150,561,165,561,165,547,165,547,165,533,170,533,170,523,170,510,157,505,171,505,171,513,198,547,246,521,224,521,224,526,217,545,265,523,240,534,269,515,246,515,246,510,235,502,222,497,198,499,198,489,186,489,186,485,152,485,152,501,120,481,219,473,201,473,201,475,189,621,77,609,75,609,75,569,96,569,96,493,109,493,109,469,104,469,104,437,109,438,120,446,128,448,128,446,139,475,134,462,130,475,136,472,150,315,221,350,182,350,182,376,173,376,173,393,142,357,229,357,261,152,232,170,209,170,209,173,195,173,195,190,178,190,178,202,123,202,123,211,106,211,106,240,102,240,102,243,85,243,85,277,75,307,93,269,69,269,69,237,50,237,50,216,32,216,32,203,27,203,27,192,11,192,11,179,10,179,10,179,0,179,0,149,11,149,11,128,8,128,8,118,16,118,16,102,14,101,14,85,32,85,32,78,51,78,51,82,77,83,107,78,136,85,134,82,160,82,186,93,200,94,200,88,232,115,182,98,154,98,154,104,110,334,126,293,149,334,126,366,133,366,133,405,112,408,179,395,198,395,198,382,209,393,171,368,203,184,235,155,249,256,269,216,264,419,286,441,293,456,294,462,297,475,299,483,302,494,302,510,307,517,310,529,309,328,225,365,216,456,245,443,229,443,229,451,205,451,205,438,179,438,179,441,155,441,155,430,138
        ] )

        // Old Man Archer
        addBackground( 650,160,[
                182,128,290,251,191,135,188,129,188,129,186,131,186,131,184,132,184,132,189,136,184,121,349,95,349,95,349,105,349,105,356,109,356,109,358,104,358,103,363,103,363,103,366,117,366,117,374,141,374,141,383,164,383,164,392,190,392,190,393,217,393,217,390,241,390,241,382,284,388,241,386,238,386,238,368,238,360,103,356,96,356,96,348,96,363,105,367,105,367,105,368,108,368,108,366,110,359,109,363,115,363,115,370,152,370,152,362,139,362,139,356,119,356,119,359,114,356,111,352,115,352,115,349,110,352,110,353,112,346,104,344,109,345,110,350,119,350,119,354,119,345,111,202,376,215,380,230,332,230,332,305,191,305,191,354,119,359,111,354,116,353,121,327,190,327,190,305,188,307,192,326,193,325,192,250,334,250,334,229,328,250,336,231,332,248,336,212,382,248,336,215,392,365,110,247,332,352,133,361,153,361,153,372,180,372,180,375,200,375,200,375,222,375,222,372,236,367,236,363,245,348,228,369,252,369,252,366,259,366,259,359,259,380,286,373,275,373,275,385,240,383,241,368,269,369,269,368,275,374,279,365,272,365,272,353,292,369,310,354,294,362,299,368,281,368,281,366,277,366,277,355,294,365,304,370,288,370,288,375,285,375,285,380,285,379,270,381,272,381,272,379,277,377,276,375,273,375,273,378,269,347,227,341,235,341,235,338,247,331,234,341,227,341,227,347,227,349,282,346,287,349,292,320,259,320,259,315,265,298,250,346,304,296,237,318,258,300,242,298,249,290,250,308,268,302,266,333,300,327,310,332,301,332,301,339,305,339,305,345,312,355,294,344,315,344,315,337,324,347,316,343,321,342,321,333,332,333,332,336,338,336,338,323,362,340,343,337,340,340,342,348,351,348,351,348,355,348,355,324,380,324,380,307,395,307,395,284,404,284,404,268,403,268,403,243,397,243,397,217,397,216,398,213,399,213,399,200,395,200,395,196,388,196,388,204,382,204,382,209,385,209,385,208,390,216,392,201,388,215,394,211,394,211,394,211,397,206,397,200,400,200,400,194,394,194,394,194,381,194,381,202,378,202,378,211,380,211,380,212,387,212,387,230,391,217,392,238,393,238,393,255,396,255,396,274,401,266,398,283,393,283,393,297,383,297,383,304,376,304,376,301,373,302,373,319,376,319,376,322,381,322,381,302,377,300,370,320,337,320,337,326,332,326,332,330,315,330,315,328,310,328,310,332,301,339,306,333,314,333,314,334,327,343,327,342,333,342,333,355,324,355,324,360,316,360,316,358,311,358,311,355,312,355,312,351,319,351,319,344,327,342,343,347,338,347,338,360,329,360,329,368,312,338,344,321,374,330,236,339,250,339,250,342,258,342,258,343,266,344,261,350,269,350,269,356,271,356,271,359,277,359,277,353,279,353,279,349,281,349,281,339,277,339,277,326,263,326,263,310,251,308,251,320,247,320,247,327,239,327,239,328,225,328,225,322,220,322,220,316,211,311,204,302,197,299,192,294,190,294,190,294,182,294,182,263,156,263,156,258,147,258,147,249,144,249,144,230,117,225,110,190,54,191,112,188,49,163,74,194,37,194,37,210,4,178,124,175,119,179,116,183,120,183,120,179,124,181,123,193,386,358,257,353,249,353,249,347,251,347,251,349,258,350,259,356,264,349,259,346,261,346,261,346,265,351,249,352,245,352,245,361,253,361,253,358,257,343,279,344,284,340,355,338,354,338,354,339,349,339,349,344,351,344,351,340,356,340,359,342,361,287,246,281,238,278,235,273,227,273,227,265,221,256,217,240,205,240,205,235,200,235,200,224,193,224,193,217,185,217,185,207,173,207,173,201,163,205,171,196,167,196,166,186,156,180,153,167,144,167,144,157,139,157,139,145,131,145,131,131,124,118,93,131,103,131,102,145,105,145,105,157,99,157,99,161,82,161,82,159,72,159,72,148,63,162,92,171,99,171,99,171,105,172,102,177,102,177,102,180,106,176,98,176,100,176,100,182,100,175,100,175,95,175,95,166,91,166,91,166,83,166,83,176,85,176,85,187,100,187,100,181,115,181,115,168,117,168,117,160,114,159,113,147,114,147,114,142,111,142,111,138,112,138,112,134,105,36,55,29,71,29,71,12,85,12,85,0,107,0,107,0,131,0,131,2,144,0,144,14,164,14,164,42,179,42,179,66,189,66,189,88,186,88,186,104,173,104,173,116,163,116,163,120,153,120,153,134,145,134,145,133,139,133,139,129,129,122,135,132,125,132,125,131,112,131,112,134,108,305,267,297,264,297,264,298,260,305,267,302,258,302,258,297,258,220,161,217,126,217,126,215,119,211,113,201,83,201,83,194,66,241,157,226,124,226,124,223,118,219,110,213,97,171,122,163,133,165,134,154,134,153,119,149,125,149,125,141,126,141,115,135,116,282,216,240,175,240,175,245,157,253,149,246,155,248,156,290,205,297,213,301,219,290,223,296,227,297,227,301,225,282,203,279,204,279,204,273,200,273,200,273,195,272,195,266,193,265,193,265,186,265,186,257,184,257,184,255,175,255,175,248,173,248,173,248,166,248,166,255,154,261,160,266,167,266,167,271,171,271,171,274,178,275,178,281,181,281,181,282,187,282,188,290,192,290,192,290,198,259,160,255,173,265,171,265,187,275,179,271,193,288,195,286,207,280,206,283,208,283,208,287,209,280,191,280,198,301,209,306,209,280,217,273,224,280,227,277,223,280,227,276,228,246,186,238,189,233,191,224,193,218,185,226,184,232,181,239,176,146,61,147,52,145,50,132,41,139,87,146,66,138,86,123,91,137,85,106,88,106,89,93,84,93,84,124,72,124,72,144,55,112,65,96,71,96,71,78,64,95,82,80,67,125,58,124,43,133,39,135,29,135,29,127,20,127,20,123,12,124,12,118,0,78,115,66,108,66,108,67,96,67,96,74,87,74,87,87,84,87,84,94,87,94,87,92,92,79,99,84,109,84,109,79,114,78,110,72,106,72,106,72,96,72,96,78,91,79,91,88,91,88,91,91,98,91,96,85,99
        ] )
        
        
        // The Archer - copied off guys devianArt work

        addGalaxy( levels.get(0),132,1200-1066,mouse )
        addGalaxy( levels.get(1),272,1200-852,mouse )
        addGalaxy( levels.get(2),202,1200-598,mouse )

        addGalaxy( levels.get(3),290,1200-338,mouse )
        addGalaxy( levels.get(4),496,1200-148,mouse )

        addGalaxy( levels.get(5),800, 1200-116,mouse )
        addGalaxy( levels.get(6),1096,1200-158,mouse )
        addGalaxy( levels.get(7),1328,1200-278,mouse )

        addGalaxy( levels.get(8),1438,1200-516,mouse )
        addGalaxy( levels.get(9),1354,1200-794,mouse )

        addGalaxy( levels.get(10),1168,1200-1002,mouse )
        addGalaxy( levels.get(11),848,1200-1084,mouse )
        addGalaxy( levels.get(12),572,1200-944,mouse )

        addGalaxy( levels.get(13),480,1200-644,mouse )
        addGalaxy( levels.get(14),592,1200-382,mouse )

        addGalaxy( levels.get(15),944,1200-332,mouse )
        addGalaxy( levels.get(16),1154,1200-554,mouse )
        addGalaxy( levels.get(17),984,1200-812,mouse )

        addGalaxy( levels.get(18),708,1200-700,mouse )
        addGalaxy( levels.get(19),858,1200-548,mouse )

        @selectedLevel = null
        @selectedLevelImg = null
        @selectedLevelName = null
        @infoPane = new Pane( $WIDTH/2-110, $HEIGHT/2+1, 240, 183 ) do |gfx, pane|
            if @selectedLevel != null
                @selectedLevelName.draw( gfx,
                        pane.getX(),
                        pane.getY() - @selectedLevelImg.getHeight()/2 - @selectedLevelName.getHeight()/2 - 8,
                        true )
                @selectedLevelImg.draw( gfx,
                        pane.getX(),
                        pane.getY(),
                        true )
            end
        end
        
        @targetPane = new Pane($WIDTH/2+130,$HEIGHT/2-25,205,130) do |gfx,pane|
            @selectedTargets.length().times() do |i|
                target = @selectedTargets[i]
                target.draw( gfx, pane.getX(), pane.getY()-110+i*38+70 )
            end
        end
        playImg = new VectorImage([
                62, 45, 55, 51, 55, 51, 9, 51, 9, 51, 0, 45, 0, 45, 0, 8, 0, 8, 7, 0, 7, 1, 55, 1, 55, 1, 62, 8, 62, 8, 62, 44, 9, 43, 7, 8, 9, 43, 15, 41, 15, 41, 16, 29, 16, 29, 9, 24, 21, 43, 23, 10, 23, 10, 28, 9, 30, 9, 37, 43, 37, 43, 42, 9, 39, 23, 33, 21, 43, 43, 48, 26, 48, 26, 49, 9, 48, 26, 54, 43
        ]).flip()
        @paneButtons = [
                new Button(
                        playImg,
                        @targetPane.getX() +
                                @targetPane.getWidth()/2 -
                                playImg.getWidth()/2,
                        @targetPane.getY() +
                                @targetPane.getHeight()/2 +
                                playImg.getHeight()/2 +
                                5,
                        false
                ) do
                    if @selectedLevel != null
                        $GAME.play( @selectedLevel )
                        this.hidePanes()
                    end
                end
        ]

        @text = $TEXT.newImage( "Select a galaxy to play", 18 )
        
//        highscores = new HighscorePane()
/*        
        // highscore back button
        highscoresBack = new HighscoreBackButton()
        float buttonX = highscores.getX() + highscores.getWidth()/2 - highscoresBack.getWidth()/2 + BUTTON_X_OFFSET
        float buttonY = highscores.getY() - highscores.getHeight()/2 + highscoresBack.getHeight()/2 + BUTTON_Y_OFFSET
        highscoresBack.setLocation( buttonX,buttonY )
        
        addActor(,0 )
        addActor( infoPane,10 )
        addActor( highscores,10)
        addActor( highscoresBack,11 )
        addActor(CompletionDisplay(),1 )

        setActOrder( infoPane,1 ) // it's updated after the galaxies
        setActOrder( highscores,1)
*/
    end

    def addBackground( x,y,points )
        @backgrounds.add( new VectorImage(points).flip() )
        @backgroundXs.add( x )
        @backgroundYs.add( $HEIGHT-y )
    end

    def addGalaxy( level,x,y,mouse )
        galaxy = new Button(level.getIcon(),x,$HEIGHT-y) do
            @selectedLevel = level
            @selectedLevelImg = level.getLevelImage().resize( 0.3 ).trim()
            @selectedLevelName = $TEXT.newImage( level.getName(), 16 )
            @selectedTargets = [
                    new SelectedTarget( :bronze,
                            level.getTargetBronze(),
                            level.isBronzePassed() ),
                    new SelectedTarget( :silver,
                            level.getTargetSilver(),
                            level.isSilverPassed() ),
                    new SelectedTarget( :gold,
                            level.getTargetGold(),
                            level.isGoldPassed() )
            ]
            
            this.showPanes()
        end
        @buttons.push( galaxy )
    end
    
    def update( parent,delta )
        handled = false
        scrollX = @scrollX
        scrollY = @scrollY
        
        @paneButtons.each() do |button|
            if button.update( this,delta,handled )
                handled = true
            end
        end
        @buttons.each() do |button|
            if button.update( this,delta,handled,-scrollX,-scrollY )
                handled = true
            end
        end
        
        if @infoPane.update( this, delta, handled )
            handled = true
        end
        if @targetPane.update( this, delta, handled )
            handled = true
        end
        
        if !handled && getControls().isLeftClick()
            hidePanes()
        end
    end
    
    def hidePanes()
        @infoPane.setPaint( false )
        @targetPane.setPaint( false )
        @paneButtons.each() { |b| b.setPaint(false) }
    end
    
    def showPanes()
        @infoPane.setPaint( true )
        @targetPane.setPaint( true )
        @paneButtons.each() { |b| b.setPaint(true) }
    end

    def draw( g )
        scrollX = @scrollX
        scrollY = @scrollY
        
        $BACKGROUND.draw( g,-scrollX,-680-scrollY,false )
        alpha = getAlpha()
        setColor( $BACK_COL,$BACK_COL,$BACK_COL,alpha )
        @backgrounds.length().times() do |i|
            @backgrounds[i].draw(
                    g,
                    @backgroundXs[i]-scrollX,
                    @backgroundYs[i]-scrollY,
                    true
            )
        end
        
        setColor( 180, 255, 255,alpha )
        @text.draw( g,
                $WIDTH-@text.getWidth()-4, $HEIGHT-4-@text.getHeight(),
                false )

        setColor( 255,255,255,alpha )
        @buttons.each() { |b| b.draw(g, -scrollX, -scrollY) }
        
        @infoPane.draw( g )
        @targetPane.draw( g )
        @paneButtons.each() { |b| b.draw( g ) }
    end
/*
    def setInfoPane(galaxy )
        setInfoPane( galaxy.getLevel() )
    end

    def setInfoPane(level )
        infoPane.setLevel()
        highscores.clear()
        highscoresBack.clear()
    end

    def setHighscores(level )
        highscores.setLevel()
        highscoresBack.setLevel()
        infoPane.clear()
    end

    def clearInfoPane()
        infoPane.clear()
    end
    
    def handleClickEvent(event)
        super.handleClickEvent(event)
        
        if ( !event.isHandled() )
            infoPane.clear()
            highscores.clear()
            highscoresBack.clear()
        end
    end

    defclass UniverseInner extends SnakeWorld
        deflimit_scroll(val,min,max)
            return Math.max( Math.min(val,max),min )
        end

        def setScrollX(scrollX)
            scrollX = limit_scroll( scrollX,MIN_SCROLL_X,MAX_SCROLL_X )
            super.setScrollX()
        end

        def setScrollY(scrollY)
            scrollY = limit_scroll( scrollY,MIN_SCROLL_Y,MAX_SCROLL_Y )
            super.setScrollY()
        end

        def paint(g)
            super.paint(g)
            g.drawVectorImage( BACKGROUND,0,0,false )
        end
    end
*/
end

$STAR_IMG = new VectorImage( [
        11, 18, 14, 28, 14, 28, 17, 18, 27, 17, 18, 18, 26, 18, 19, 11, 19, 11, 23, 1, 23, 0, 14, 7, 14, 7, 6, 0, 6, 0, 8, 12, 8, 12, 0, 18, 0, 18, 10, 17
] ).flip()
$TICK_IMG = new VectorImage( [
        12, 0, 26, 24, 26, 24, 21, 26, 21, 26, 11, 7, 11, 7, 4, 13, 4, 13, 0, 8, 0, 8, 11, 1
] ).flip()
class SelectedTarget
    def new( type, score, isPassed )
        @type = type
        @score = $TEXT.newImage( ''+score, 18 )
        @isPassed = isPassed
    end
    
    def draw( gfx, x, y )
        getColors() do |r, g, b, a|
            halfWidth = 110
            starX = x - halfWidth + 18 + $STAR_IMG.getWidth()/2
            textX = x + halfWidth - 18 - @score.getWidth()/2
    
            if @type == :gold
                setColor( 255, 0.84*255, 0, a )
            else if @type == :silver
                setColor( 0.75*255, 0.75*255, 0.75*255, a )
            else
                setColor( 0.8*255, 0.5*255, 0.2*255, a )
            end
            $STAR_IMG.draw( gfx, starX, y, true )
            @score.draw( gfx, textX, y, true )
            
            if ( @isPassed )
                setColor( 128, 255, 128, a )
                $TICK_IMG.draw( gfx, starX, y, true )
                gfx.drawRandomLine(
                        textX-@score.getWidth()/2-4, y,
                        textX+@score.getWidth()/2+4, y )
            end
            
            setColor( r, g, b, a )
        end
    end
end

class Galaxy
    def new(level)
        @level = level
        @img = level.getIcon()
    end
end

// ### Graphics ###
class VectorImage
    def new( points,width,height )
        initialize( points )
        @width = width
        @height = height
    end

    def new( points )
        initialize( points )
    end

    def initialize( points )
        @xs = []
        @ys = []

        minX = 0
        maxX = 1
        minY = 0
        maxY = 1

        i = 0
        points.length().times( 2 ) do |pointsI|
            x = points[ pointsI   ]
            y = points[ pointsI+1 ]

            @xs.push( x )
            @ys.push( y )

            maxX = maxX.max( x )
            minX = minX.min( x )
            maxY = maxY.max( y )
            minY = minY.min( y )

            i = i+1
        }

        @width  = maxX - minX
        @height = maxY - minY
    end

    def new (xs,ys)
        initialize( xs,ys,null,null )
    end
    
    def new (xs,ys,width,height)
        initialize( xs,ys,width,height )
    end

    def initialize( xs,ys,width,height )
        if ( xs.length() != ys.length() )
            error( "Both xs and ys must be the same length." )
        end

        @xs = xs.clone()
        @ys = ys.clone()
        
        if ( width != null && height != null )
            @width = width
            @height = height
        else
            minX = 0
            maxX = 1
            minY = 0
            maxY = 1
            
            xs.length().times() do |i|
                x = xs[ i ]
                y = ys[ i ]
    
                maxX = maxX.max( x )
                minX = minX.min( x )
                maxY = maxY.max( y )
                minY = minY.min( y )
            end
            
            @width  = maxX - minX
            @height = maxY - minY
        end
    end
    
    def clone()
        return new VectorImage( @xs,@ys,@width,@height )
    end
    
    def flip()
        return this.flip( @height )
    end
    
    def flip( height )
        @ys.length().times() do |i|
            @ys[i] = height - @ys[i]
        end
        return this
    end
    
    def draw( g,x,y,midhandled,rotation )
        draw( g,x,y,midhandled )
    end

    def draw( g,x,y,midhandled )
        width = @width
        height = @height
        
        // remove the midhandle cos I'm drawing to the top left
        if midhandled
            x = x - width/2
            y = y - height/2
        end
        if ! (
                x+width < 0 || y+height < 0 ||
                x > $WIDTH || y > $HEIGHT
        )
            xs = @xs
            ys = @ys
            size = xs.length()
            i = 0
            while i < size
                r1 = g.getRandomDrawOffset()
                r2 = g.getRandomDrawOffset()
                
                x1 = x + xs[ i ] + r1
                y1 = y + ys[ i ] + r2
                x2 = x + xs[i+1] + r2
                y2 = y + ys[i+1] + r1
                
                g.drawShadedLine( x1,y1,x2,y2 )
                
                i = i+2
            end
        end
    end
    
    def getWidth()
        return @width
    end
    
    def getHeight()
        return @height
    end

    def resize( scale )
        return resize( (getWidth()*scale),(getHeight()*scale) )
    end

    def resizeType(axisLength,type)
        return resizeType( axisLength,type,true )
    end

    def resizeType(axisLength,type,maintainRatio)
        if type == null
            error( "Given type cannot be null." )
        end
        
        newWidth = 0
        newHeight = 0
        
        if type == :width
            newWidth  = axisLength
            
            if maintainRatio
                newHeight = ( ((1.0*newWidth) / getWidth()) *
                        getHeight() ).round()
            else
                newHeight = getHeight()
            end
        else
            newHeight = axisLength
            
            if maintainRatio
                newWidth = ( ((1.0*newHeight) / getHeight()) *
                        getWidth() ).round()
            else
                newWidth = getWidth()
            end
        end
        
        return resize( newWidth,newHeight )
    end

    def resize(width,height)
        return this.resizeFrom( getWidth(),getHeight(),width,height )
    end
    
    def resizeFrom( oldWidth,oldHeight,width,height )
        widthScale  = (1.0*width ) / oldWidth
        heightScale = (1.0*height) / oldHeight

        newXs = []
        newYs = []
        
        @xs.eachIndex() do |i|
            newXs.push( (widthScale  * @xs[i]).round() )
            newYs.push( (heightScale * @ys[i]).round() )
        end
        
        return new VectorImage( newXs,newYs )
    end

    def rotate( angle )
        width    = @width
        height   = @height
        halfW = width/2
        halfH = height/2

        cos = angle.cos()
        sin = angle.sin()
        
        @xs.length().times() do |i|
            x = @xs[i]-halfW
            y = @ys[i]-halfH
            
            x2 = cos*x - sin*y
            y2 = sin*x + cos*y
            
            @xs[i] = halfW + x2
            @ys[i] = halfH + y2
        end
        
        return this
    end

    /**
     * Creates a new VectorImage that contains the points of both this image and
     * the VectorImage given.
     * @param other The VectorImage to concat onto this one.
     * @return The VectorImage created as a result of the concatonation.
     */
    def concat( other )
        newXs = @xs.clone()
        newYs = @ys.clone()
        
        otherXs = other.getXS()
        otherYs = other.getYS()

        otherXs.length().times() do |i|
            newXs.push( otherXs[i] )
            newYs.push( otherYs[i] )
        end
        
        return new VectorImage( newXs,newYs )
    end

    def getXS()
        return @xs
    end
    
    def getYS()
        return @ys
    end

    def toString()
        str = ' '
        @xs.length().times() do |i|
            if ( i > 0 )
                str = str + ','
            end
            
            str = str + @xs[i]
            str = str + ','
            str = str + @ys[i]
        end
        str = str + 'end'

        return str
    end

    def trim()
        // set to large number that's probably bigger then anything stored
        minX = 2147483647
        minY = 2147483647
        size = @xs.length()

        size.times() do |i|
            minX = minX.min( @xs[i] )
            minY = minY.min( @ys[i] )
        end

        newXs = []
        newYs = []

        size.times() do |i|
            newXs.push( @xs[i] - minX )
            newYs.push( @ys[i] - minY )
        end

        return new VectorImage( newXs,newYs )
    end
end
    
$DEFAULT_HEIGHT    = 24
$SPACE_MULT        = 0.7
$LETTER_SPACE_MULT = 0.3
$NEW_LINE_MULT     = -1.5
$SPACE_WIDTH       = 8
$SPACE_HEIGHT      = 1

/**
* This is a special letter for representing a space. It is tied back to
* this map allowing it to be re-used.
*/
$SPACE_LETTER = new VectorImage( [],$SPACE_WIDTH,$SPACE_HEIGHT  )

$TEXT = new VectorText()

class VectorText
    def new()
        map = {}

        map['a'] = new VectorImage( [0,0,54,185,56,186,130,17,30,80,90,95 ] )
        map['b'] = new VectorImage( [6,194,0,0,0,0,130,50,130,50,26,99,26,99,126,151,126,151,14,195 ] )
        map['c'] = new VectorImage( [119,139,45,153,45,153,0,45,0,45,69,3,73,0,146,44 ] )
        map['d'] = new VectorImage( [3,159,0,0,0,0,93,74,93,74,8,161 ] )
        map['e'] = new VectorImage( [101,168,1,146,0,146,7,0,7,0,106,23,99,91,9,70 ] )
        map['f'] = new VectorImage( [75,149,0,143,0,143,2,0,73,81,5,75 ] )
        map['g'] = new VectorImage( [153,146,68,169,68,169,0,84,2,84,75,0,72,0,151,25,152,25,153,74,99,71,190,85 ] )
        map['h'] = new VectorImage( [14,178,0,2,10,95,101,88,93,0,109,174 ] )
        map['i'] = new VectorImage( [56,136,0,126,26,129,33,3,56,6,11,0 ] )
        map['j'] = new VectorImage( [89,115,27,103,60,107,56,4,56,3,7,0,7,0,0,40 ] )
        map['k'] = new VectorImage( [18,152,0,0,14,74,71,122,21,80,67,11 ] )
        map['l'] = new VectorImage( [0,154,18,3,17,0,69,4 ] )
        map['m'] = new VectorImage( [0,0,30,149,31,150,66,61,66,61,117,150,117,147,144,2 ] )
        map['n'] = new VectorImage( [0,0,3,133,4,135,85,2,86,3,96,135 ] )
        map['o'] = new VectorImage( [94,187,0,153,0,153,51,1,52,0,150,41,150,41,98,185 ] )
        map['p'] = new VectorImage( [0,0,18,187,18,187,108,138,108,138,15,95 ] )
        map['q'] = new VectorImage( [97,178,1,108,0,106,79,7,79,7,165,58,165,58,99,173,104,63,141,0 ] )
        map['r'] = new VectorImage( [0,0,29,191,29,191,123,136,123,136,21,98,21,98,97,8 ] )
        map['s'] = new VectorImage( [128,208,1,162,1,162,116,57,116,54,0,0 ] )
        map['t'] = new VectorImage( [59,151,69,0,120,161,0,147 ] )
        map['u'] = new VectorImage( [0,159,12,19,12,18,64,0,64,1,101,152 ] )
        map['v'] = new VectorImage( [0,158,54,0,53,1,98,177 ] )
        map['w'] = new VectorImage( [0,194,42,4,42,3,91,115,91,115,135,0,134,1,175,197 ] )
        map['x'] = new VectorImage( [0,149,99,0,7,6,112,149 ] )
        map['y'] = new VectorImage( [0,165,35,88,37,86,83,167,35,89,30,0 ] )
        map['z'] = new VectorImage( [0,195,135,173,135,173,15,19,15,19,141,0 ] )

        map['0'] = new VectorImage( [121,225,0,181,0,181,79,2,79,2,205,54,205,54,118,223,156,227,42,0 ] )
        map['1'] = new VectorImage( [0,153,53,178,53,178,49,1,5,6,93,0 ] )
        map['2'] = new VectorImage( [164,15,5,0,5,0,132,170,132,170,66,222,66,222,0,168 ] )
        map['3'] = new VectorImage( [0,238,68,264,68,264,148,216,148,216,79,131,79,131,158,85,158,85,88,0,87,1,17,23 ] )
        map['4'] = new VectorImage( [95,0,95,263,95,263,0,131,0,131,174,139 ] )
        map['5'] = new VectorImage( [149,277,0,259,0,259,7,138,7,138,112,169,112,169,174,95,174,95,81,0,81,0,17,62 ] )
        map['6'] = new VectorImage( [126,231,18,212,18,212,0,101,0,101,90,0,90,0,185,78,185,78,105,146,105,146,18,104 ] )
        map['7'] = new VectorImage( [0,259,166,221,167,221,68,0 ] )
        map['8'] = new VectorImage( [63,225,18,199,18,199,126,52,126,52,62,0,63,1,0,66,0,66,136,193,136,194,62,225 ] )
        map['9'] = new VectorImage( [77,0,116,222,116,222,22,202,22,202,0,118,0,118,95,132 ] )

        map['/'] = new VectorImage( [111,234,0,0 ] )
        map['%'] = new VectorImage( [130,234,19,0,26,228,0,205,0,205,28,176,28,176,55,200,55,200,28,228,113,73,91,53,91,53,117,27,117,27,141,49,141,49,114,75 ] )
        
        map[' '] = $SPACE_LETTER

        map.each() do |letter|
            letter.flip()
        end
        
        @map = map
    end

    def get(c)
        return @map[ c.toLowerCase() ]
    end

    def calculateSpacing(size,type,multiplyer )
        if ( type == :width )
            return size
        else
            return ( multiplyer*size ).round()
        end
    end
    
    def newImage( text )
        return newImage( text,$DEFAULT_HEIGHT )
    end
    
    def newImage( text,height )
        letters = []
        spaceWidth = calculateSpacing( height,:height,$SPACE_MULT )
        letterSpace = calculateSpacing( height,:height,$LETTER_SPACE_MULT )

        totalLength = 0
        totalNewLines = 0

        // get all of the images,null represents a new line
        text.toLowerCase().each() do |letter|
            if ( letter == '\n' )
                letters.push( null )
                totalNewLines = totalNewLines+1
            else if ( letter == ' ' )
                letters.push( get(letter) )
            else
                letterImage = get(letter).resizeType( height,:height )
                
                letters.push( letterImage )
                totalLength = totalLength + letterImage.getXS().length()
            end
        end

        // concat all the image into one
        xs = []
        ys = []
        newLineHeight = ( height*$NEW_LINE_MULT ).round()
        
        x = 0
        y = totalNewLines * newLineHeight
        index = 0
        
        letters.each() do |letterImage|
            if ( letterImage == null )
                x = 0
                y = y - newLineHeight
            else
                tempXS = letterImage.getXS()
                tempYS = letterImage.getYS()
                tempSize = tempXS.length()
                
                tempSize.times() do |j|
                    xs[ index ] = tempXS[ j ] + x
                    ys[ index ] = tempYS[ j ] + y
                    index = index + 1
                end

                x = x + letterImage.getWidth() + letterSpace
            end
        end
        
        return new VectorImage( xs,ys )
    end
end


/* Graphics
 */

class Graphics
    def new()
        setRandomDrawInner( $RANDOM_DRAW_MAX )
    end

    def drawRandomLine( x,y,x2,y2 )
        r1 = this.getRandomDrawOffset()
        r2 = this.getRandomDrawOffset()
        
        drawShadedLine(
                 x+r1, y+r2,
                x2+r2,y2+r1
        )
    end
    
    def drawRandomRect( x,y,width,height )
        drawRandomRect( x,y,width,height,false )
    end
    
    def drawLineOffset( x1,y1,x2,y2,offset )
        drawLine( x1+offset,y1+offset,x2+offset,y2+offset )
    end
    
    def drawLineOffset2( x1,y1,x2,y2,offset )
        drawLine2( x1+offset,y1+offset,x2+offset,y2+offset )
    end
    
    def drawShadedLine( x1,y1,x2,y2 )
        alpha = getAlpha()
        drawLine( x1,y1,x2,y2 )
    
        // Lines major shadow
        setAlpha( alpha/2.0 )
        drawLineOffset( x1,y1,x2,y2,1 )
/* // too slow to use!
        // Lines minor shadow (the shadows-shadow)
        setAlpha( alpha/3.0 )
        drawLineOffset( x1,y1,x2,y2,2 )
*/
        setAlpha( alpha )
    end
    
    def drawRandomRect( x,y,width,height,isMidHandled )
        if isMidHandled
            x = x - width/2.0
            y = y - height/2.0
        end
        
        drawRandomLine( x      ,y       ,x+width,y        ) // bottom
        drawRandomLine( x      ,y+height,x+width,y+height ) // top
        drawRandomLine( x      ,y       ,x      ,y+height ) // left
        drawRandomLine( x+width,y       ,x+width,y+height ) // right
    end
    
    def fillRandomRect( x,y,width,height )
        x1 = x + getRandomDrawOffset()
        y1 = y + getRandomDrawOffset()
        x2 = width+getRandomDrawOffset()
        y2 = height+getRandomDrawOffset()

        fillRect( x1,y1,x2,y2 )
        // todo,get fill shape working
//        fillShape( [ x1,x2 ],[ y1,y2 ] )
    end

    def getRandomDrawOffset()
        return rand( -@halfRandomDraw,@halfRandomDraw )
    end

    /**
     * @return The current random draw value,between 0 and 1.
     */
    def getRandomDraw()
        return (@randomDraw-$RANDOM_DRAW_MIN) / $RANDOM_DRAW_DIFF
    end

    def maxRandomDraw()
        setRandomDrawInner($RANDOM_DRAW_MAX)
    end

    def minRandomDraw()
        setRandomDrawInner($RANDOM_DRAW_MIN)
    end

    def increaseRandomDraw( delta,&block)
        setRandomDrawInner(
                @randomDraw + $RANDOM_DRAW_INC*delta
        )
        
        if isRandomMaximum()
            setRandomDrawInner($RANDOM_DRAW_MAX)
            
            if block != null
                yield
            end
        end
    end

    def decreaseRandomDraw( delta,&block)
        setRandomDrawInner(
                @randomDraw - $RANDOM_DRAW_INC*delta
        )
        
        if isRandomMinimum()
            setRandomDrawInner($RANDOM_DRAW_MIN)
            
            if block != null
                yield
            end
        end
    end

    def isRandomMaximum()
        return @randomDraw >= $RANDOM_DRAW_MAX
    end

    def isRandomMinimum()
        return @randomDraw <= $RANDOM_DRAW_MIN
    end
    
    def setRandomDraw( randomDraw )
        setRandomDrawInner(
                ( randomDraw.limit(0.0,1.0)*$RANDOM_DRAW_DIFF ) +
                $RANDOM_DRAW_MIN
        )
    end

    def setRandomDrawInner(randomDraw)
        @randomDraw = randomDraw
        @halfRandomDraw = randomDraw/2
        
        draw = (randomDraw-$RANDOM_DRAW_MIN) / $RANDOM_DRAW_DIFF
        drawAlpha = ( draw * $HALF_PI ).cos()
        
        setAlpha( drawAlpha )
    end
end

/**
 * Sets the alpha value for drawing,but multiplys it by the current
 * alpha.
 *
 * @param alpha The new alpha value for drawing,between 0 and 1.
 */
def setMultAlpha( alpha )
    setAlpha( alpha * getAlpha() )
end

// ### IMAGES ###

// ### Mainloop ###

$SCROLL_SPEED = 6.0
$SCROLL_BORDER = 100.0
$FADE_INCREMENT = 0.05

class Mouse
    def new()
        @cursor = new VectorImage( [
                0,3,0,20,12,8,1,19,10,3,7,8,7,8,10,8,8,1,5,6,5,6,1,2,9,3,8,0
        ] ).flip()
        scroll = new VectorImage( [
                7,10,1,17,4,8,0,17,1,1,4,8,9,8,1,0,12,0,20,8,20,8,12,17,12,17,14,7,14,7,11,1,23,1,31,9,31,9,22,17,22,17,25,9,25,9,21,0
        ] ).flip()
        scrolls = []
        360.times() do |angle|
            scrolls.push( scroll.clone().rotate(angle.toRadians()) )
        end
        @scroll = scrolls
        
        @event = null
        @randomness = 1.0
        @angle = 0
        
        @hidden = true
        
        updateLocation()
    end
    
    def show()
        @hidden = false
    end

    def hide()
        @hidden = true
    end

    def onScroll( &block )
        @event = block
    end

    def update( delta )
        updateLocation()
        
        x = @x
        y = @y
        
        if (
                ( @event != null ) &&
                (
                        x < $SCROLL_BORDER || y > $HEIGHT-$SCROLL_BORDER ||
                        y < $SCROLL_BORDER || x > $WIDTH-$SCROLL_BORDER
                )
        )
            angle = ( y-$HALF_HEIGHT ).atan2( x-$HALF_WIDTH )
            @angle = angle
            edgeDist = edgeDist(x,$WIDTH).max( edgeDist(y,$HEIGHT) )
            scrollSpeed = delta * $SCROLL_SPEED * edgeDist
            
            scrollX = scrollSpeed * angle.cos()
            scrollY = scrollSpeed * angle.sin()

            @event.call( [ scrollX,scrollY,angle ] )
            
            @randomness = ( @randomness - $FADE_INCREMENT*delta ).min( 1.0 )
        else
            @randomness = ( @randomness + $FADE_INCREMENT*delta ).max( 0.0 )
        end
    end
    
    def edgeDist( val,max )
        if val < $SCROLL_BORDER
            return 1.0 - ( val / $SCROLL_BORDER )
        else if (val > max-$SCROLL_BORDER)
            return (val-(max-$SCROLL_BORDER)) / $SCROLL_BORDER
        else
            return 0.0
        end
    end
    
    def updateLocation()
        c = getControls()
        
        @x = c.getMouseX()
        @y = c.getMouseY()
    end
    
    def getX()
        return @x
    end
    
    def getY()
        return @y
    end
    
    def getAngle()
        return @angle
    end
    
    def draw( g )
        if !@hidden
            tempR = g.getRandomDraw()
            
            // If the world is randomnising out,
            // then we should draw with it's randomness
            drawRandomness = @randomness.max( tempR )
    
            setColor( 255,255,255,getAlpha() )
    
            // NORMAL CURSOR
            g.setRandomDraw( 1.0 - drawRandomness )
            @cursor.draw(
                    g,
                    getX(),getY(),
                    false )
    
            // SCROLL CURSOR
            g.setRandomDraw( drawRandomness )
            @scroll[ @angle.toDegrees() % 360 ].draw(
                    g,
                    getX(),getY(),
                    true
            )
            
            g.setRandomDraw( tempR )
        end
    end
end

class App
    def new( game,levels, sounds )
        @state = :in
        @game = game
        @event = null
        @g = new Graphics()
        @mouse = new Mouse()
        @levels = levels
        
        @sounds = sounds
/*
        user = new User()
        if user.isLoggedIn()
            user.loadGame() do |scores|
                loadSave( scores )
            end
        end
*/
    end
    
    def loadSave( scores )
        if (scores != null)
            scores.eachMapping() do |title, highscores|
                level = @levels.getByTitle( title )
                if level != null
                    highscores.each() do |s|
                        level.setScore(s)
                    end
                end
            end
        end
    end

    def save()
        user = new User()
        if user.isLoggedIn()
            save = {}
            @levels.each() do |level|
                save[level.getName()] = level.getHighscores()
            end
            
            user.saveGame( save )
        end
    end
    
    def galaxy()
        next( new Universe(this, @levels) )
    end
    
    def play( level )
        next( new Game(this, level, @sounds) )
    end
    
    def next( game )
        if @event == null
            this.fade(:out) do
                @game = game
            end
        end
    end
    
    def fade( state,&event )
        @state = state
        @event = event
    end
    
    def fade()
        return @state
    end
    
    def mouse()
        return @mouse
    end
    
    def runFadeEvent()
        if @event != null
            @event.call()
            @event = null
        end
    end
    
    def game( game )
        @game = game
    end

    def game()
        return @game
    end

    def update( delta )
        updateState( delta )
        
        @mouse.update( delta )
        if @state != :out
            @game.update( this,delta )
        end
    end

    def updateState( delta )
        if @state == :in
            @g.decreaseRandomDraw( delta ) do
                @state = null
                runFadeEvent()
            end
        else if @state == :out
            @g.increaseRandomDraw( delta ) do
                runFadeEvent()
                @state = :in
            end
        end
    end
    
    def draw()
        @game.draw( @g )
        @mouse.draw( @g )
    end
end

def drawLine2( x1,y1,x2,y2 )
    xDiff = x1-x2
    yDiff = y1-y2
    if (xDiff <= 1) && (xDiff >= -1) && (yDiff <= 1) && (yDiff >= -1)
        drawPixel( x1,y1 )
        drawPixel( x2,y2 )
    else
        drawLine( x1,y1,x2,y2 )
    end
end

// sound effects
sounds = {
        :food  : new Sound('food.mp3'),
        :start : new Sound('start.mp3'),
        :end   : new Sound('end.mp3')
}

// background music
music = new Sound('music.mp3')
music.setRepeating(true)
music.setVolume(0.4)
music.play()

levels = new LevelFactory()
user = new User()
main = new PreGame( user )

$GAME = new App( main, levels, sounds )

showCursor( false )

fps = new FPS()
fpsC = 0
onEachFrame( 30 ) do |delta,millis|
    fill( 0,0,0 )
    fps.update( millis )
    
    now = getTime()
    $GAME.update( delta )
    now2 = getTime()
    $GAME.draw()
    now3 = getTime()
    
    newFpsC = fps.getFPS()
    if ( fpsC != newFPSC )
        fpsc = newfpsc
        console( 'fps: ' + fpsC + ', ' + (now2-now) + ', ' + (now3-now2) )
    end
end

class FPS
    def new()
        @second = 1000
        
        @count = 0
        @fps = 0
        @fpsC = 0
    end

    def update( millis )
        @fpsC = @fpsC + 1
        
        @count = @count + millis
        if @count > @second
            @count = @count % @second
            @fps = @fpsC
            @fpsC = 0
        end
    end
    def getFPS()
        return @fps
    end
    def draw()
        draw( 3,getScreenHeight()-3 )
    end
    def draw( x,y )
        fillText( @fps,x,y )
    end
end
        //]]></script>
        
    	<!-- Load example testing source-code -->
    	<script>//<![CDATA[
            var code = document.getElementById("example_code").innerHTML;
            
            // remove the CDATA surround
            code = code.
                    replace(/^\/\/<!\[CDATA\[( *\n)?/, '').
                    replace(/\/\/\]\]>$/, '');
            
            // remove all that extra whitespace at the beginning of each line
            lines = code.split("\n");
            if ( lines.length > 0 ) {
                var line = lines[0];
                
                // count number of spaces at the beginning of the line
                var i = 0;
                while ( i < line.length && line.charAt(i) === " " ) {
                    i++;
                }
                
                if ( i > 0 ) {
                    var strRegex = ["^"];
                    
                    for ( var j = 0; j < i; j++ ) {
                        strRegex.push( '( ?)' );
                    }
                    
                    var spaceRemoveRegex = new RegExp( strRegex.join('') );
                    
                    for ( var i = 0; i < lines.length; i++ ) {
                        lines[i] = lines[i].replace( spaceRemoveRegex, '' );
                    }
                }
            }

            document.getElementById("sourceCode").value = lines.join("\n");
    	//]]></script>

        <!-- Add line numbers to the text bits -->
        <script>
            var numbers = '';
            for (var i = 1; i < 50; i++) {
                numbers += i + "<br/>";
            }
            var objs = document.getElementsByClassName( 'line-numbers' );
            
            for (i = 0; i < objs.length; i++) {
                var obj = objs[i];

                obj.innerHTML = numbers;
            }
        </script>
        
        <script>
            scriptLoad( function() {
                if ( window.quby ) {
                    window.parseCode();
                }
            } );
        </script>
    </body>
</html>
